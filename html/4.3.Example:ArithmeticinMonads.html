<!DOCTYPE html>
<html>
  <head>
    <script>
      (function(){
  const {protocol:proto, host:hostName, pathname:path, search:srch, hash:hsh} = window.location;
  if (!(path.endsWith("/") || path.endsWith(".html"))) {
    window.location.replace(`${proto}//${hostName}${path}/${srch}${hsh}`);
  }
})()</script>
    <base href="./../../"><meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <title>Example: Arithmetic in Monads</title><link rel="stylesheet" href="book.css">
    <script>
      const __versoSiteRoot = document.baseURI;</script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js" integrity="sha384-zbcZAIxlvJtNE3Dp5nxLXdXtXyxwOdnILY1TDPVmKFhl4r4nSUG1r8bcFXGVa4Te" crossorigin="anonymous"></script>
    <script src="-verso-data/katex/katex.js"></script>
    <script src="-verso-data/katex/math.js"></script>
    <script src="-verso-data/popper.js"></script>
    <script src="-verso-data/tippy.js"></script>
    <link rel="stylesheet" href="static/theme.css">
    <link rel="stylesheet" href="static/fonts/source-serif/source-serif-text.css">
    <link rel="stylesheet" href="static/fonts/source-code-pro/source-code-pro.css">
    <link rel="stylesheet" href="static/fonts/source-sans/source-sans-3.css">
    <link rel="stylesheet" href="static/fonts/noto-sans-mono/noto-sans-mono.css">
    <link rel="stylesheet" href="-verso-data/katex/katex.css">
    <link rel="stylesheet" href="-verso-data/tippy-border.css">
    <style>
div.paragraph > .eval-steps:not(:first-child), div.paragraph > .eval-steps:not(:first-child) > * {
  margin-top: 0.5rem;
}

div.paragraph > .eval-steps:not(:last-child), div.paragraph > .eval-steps:not(:last-child) > * {
  margin-bottom: 0.5rem;
}

.eval-steps .hl.lean.block {
  margin-top: 0.25em;
  margin-bottom: 0.25em;
}
</style><style>
.shell-command {

}
.shell-command.inline > * {
  display: inline;
  white-space: pre;
}
.shell-command.inline .command::before {
  content: "$ ";
  font-weight: 600;
}
</style><style>
.shell-command {

}
.shell-command.block > * {
  display: block;
  white-space: pre;
}
.shell-command .command .prompt {
  font-weight: 600;
}

div.paragraph > .shell-command:not(:first-child) {
  margin-top: 0.5rem;
}

div.paragraph > .shell-command:not(:last-child) {
  margin-bottom: 0.5rem;
}
</style><style>

.hl.lean {
  white-space: pre;
  font-weight: normal;
  font-style: normal;
}

.hl.lean .keyword {
  font-weight : bold;
}

.hl.lean .var {
  font-style: italic;
  position: relative;
}

.hover-container {
  width: 0;
  height: 0;
  position: relative;
  display: inline;
}

.hl.lean a {
  color: inherit;
  text-decoration: currentcolor underline dotted;
}

.hl.lean a:hover {
  text-decoration: currentcolor underline solid;
}

.hl.lean .hover-info {
  white-space: normal;
}

.hl.lean .token .hover-info {
  display: none;
  position: absolute;
  background-color: #e5e5e5;
  border: 1px solid black;
  padding: 0.5rem;
  z-index: 300;
  font-size: inherit;
}

.hl.lean .hover-info.messages {
  max-height: 10rem;
  overflow-y: auto;
  overflow-x: hidden;
  scrollbar-gutter: stable;
  padding: 0 0.5rem 0 0;
  display: block;
}

.hl.lean .hover-info code {
  white-space: pre-wrap;
}

.hl.lean .hover-info.messages > code {
  padding: 0.5rem;
  display: block;
  width: fit-content;
}

.hl.lean .hover-info.messages > code:only-child {
  margin: 0;
}

.hl.lean .hover-info.messages > code {
  margin: 0.1rem;
}

.hl.lean .hover-info.messages > code:not(:first-child) {
  margin-top: 0rem;
}

/*
@media (hover: hover) {
  .hl.lean .has-info:hover > .hover-container > .hover-info:not(.tactic *),
  .hl.lean .tactic:has(> .tactic-toggle:checked) .has-info:hover > .hover-container > .hover-info,
  .hl.lean .token:hover > .hover-container > .hover-info:not(.has-info *):not(.tactic *),
  .hl.lean .tactic:has(> .tactic-toggle:checked) .token:hover > .hover-container > .hover-info:not(.has-info *) {
    display: inline-block;
    position: absolute;
    top: 1rem;
    font-weight: normal;
    font-style: normal;
    width: min-content;
  }
}
*/

.hl.lean.block {
  display: block;
}

.hl.lean.inline {
  display: inline;
  white-space: pre-wrap;
}

.hl.lean .token {
  transition: all 0.25s; /* Slight fade for highlights */
}

@media (hover: hover) {
  .hl.lean .token.binding-hl, .hl.lean .literal.string:hover, .hl.lean .token.typed:hover {
    background-color: #eee;
    border-radius: 2px;
    transition: none;
  }
}


.hl.lean .has-info .token:not(.tactic-state):not(.tactic-state *), .hl.lean .has-info .inter-text:not(.tactic-state):not(.tactic-state *) {
  text-decoration-style: wavy;
  text-decoration-line: underline;
  text-decoration-thickness: from-font;
}

.hl.lean .has-info .hover-info {
  display: none;
  position: absolute;
  transform: translate(0.25rem, 0.3rem);
  border: 1px solid black;
  padding: 0.5rem;
  z-index: 400;
  text-align: left;
}

.hl.lean .has-info.error :not(.tactic-state):not(.tactic-state *){
  text-decoration-color: red;
}

@media (hover: hover) {
  .hl.lean .has-info.error:hover {
    background-color: #ffb3b3;
  }
}

.hl.lean .hover-info.messages > code.error {
  background-color: #e5e5e5;
  border-left: 0.2rem solid #ffb3b3;
}

.tippy-box[data-theme~='error'] .hl.lean .hover-info.messages > code.error {
  background: none;
  border: none;
}

.error pre {
    color: red;
}

.hl.lean .has-info.warning :not(.tactic-state):not(.tactic-state *) {
  text-decoration-color: var(--verso-warning-color);
}

@media (hover: hover) {
  .hl.lean .has-info.warning:hover {
    background-color:var(--verso-warning-color);
  }
}

.hl.lean .hover-info.messages > code.warning {
  background-color: var(--verso-warning-color);
}

.hl.lean .hover-info.messages > code.error {
  background-color: #e5e5e5;
  border-left: 0.2rem solid var(--verso-warning-color);
}

.tippy-box[data-theme~='warning'] .hl.lean .hover-info.messages > code.warning {
  background: none;
  border: none;
}


.hl.lean .has-info.info :not(.tactic-state):not(.tactic-state *) {
  text-decoration-color: blue;
}

@media (hover: hover) {
  .hl.lean .has-info.info:hover {
    background-color: #4777ff;
  }
}


.hl.lean .hover-info.messages > code.info {
  background-color: #e5e5e5;
  border-left: 0.2rem solid #4777ff;
}

.tippy-box[data-theme~='info'] .hl.lean .hover-info.messages > code.info {
  background: none;
  border: none;
}

.hl.lean div.docstring {
  font-family: sans-serif;
  white-space: normal;
  max-width: 40rem;
  width: max-content;
}

.hl.lean div.docstring > :last-child {
  margin-bottom: 0;
}

.hl.lean div.docstring > :first-child {
  margin-top: 0;
}

.hl.lean .hover-info .sep {
  display: block;
  width: auto;
  margin-left: 1rem;
  margin-right: 1rem;
  margin-top: 0.5rem;
  margin-bottom: 0.5rem;
  padding: 0;
  height: 1px;
  border-top: 1px solid #ccc;
}

.hl.lean code {
  font-family: monospace;
}

.hl.lean .tactic-state {
  display: none;
  position: relative;
  left: 2rem;
  width: fit-content;
  border: 1px solid #888888;
  border-radius: 0.1rem;
  padding: 0.5rem;
  font-family: sans-serif;
  background-color: #ffffff;
  z-index: 200;
}

.hl.lean.popup .tactic-state {
  position: static;
  display: block;
  width: auto;
  border: none;
  padding: 0.5rem;
  font-family: sans-serif;
  background-color: #ffffff;
}


.hl.lean .tactic {
  position: relative;
}

.hl.lean .tactic-toggle:checked ~ .tactic-state {
  display: block;
}

/*
@media (hover: hover) {
  .hl.lean .tactic:hover > .tactic-toggle:not(:checked) ~ .tactic-state {
    display: block;
    position: absolute;
    left: 0;
    transform: translate(0.25rem, 0);
    z-index: 250;
  }
}
*/

.hl.lean .tactic > label {
  position: relative;
  transition: all 0.5s;
}

@media (hover: hover) {
  .hl.lean .tactic > label:hover {
    border-bottom: 1px dotted #bbbbbb;
  }
}

.hl.lean .tactic-toggle {
  position: absolute;
  top: 0;
  left: 0;
  opacity: 0;
  height: 0;
  width: 0;
  z-index: -10;
}

.hl.lean .tactic > label::after {
  content: "";
  border: 1px solid #bbbbbb;
  border-radius: 1rem;
  height: 0.25rem;
  vertical-align: middle;
  width: 0.6rem;
  margin-left: 0.1rem;
  margin-right: 0.1rem;
  display: inline-block;
  transition: all 0.5s;
}

/*
@media (hover: hover) {
  .hl.lean .tactic > label:hover::after {
    border: 1px solid #aaaaaa;
    background-color: #aaaaaa;
    transition: all 0.5s;
  }
}
*/

.hl.lean .tactic > label:has(+ .tactic-toggle:checked)::after {
  border: 1px solid #999999;
  background-color: #999999;
  transition: all 0.5s;
}

.hl.lean .tactic-state .goal + .goal {
  margin-top: 1.5rem;
}

.hl.lean .tactic-state summary {
  margin-left: -0.5rem;
}

.hl.lean .tactic-state details {
  padding-left: 0.5rem;
}

.hl.lean .case-label {
  display: block;
  position: relative;
}

.hl.lean .case-label input[type="checkbox"] {
  position: absolute;
  top: 0;
  left: 0;
  opacity: 0;
  height: 0;
  width: 0;
  z-index: -10;
}

.hl.lean .case-label:has(input[type="checkbox"])::before {
  width: 1rem;
  height: 1rem;
  display: inline-block;
  background-color: black;
  content: ' ';
  transition: ease 0.2s;
  margin-right: 0.7rem;
  clip-path: polygon(100% 0, 0 0, 50% 100%);
  width: 0.6rem;
  height: 0.6rem;
}

.hl.lean .case-label:has(input[type="checkbox"]:not(:checked))::before {
  transform: rotate(-90deg);
}

.hl.lean .case-label:has(input[type="checkbox"]) {

}

.hl.lean .case-label:has(input[type="checkbox"]:checked) {

}


.hl.lean .tactic-state .labeled-case > :not(:first-child) {
  max-height: 0px;
  display: block;
  overflow: hidden;
  transition: max-height 0.1s ease-in;
  margin-left: 0.5rem;
  margin-top: 0.1rem;
}

.hl.lean .labeled-case:has(.case-label input[type="checkbox"]:checked) > :not(:first-child) {
  max-height: 100%;
}


.hl.lean .tactic-state .goal-name::before {
  font-style: normal;
  content: "case ";
}

.hl.lean .tactic-state .goal-name {
  font-style: italic;
  font-family: monospace;
}

.hl.lean .tactic-state .hypotheses {
  display: table;
}

.hl.lean .tactic-state .hypothesis {
  display: table-row;
}

.hl.lean .tactic-state .hypothesis > * {
  display: table-cell;
}


.hl.lean .tactic-state .hypotheses .colon {
  text-align: center;
  min-width: 1rem;
}

.hl.lean .tactic-state .hypotheses .name {
  text-align: right;
}

.hl.lean .tactic-state .hypotheses .name,
.hl.lean .tactic-state .hypotheses .type,
.hl.lean .tactic-state .conclusion .type {
  font-family: monospace;
}

.tippy-box[data-theme~='lean'] {
  background-color: #e5e5e5;
  color: black;
  border: 1px solid black;
}
.tippy-box[data-theme~='lean'][data-placement^='top'] > .tippy-arrow::before {
  border-top-color: #e5e5e5;
}
.tippy-box[data-theme~='lean'][data-placement^='bottom'] > .tippy-arrow::before {
  border-bottom-color: #e5e5e5;
}
.tippy-box[data-theme~='lean'][data-placement^='left'] > .tippy-arrow::before {
  border-left-color: #e5e5e5;
}
.tippy-box[data-theme~='lean'][data-placement^='right'] > .tippy-arrow::before {
  border-right-color: #e5e5e5;
}

.tippy-box[data-theme~='message'][data-placement^='top'] > .tippy-arrow::before {
  border-top-color: #e5e5e5;
  border-width: 11px 11px 0;
}
.tippy-box[data-theme~='message'][data-placement^='top'] > .tippy-arrow::after {
  bottom: -11px;
  border-width: 11px 11px 0;
}
.tippy-box[data-theme~='message'][data-placement^='bottom'] > .tippy-arrow::before {
  border-width: 0 11px 11px;
}
.tippy-box[data-theme~='message'][data-placement^='bottom'] > .tippy-arrow::after {
  top: -11px;
  border-width: 0 11px 11px;
}
.tippy-box[data-theme~='message'][data-placement^='left'] > .tippy-arrow::before {
  border-left-color: #e5e5e5;
  border-width: 11px 0 11px 11px;
}
.tippy-box[data-theme~='message'][data-placement^='left'] > .tippy-arrow::after {
  right: -11px;
  border-width: 11px 0 11px 11px;
}

.tippy-box[data-theme~='message'][data-placement^='right'] > .tippy-arrow::before {
  border-right-color: #e5e5e5;
  border-width: 11px 11px 11px 0;
}
.tippy-box[data-theme~='message'][data-placement^='right'] > .tippy-arrow::after {
  left: -11px;
  border-width: 11px 11px 11px 0;
}



.tippy-box[data-theme~='warning'] {
  background-color: #e5e5e5;
  color: black;
  border: 3px solid var(--verso-warning-color);
}

.tippy-box[data-theme~='error'] {
  background-color: #e5e5e5;
  color: black;
  border: 3px solid #f7a7af;
}

.tippy-box[data-theme~='info'] {
  background-color: #e5e5e5;
  color: black;
  border: 3px solid #99b3c2;
}

.tippy-box[data-theme~='tactic'] {
  background-color: white;
  color: black;
  border: 1px solid black;
}
.tippy-box[data-theme~='tactic'][data-placement^='top'] > .tippy-arrow::before {
  border-top-color: white;
}
.tippy-box[data-theme~='tactic'][data-placement^='bottom'] > .tippy-arrow::before {
  border-bottom-color: white;
}
.tippy-box[data-theme~='tactic'][data-placement^='left'] > .tippy-arrow::before {
  border-left-color: white;
}
.tippy-box[data-theme~='tactic'][data-placement^='right'] > .tippy-arrow::before {
  border-right-color: white;
}

</style><style>
.example-file {
  white-space: normal;
  font-family: var(--verso-structure-font-family);
  margin: 1rem;
  width: fit-content;
  border: 1px solid #ddd;
  padding: 0.5rem;

  /* These are necessary for the container to behave nicely on mobile */
  overflow-x: auto;
  max-width: 100%;
  box-sizing: border-box;
}
.example-file::before {
  counter-reset: linenumber;
}
.example-file > .line {
  display: block;
  white-space: pre;
  counter-increment: linenumber;
  font-family: var(--verso-code-font-family);
}
.example-file > .line::before {
  -webkit-user-select: none;
  display: inline-block;
  content: counter(linenumber);
  border-right: 1px solid #ddd;
  width: 2em;
  padding-right: 0.25em;
  margin-right: 0.25em;
  font-family: var(--verso-code-font-family);
  text-align: right;
}
.example-file > .line::after {
  -webkit-user-select: none;
  display: inline-block;
  content: "⏎";
  opacity: 0;
}
.example-file > .line:hover::after {
  opacity: 1;
}
.example-file > .line:hover, .example-file > .line:hover::before {
  background-color: #eee;
}
.example-file > .empty {
  display: block;
  white-space: pre;
  font-family: var(--verso-code-font-family);
  font-style: italic;
}
.example-file > .empty::before {
  -webkit-user-select: none;
  display: inline-block;
  content: "";
  border-right: 1px solid #ddd;
  width: 2em;
  padding-right: 0.25em;
  margin-right: 0.25em;
  font-family: var(--verso-code-font-family);
  text-align: right;
}
</style><style>
table.tabular {
  margin: auto;
  border-spacing: 1rem;
}
table.tabular.left-align {
  margin-right: auto;
  margin-left: 0;
}
table.tabular.center-align {
  margin: auto;
}
table.tabular.right-align {
  margin-left auto;
  margin-right: 0;
}
table.tabular td, table.tabular th {
  text-align: left;
  vertical-align: top;
}
table.tabular td > p:first-child, table.tabular th > p:first-child {
  margin-top: 0;
}
table.tabular td > p:last-child, table.tabular th > p:first-child {
  margin-bottom: 0;
}
</style><style>
.shell-commands {

}
.shell-commands > * {
  display: block;
  white-space: pre;
}
.shell-commands .command::before {
  content: "$ ";
  font-weight: 600;
}

div.paragraph > .shell-commands:not(:first-child) {
  margin-top: 0.5rem;
}

div.paragraph > .shell-commands:not(:last-child) {
  margin-bottom: 0.5rem;
}
</style><style>
.eq-steps .hl.lean.block {
  background-color: #f6f7f6;
  padding: 1rem;
  margin-top: 0.25rem;
  margin-bottom: 0.25rem;
}
.eq-steps .reason {
  font-style: italic;
  margin-left: 2.5em;
  display: flex;
}
.eq-steps .reason::before {
  content: "={";
  font-family: var(--verso-code-font-family);
  font-style: normal;
  font-weight: 600;
  margin-right: 0.5em;
  align-self: center;
}
.eq-steps .reason > p {
  margin: 0;
  max-width: 25em;
  align-self: center;
}
.eq-steps .reason::after {
  content: "}=";
  font-family: var(--verso-code-font-family);
  font-style: normal;
  font-weight: 600;
  margin-left: 1em;
  align-self: center;
}
</style><style>
div.paragraph > .eq-steps:not(:first-child) {
  margin-top: 0.5rem;
}

div.paragraph > .eq-steps:not(:last-child) {
  margin-bottom: 0.5rem;
}
</style><script>
      
window.onload = () => {

    // Don't show hovers inside of closed tactic states
    function blockedByTactic(elem) {
      let parent = elem.parentNode;
      while (parent && "classList" in parent) {
        if (parent.classList.contains("tactic")) {
          const toggle = parent.querySelector("input.tactic-toggle");
          if (toggle) {
            return !toggle.checked;
          }
        }
        parent = parent.parentNode;
      }
      return false;
    }

    function blockedByTippy(elem) {
      // Don't show a new hover until the old ones are all closed.
      // Scoped to the nearest "top-level block" to avoid being O(n) in the size of the document.
      var block = elem;
      const topLevel = new Set(["section", "body", "html", "nav", "header"]);
      while (block.parentNode && !topLevel.has(block.parentNode.nodeName.toLowerCase())) {
        block = block.parentNode;
      }
      for (const child of block.querySelectorAll(".token, .has-info")) {
        if (child._tippy && child._tippy.state.isVisible) { return true };
      }
      return false;
    }

    for (const c of document.querySelectorAll(".hl.lean .token")) {
        if (c.dataset.binding != "") {
            c.addEventListener("mouseover", (event) => {
                if (blockedByTactic(c)) {return;}
                const context = c.closest(".hl.lean").dataset.leanContext;
                for (const example of document.querySelectorAll(".hl.lean")) {
                    if (example.dataset.leanContext == context) {
                        for (const tok of example.querySelectorAll(".token")) {
                            if (c.dataset.binding == tok.dataset.binding) {
                                tok.classList.add("binding-hl");
                            }
                        }
                    }
                }
            });
        }
        c.addEventListener("mouseout", (event) => {
            for (const tok of document.querySelectorAll(".hl.lean .token")) {
                tok.classList.remove("binding-hl");
            }
        });
    }
    /* Render docstrings */
    if ('undefined' !== typeof marked) {
        for (const d of document.querySelectorAll("code.docstring, pre.docstring")) {
            const str = d.innerText;
            const html = marked.parse(str);
            const rendered = document.createElement("div");
            rendered.classList.add("docstring");
            rendered.innerHTML = html;
            d.parentNode.replaceChild(rendered, d);
        }
    }
    // Add hovers
    let siteRoot = typeof __versoSiteRoot !== 'undefined' ? __versoSiteRoot : "/";
    let docsJson = siteRoot + "-verso-docs.json";
    fetch(docsJson).then((resp) => resp.json()).then((versoDocData) => {

      function hideParentTooltips(element) {
        let parent = element.parentElement;
        while (parent) {
          const tippyInstance = parent._tippy;
          if (tippyInstance) {
            tippyInstance.hide();
          }
          parent = parent.parentElement;
        }
      }



      const defaultTippyProps = {
        /* DEBUG -- remove the space: * /
        onHide(any) { return false; },
        trigger: "click",
        // */
        /* theme: "lean", */
        maxWidth: "none",
        appendTo: () => document.body,
        interactive: true,
        delay: [100, null],
        /* ignoreAttributes: true, */
        followCursor: 'initial',
        onShow(inst) {
          if (inst.reference.className == 'tactic') {

            const toggle = inst.reference.querySelector("input.tactic-toggle");
            if (toggle && toggle.checked) {
              return false;
            }
            hideParentTooltips(inst.reference);
            //if (blockedByTippy(inst.reference)) { return false; }

          } else if (inst.reference.querySelector(".hover-info") || "versoHover" in inst.reference.dataset) {
            if (blockedByTactic(inst.reference)) { return false };
            if (blockedByTippy(inst.reference)) { return false; }
          } else { // Nothing to show here!
            return false;
          }
        },
        content (tgt) {
          const content = document.createElement("span");
          if (tgt.className == 'tactic') {
            const state = tgt.querySelector(".tactic-state").cloneNode(true);
            state.style.display = "block";
            content.appendChild(state);
            content.style.display = "block";
            content.className = "hl lean popup";
          } else {
            content.className = "hl lean";
            content.style.display = "block";
            content.style.maxHeight = "300px";
            content.style.overflowY = "auto";
            content.style.overflowX = "hidden";
            const hoverId = tgt.dataset.versoHover;
            const hoverInfo = tgt.querySelector(".hover-info");
            if (hoverId) { // Docstrings from the table
              // TODO stop doing an implicit conversion from string to number here
              let data = versoDocData[hoverId];
              if (data) {
                const info = document.createElement("span");
                info.className = "hover-info";
                info.style.display = "block";
                info.innerHTML = data;
                content.appendChild(info);
                /* Render docstrings - TODO server-side */
                if ('undefined' !== typeof marked) {
                    for (const d of content.querySelectorAll("code.docstring, pre.docstring")) {
                        const str = d.innerText;
                        const html = marked.parse(str);
                        const rendered = document.createElement("div");
                        rendered.classList.add("docstring");
                        rendered.innerHTML = html;
                        d.parentNode.replaceChild(rendered, d);
                    }
                }
              } else {
                content.innerHTML = "Failed to load doc ID: " + hoverId;
              }
            } else if (hoverInfo) { // The inline info, still used for compiler messages
              content.appendChild(hoverInfo.cloneNode(true));
            }
          }
          return content;
        }
      };



      const addTippy = (selector, props) => {
        tippy(selector, Object.assign({}, defaultTippyProps, props));
      };
      document.querySelectorAll('.hl.lean .const.token, .hl.lean .keyword.token, .hl.lean .literal.token, .hl.lean .option.token, .hl.lean .var.token, .hl.lean .typed.token').forEach(element => {
        element.setAttribute('data-tippy-theme', 'lean');
      });
      document.querySelectorAll('.hl.lean .has-info.warning').forEach(element => {
        element.setAttribute('data-tippy-theme', 'warning message');
      });
      document.querySelectorAll('.hl.lean .has-info.info').forEach(element => {
        element.setAttribute('data-tippy-theme', 'info message');
      });
      document.querySelectorAll('.hl.lean .has-info.error').forEach(element => {
        element.setAttribute('data-tippy-theme', 'error message');
      });
      document.querySelectorAll('.hl.lean .tactic').forEach(element => {
        element.setAttribute('data-tippy-theme', 'tactic');
      });
      let insts = tippy('.hl.lean .const.token, .hl.lean .keyword.token, .hl.lean .literal.token, .hl.lean .option.token, .hl.lean .var.token, .hl.lean .typed.token, .hl.lean .has-info, .hl.lean .tactic', defaultTippyProps);



      /*
      tippy('.hl.lean .tactic', {
        allowHtml: true,

        onHide(any) { return false; },
        trigger: "click",

        maxWidth: "none",
        onShow(inst) {
          const toggle = inst.reference.querySelector("input.tactic-toggle");
          if (toggle && toggle.checked) {
            return false;
          }
          if (blockedByTippy(inst.reference)) { return false; }
        },
        content (tgt) {
          const content = document.createElement("span");
          const state = tgt.querySelector(".tactic-state").cloneNode(true);
          state.style.display = "block";
          content.appendChild(state);
          content.style.display = "block";
          content.className = "hl lean popup";
          return content;
        }
      });
      */
  });
}
</script>
    </head>
  <body>
    <header>
      <div class="header-logo-wrapper">
        <a href="" id="logo"><img src="static/lean_logo.svg"></a></div>
      <div class="header-title-wrapper">
        <a href="" class="header-title"><h1>
            Functional Programming in Lean</h1>
          </a></div>
      </header>
    <label for="toggle-toc" id="toggle-toc-click"><span class="line line1"></span><span class="line line2"></span><span class="line line3"></span></label><div class="with-toc">
      <div class="toc-backdrop" onclick="document.getElementById('toggle-toc-click')?.click()"></div>
      <nav id="toc">
        <input type="checkbox" id="toggle-toc"><div class="first">
          <a href="" class="toc-title"><h1>
              Functional Programming in Lean</h1>
            </a><div class="split-tocs">
            <div class="split-toc book">
              <div class="title">
                <label for="--verso-manual-toc-----bookRoot" class="toggle-split-toc"><input type="checkbox" class="toggle-split-toc" id="--verso-manual-toc-----bookRoot"></label><span class="">Table of Contents</span></div>
              <table><tr class="unnumbered"><td class="num"><td><a href="Introduction/#Functional-Programming-in-Lean--Introduction">Introduction</a></td></tr><tr class="unnumbered"><td class="num"><td><a href="Acknowledgments/#Functional-Programming-in-Lean--Acknowledgments">Acknowledgments</a></td></tr><tr class="numbered"><td class="num">1.</td><td><a href="Getting-to-Know-Lean/#getting-to-know">Getting to Know Lean</a></td></tr><tr class="numbered"><td class="num">2.</td><td><a href="Hello___-World___/#hello-world">Hello, World!</a></td></tr><tr class="unnumbered"><td class="num"><td><a href="Interlude___-Propositions___-Proofs___-and-Indexing/#props-proofs-indexing">Interlude: Propositions, Proofs, and Indexing</a></td></tr><tr class="numbered"><td class="num">3.</td><td><a href="Overloading-and-Type-Classes/#Functional-Programming-in-Lean--Overloading-and-Type-Classes">Overloading and Type Classes</a></td></tr><tr class="current numbered"><td class="num">4.</td><td><a href="Monads/#Functional-Programming-in-Lean--Monads">Monads</a></td></tr><tr class="numbered"><td class="num">5.</td><td><a href="Functors___-Applicative-Functors___-and-Monads/#Functional-Programming-in-Lean--Functors___-Applicative-Functors___-and-Monads">Functors, Applicative Functors, and Monads</a></td></tr><tr class="numbered"><td class="num">6.</td><td><a href="Monad-Transformers/#Functional-Programming-in-Lean--Monad-Transformers">Monad Transformers</a></td></tr><tr class="numbered"><td class="num">7.</td><td><a href="Programming-with-Dependent-Types/#Functional-Programming-in-Lean--Programming-with-Dependent-Types">Programming with Dependent Types</a></td></tr><tr class="unnumbered"><td class="num"><td><a href="Interlude___-Tactics___-Induction___-and-Proofs/#Functional-Programming-in-Lean--Interlude___-Tactics___-Induction___-and-Proofs">Interlude: Tactics, Induction, and Proofs</a></td></tr><tr class="numbered"><td class="num">8.</td><td><a href="Programming___-Proving___-and-Performance/#Functional-Programming-in-Lean--Programming___-Proving___-and-Performance">Programming, Proving, and Performance</a></td></tr><tr class="numbered"><td class="num">9.</td><td><a href="Next-Steps/#next-steps">Next Steps</a></td></tr></table></div>
            <div class="split-toc">
              <div class="title">
                <label for="--verso-manual-toc-Functional-Programming-in-Lean--Monads" class="toggle-split-toc"><input type="checkbox" class="toggle-split-toc" id="--verso-manual-toc-Functional-Programming-in-Lean--Monads" checked="checked"></label><span class="number">4.</span> <span class=""><a href="Monads/#Functional-Programming-in-Lean--Monads">Monads</a></span></div>
              <table><tr class="numbered"><td class="num">4.1.</td><td><a href="Monads/One-API___-Many-Applications/#Functional-Programming-in-Lean--Monads--One-API___-Many-Applications">One API, Many Applications</a></td></tr><tr class="numbered"><td class="num">4.2.</td><td><a href="Monads/The-Monad-Type-Class/#Functional-Programming-in-Lean--Monads--The-Monad-Type-Class">The Monad Type Class</a></td></tr><tr class="current numbered"><td class="num">4.3.</td><td><a href="Monads/Example___-Arithmetic-in-Monads/#Functional-Programming-in-Lean--Monads--Example___-Arithmetic-in-Monads">Example: Arithmetic in Monads</a></td></tr><tr class="numbered"><td class="num">4.4.</td><td><a href="Monads/do--Notation-for-Monads/#Functional-Programming-in-Lean--Monads--do--Notation-for-Monads"><code class="hl lean inline" data-lean-context="examples"><span class="keyword token" data-binding="">do</span></code>-Notation for Monads</a></td></tr><tr class="numbered"><td class="num">4.5.</td><td><a href="Monads/The-IO-Monad/#Functional-Programming-in-Lean--Monads--The-IO-Monad">The IO Monad</a></td></tr><tr class="numbered"><td class="num">4.6.</td><td><a href="Monads/Additional-Conveniences/#Functional-Programming-in-Lean--Monads--Additional-Conveniences">Additional Conveniences</a></td></tr><tr class="numbered"><td class="num">4.7.</td><td><a href="Monads/Summary/#Functional-Programming-in-Lean--Monads--Summary">Summary</a></td></tr></table></div>
            <div class="split-toc">
              <div class="title">
                <label for="--verso-manual-toc-Functional-Programming-in-Lean--Monads--Example___-Arithmetic-in-Monads" class="toggle-split-toc"><input type="checkbox" class="toggle-split-toc" id="--verso-manual-toc-Functional-Programming-in-Lean--Monads--Example___-Arithmetic-in-Monads" checked="checked"></label><span class="number">4.3.</span> <span class="current"><a href="Monads/Example___-Arithmetic-in-Monads/#Functional-Programming-in-Lean--Monads--Example___-Arithmetic-in-Monads">Example: Arithmetic in Monads</a></span></div>
              <table><tr class="numbered"><td class="num">4.3.1.</td><td><a href="Monads/Example___-Arithmetic-in-Monads/#Functional-Programming-in-Lean--Monads--Example___-Arithmetic-in-Monads--Arithmetic-Expressions">Arithmetic Expressions</a></td></tr><tr class="numbered"><td class="num">4.3.2.</td><td><a href="Monads/Example___-Arithmetic-in-Monads/#Functional-Programming-in-Lean--Monads--Example___-Arithmetic-in-Monads--Evaluating-Expressions">Evaluating Expressions</a></td></tr><tr class="numbered"><td class="num">4.3.3.</td><td><a href="Monads/Example___-Arithmetic-in-Monads/#Functional-Programming-in-Lean--Monads--Example___-Arithmetic-in-Monads--Further-Effects">Further Effects</a></td></tr></table></div>
            </div>
          </div>
        <div class="last">
          <ul id="meta-links">
            <li>
              <a href="https://github.com/leanprover/fp-lean">Source Code</a></li>
            <li>
              <a href="https://github.com/leanprover/fp-lean/issues">Report Issues</a></li>
            </ul>
          </div>
        </nav>
      <main><div class="content-wrapper">
          <nav class="prev-next-buttons">
            <a class="local-button active" href="Monads/The-Monad-Type-Class/#Functional-Programming-in-Lean--Monads--The-Monad-Type-Class" rel="prev" title="4.2. The Monad Type Class"><span class="arrow">←</span><span class="where">4.2. The Monad Type Class</span></a><a class="local-button active" href="Monads/do--Notation-for-Monads/#Functional-Programming-in-Lean--Monads--do--Notation-for-Monads" rel="next" title="4.4. do-Notation for Monads"><span class="where">4.4. do-Notation for Monads</span><span class="arrow">→</span></a></nav>
          <section>
            <h1>
              4.3. Example: Arithmetic in Monads</h1>
            <p>
              Monads are a way of encoding programs with side effects into a language that does not have them.
It would be easy to read this as a sort of admission that pure functional programs are missing something important, requiring programmers to jump through hoops just to write a normal program.
However, while using the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Class.Monad" data-verso-hover="811">Monad</span></code> API does impose a syntactic cost on a program, it brings two important benefits:</p>
            <ol start="1">
              <li>
                <p>
                  Programs must be honest about which effects they use in their types. A quick glance at a type signature describes <em>everything</em> that the program can do, rather than just what it accepts and what it returns.</p>
                </li>
              <li>
                <p>
                  Not every language provides the same effects. For example, only some languages have exceptions. Other languages have unique, exotic effects, such as <a href="https://www2.cs.arizona.edu/icon/">Icon's searching over multiple values</a> and Scheme or Ruby's continuations. Because monads can encode <em>any</em> effect, programmers can choose which ones are the best fit for a given application, rather than being stuck with what the language developers provided.</p>
                </li>
              </ol>
            <p>
              One example of a program that can make sense in a variety of monads is an evaluator for arithmetic expressions.</p>
            <section>
              <h2 id="Functional-Programming-in-Lean--Monads--Example___-Arithmetic-in-Monads--Arithmetic-Expressions">
                4.3.1. Arithmetic Expressions</h2>
              <div class="paragraph">
                <p>
                  An arithmetic expression is either a literal integer or a primitive binary operator applied to two expressions. The operators are addition, subtraction, multiplication, and division:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.inductive-6554" data-verso-hover="96">inductive</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr" data-verso-hover="869">Expr</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.23632" data-verso-hover="113">op</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-6581">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr" data-verso-hover="869">Expr</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.23632" data-verso-hover="113">op</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.23632" data-verso-hover="113">op</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr" data-verso-hover="869">Expr</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.23632" data-verso-hover="113">op</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr" data-verso-hover="869">Expr</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.23632" data-verso-hover="113">op</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr" data-verso-hover="869">Expr</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.23632" data-verso-hover="113">op</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.inductive-6667" data-verso-hover="96">inductive</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith" data-verso-hover="872">Arith</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-6683">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.plus" data-verso-hover="873">plus</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.minus" data-verso-hover="874">minus</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.times" data-verso-hover="875">times</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.div" data-verso-hover="876">div</span></code></div>
              <div class="paragraph">
                <p>
                  The expression <code>2 + 3</code> is represented:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-6776" data-verso-hover="240">open</span><span class="inter-text"> </span><span class="unknown token" data-binding="">Expr</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.in-6776">in</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-6789" data-verso-hover="240">open</span><span class="inter-text"> </span><span class="unknown token" data-binding="">Arith</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.in-6789">in</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-6803">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-twoPlusThree" data-verso-hover="877">twoPlusThree</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr" data-verso-hover="869">Expr</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith" data-verso-hover="872">Arith</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.plus" data-verso-hover="873">plus</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">2</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">3</span><span class="unknown token" data-binding="">)</span></code><p>
                  and <code>14 / (45 - 5 * 9)</code> is represented:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-6926" data-verso-hover="240">open</span><span class="inter-text"> </span><span class="unknown token" data-binding="">Expr</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.in-6926">in</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-6939" data-verso-hover="240">open</span><span class="inter-text"> </span><span class="unknown token" data-binding="">Arith</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.in-6939">in</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-6953">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-fourteenDivided" data-verso-hover="878">fourteenDivided</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr" data-verso-hover="869">Expr</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith" data-verso-hover="872">Arith</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.div" data-verso-hover="876">div</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">14</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.minus" data-verso-hover="874">minus</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">45</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.times" data-verso-hover="875">times</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">5</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">        </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">9</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span></code></div>
              </section>
            <section>
              <h2 id="Functional-Programming-in-Lean--Monads--Example___-Arithmetic-in-Monads--Evaluating-Expressions">
                4.3.2. Evaluating Expressions</h2>
              <div class="paragraph">
                <p>
                  Because expressions include division, and division by zero is undefined, evaluation might fail.
One way to represent failure is to use <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span></code>:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-7169">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-One.evaluateOption" data-verso-hover="879">evaluateOption</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr" data-verso-hover="869">Expr</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith" data-verso-hover="872">Arith</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">Expr.const</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.24599" data-verso-hover="27">i</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.24599" data-verso-hover="27">i</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">Expr.prim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.24672" data-verso-hover="880">p</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.24673" data-verso-hover="881">e1</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.24674" data-verso-hover="881">e2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-One.evaluateOption" data-verso-hover="879">evaluateOption</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.24673" data-verso-hover="881">e1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-7294">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.24715" data-verso-hover="27">v1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-One.evaluateOption" data-verso-hover="879">evaluateOption</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.24674" data-verso-hover="881">e2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-7330">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.24755" data-verso-hover="27">v2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.match-7344" data-verso-hover="100">match</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.24672" data-verso-hover="880">p</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.match-7344" data-verso-hover="100">with</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.plus" data-verso-hover="873">Arith.plus</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.24715" data-verso-hover="27">v1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">+</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.24755" data-verso-hover="27">v2</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.minus" data-verso-hover="874">Arith.minus</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.24715" data-verso-hover="27">v1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">-</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.24755" data-verso-hover="27">v2</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.times" data-verso-hover="875">Arith.times</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.24715" data-verso-hover="27">v1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">*</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.24755" data-verso-hover="27">v2</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.div" data-verso-hover="876">Arith.div</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-7483" data-verso-hover="16">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.24755" data-verso-hover="27">v2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">==</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">0</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-7483" data-verso-hover="16">then</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="145">none</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-7483" data-verso-hover="16">else</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.24715" data-verso-hover="27">v1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">/</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.24755" data-verso-hover="27">v2</span><span class="unknown token" data-binding="">)</span></code></div>
              <div class="paragraph">
                <p>
                  This definition uses the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span></code> instance to propagate failures from evaluating both branches of a binary operator.
However, the function mixes two concerns: evaluating subexpressions and applying a binary operator to the results.
It can be improved by splitting it into two functions:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-7619">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Two.applyPrim" data-verso-hover="882">applyPrim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith" data-verso-hover="872">Arith</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.plus" data-verso-hover="873">Arith.plus</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.25492" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.25493" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.25492" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">+</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.25493" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.minus" data-verso-hover="874">Arith.minus</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.25602" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.25603" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.25602" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">-</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.25603" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.times" data-verso-hover="875">Arith.times</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.25686" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.25687" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.25686" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">*</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.25687" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.div" data-verso-hover="876">Arith.div</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.25770" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.25771" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-7808" data-verso-hover="16">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.25771" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">==</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">0</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-7808" data-verso-hover="16">then</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="145">none</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-7808" data-verso-hover="16">else</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.25770" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">/</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.25771" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-7847">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Two.evaluateOption" data-verso-hover="879">evaluateOption</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr" data-verso-hover="869">Expr</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith" data-verso-hover="872">Arith</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">Expr.const</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.26113" data-verso-hover="27">i</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.26113" data-verso-hover="27">i</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">Expr.prim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.26186" data-verso-hover="880">p</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.26187" data-verso-hover="881">e1</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.26188" data-verso-hover="881">e2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Two.evaluateOption" data-verso-hover="879">evaluateOption</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.26187" data-verso-hover="881">e1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-7972">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.26229" data-verso-hover="27">v1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Two.evaluateOption" data-verso-hover="879">evaluateOption</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.26188" data-verso-hover="881">e2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-8008">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.26269" data-verso-hover="27">v2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Two.applyPrim" data-verso-hover="882">applyPrim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.26186" data-verso-hover="880">p</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.26229" data-verso-hover="27">v1</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.26269" data-verso-hover="27">v2</span></code></div>
              <div class="paragraph">
                <p>
                  Running <code class="hl lean inline" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-8139" data-verso-hover="7">#eval</span><span class="inter-text"> </span><span class="const token" data-binding="const-Two.evaluateOption" data-verso-hover="879">evaluateOption</span><span class="inter-text"> </span><span class="const token" data-binding="const-fourteenDivided" data-verso-hover="878">fourteenDivided</span></code> yields <code>none</code>, as expected, but this is not a very useful error message.
Because the code was written using <code>&gt;&gt;=</code> rather than by explicitly handling the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option.none" data-verso-hover="145">none</span></code> constructor, only a small modification is required for it to provide an error message on failure:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-8263">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Three.applyPrim" data-verso-hover="883">applyPrim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith" data-verso-hover="872">Arith</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.plus" data-verso-hover="873">Arith.plus</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.28938" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.28939" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.28938" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">+</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.28939" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.minus" data-verso-hover="874">Arith.minus</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29056" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29057" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.29056" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">-</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29057" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.times" data-verso-hover="875">Arith.times</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29140" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29141" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.29140" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">*</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29141" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.div" data-verso-hover="876">Arith.div</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29224" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29225" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-8463" data-verso-hover="16">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29225" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">==</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">0</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-8463" data-verso-hover="16">then</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="const token" data-binding="const-Except.error" data-verso-hover="746">Except.error</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termS!_-8497">s!</span><span class="unknown token" data-binding="">"Tried to divide {</span><span class="var token" data-binding="var-_uniq.29224" data-verso-hover="27">x</span><span class="unknown token" data-binding="">} by zero"</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-8463" data-verso-hover="16">else</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.29224" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">/</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29225" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-8552">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Three.evaluateExcept" data-verso-hover="884">evaluateExcept</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr" data-verso-hover="869">Expr</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith" data-verso-hover="872">Arith</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">Expr.const</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29642" data-verso-hover="27">i</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29642" data-verso-hover="27">i</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">Expr.prim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29723" data-verso-hover="880">p</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29724" data-verso-hover="881">e1</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29725" data-verso-hover="881">e2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Three.evaluateExcept" data-verso-hover="884">evaluateExcept</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29724" data-verso-hover="881">e1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-8684">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29767" data-verso-hover="27">v1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Three.evaluateExcept" data-verso-hover="884">evaluateExcept</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29725" data-verso-hover="881">e2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-8720">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29807" data-verso-hover="27">v2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Three.applyPrim" data-verso-hover="883">applyPrim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29723" data-verso-hover="880">p</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29767" data-verso-hover="27">v1</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.29807" data-verso-hover="27">v2</span></code><p>
                  The only difference is that the type signature mentions <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span></code> instead of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span></code>, and the failing case uses <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Except.error" data-verso-hover="746">Except.error</span></code> instead of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option.none" data-verso-hover="145">none</span></code>.
By making the evaluator polymorphic over its monad and passing it <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.31385" data-verso-hover="885">applyPrim</span></code> as an argument, a single evaluator becomes capable of both forms of error reporting:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-8832">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Four.applyPrimOption" data-verso-hover="886">applyPrimOption</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith" data-verso-hover="872">Arith</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.plus" data-verso-hover="873">Arith.plus</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30044" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30045" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.30044" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">+</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30045" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.minus" data-verso-hover="874">Arith.minus</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30154" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30155" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.30154" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">-</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30155" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.times" data-verso-hover="875">Arith.times</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30238" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30239" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.30238" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">*</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30239" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.div" data-verso-hover="876">Arith.div</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30322" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30323" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-9031" data-verso-hover="16">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30323" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">==</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">0</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-9031" data-verso-hover="16">then</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="const token" data-binding="const-Option.none" data-verso-hover="145">none</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-9031" data-verso-hover="16">else</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.30322" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">/</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30323" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-9080">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Four.applyPrimExcept" data-verso-hover="887">applyPrimExcept</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith" data-verso-hover="872">Arith</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.plus" data-verso-hover="873">Arith.plus</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30684" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30685" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.30684" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">+</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30685" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.minus" data-verso-hover="874">Arith.minus</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30802" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30803" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.30802" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">-</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30803" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.times" data-verso-hover="875">Arith.times</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30886" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30887" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.30886" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">*</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30887" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.div" data-verso-hover="876">Arith.div</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30970" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30971" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-9286" data-verso-hover="16">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30971" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">==</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">0</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-9286" data-verso-hover="16">then</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="const token" data-binding="const-Except.error" data-verso-hover="746">Except.error</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termS!_-9320">s!</span><span class="unknown token" data-binding="">"Tried to divide {</span><span class="var token" data-binding="var-_uniq.30970" data-verso-hover="27">x</span><span class="unknown token" data-binding="">} by zero"</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-9286" data-verso-hover="16">else</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.30970" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">/</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.30971" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-9375">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Four.evaluateM" data-verso-hover="888">evaluateM</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31372" data-verso-hover="868">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.31385" data-verso-hover="885">applyPrim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith" data-verso-hover="872">Arith</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31372" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Expr" data-verso-hover="869">Expr</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith" data-verso-hover="872">Arith</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31372" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">Expr.const</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31416" data-verso-hover="27">i</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31416" data-verso-hover="27">i</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">Expr.prim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31491" data-verso-hover="880">p</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31492" data-verso-hover="881">e1</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31493" data-verso-hover="881">e2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Four.evaluateM" data-verso-hover="888">evaluateM</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31385" data-verso-hover="885">applyPrim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31492" data-verso-hover="881">e1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-9559">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31568" data-verso-hover="27">v1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Four.evaluateM" data-verso-hover="888">evaluateM</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31385" data-verso-hover="885">applyPrim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31493" data-verso-hover="881">e2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-9600">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31640" data-verso-hover="27">v2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="var token" data-binding="var-_uniq.31385" data-verso-hover="885">applyPrim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31491" data-verso-hover="880">p</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31568" data-verso-hover="27">v1</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.31640" data-verso-hover="27">v2</span></code></div>
              <p>
                Using it with <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Four.applyPrimOption" data-verso-hover="886">applyPrimOption</span></code> works just like the first evaluator:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">none</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-9718" data-verso-hover="7">#eval</span></span><span class="inter-text"> </span><span class="const token" data-binding="const-Four.evaluateM" data-verso-hover="888">evaluateM</span><span class="inter-text"> </span><span class="const token" data-binding="const-Four.applyPrimOption" data-verso-hover="886">applyPrimOption</span><span class="inter-text"> </span><span class="const token" data-binding="const-fourteenDivided" data-verso-hover="878">fourteenDivided</span></code><div class="information">
                <pre>none</pre></div>
              <p>
                Similarly, using it with <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Four.applyPrimExcept" data-verso-hover="887">applyPrimExcept</span></code> works just like the version with error messages:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">Except.error "Tried to divide 14 by zero"</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-9896" data-verso-hover="7">#eval</span></span><span class="inter-text"> </span><span class="const token" data-binding="const-Four.evaluateM" data-verso-hover="888">evaluateM</span><span class="inter-text"> </span><span class="const token" data-binding="const-Four.applyPrimExcept" data-verso-hover="887">applyPrimExcept</span><span class="inter-text"> </span><span class="const token" data-binding="const-fourteenDivided" data-verso-hover="878">fourteenDivided</span></code><div class="information">
                <pre>Except.error "Tried to divide 14 by zero"</pre></div>
              <div class="paragraph">
                <p>
                  The code can still be improved.
The functions <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Four.applyPrimOption" data-verso-hover="886">applyPrimOption</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Four.applyPrimExcept" data-verso-hover="887">applyPrimExcept</span></code> differ only in their treatment of division, which can be extracted into another parameter to the evaluator:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-10042">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-FourPointFive.applyDivOption" data-verso-hover="889">applyDivOption</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.36848" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.36850" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-10101" data-verso-hover="16">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.36850" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">==</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">0</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-10101" data-verso-hover="16">then</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="const token" data-binding="const-Option.none" data-verso-hover="145">none</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-10101" data-verso-hover="16">else</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.36848" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">/</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.36850" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-10150">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-FourPointFive.applyDivExcept" data-verso-hover="890">applyDivExcept</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.37082" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.37084" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-10216" data-verso-hover="16">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37084" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">==</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">0</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-10216" data-verso-hover="16">then</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="const token" data-binding="const-Except.error" data-verso-hover="746">Except.error</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termS!_-10250">s!</span><span class="unknown token" data-binding="">"Tried to divide {</span><span class="var token" data-binding="var-_uniq.37082" data-verso-hover="27">x</span><span class="unknown token" data-binding="">} by zero"</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-10216" data-verso-hover="16">else</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.37082" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">/</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37084" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-10305">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-FourPointFive.applyPrim" data-verso-hover="891">applyPrim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37403" data-verso-hover="868">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.37414" data-verso-hover="892">applyDiv</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37403" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Arith" data-verso-hover="872">Arith</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37403" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.plus" data-verso-hover="873">Arith.plus</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37464" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37465" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.37464" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">+</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37465" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.minus" data-verso-hover="874">Arith.minus</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37576" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37577" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.37576" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">-</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37577" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.times" data-verso-hover="875">Arith.times</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37660" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37661" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.37660" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">*</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37661" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith.div" data-verso-hover="876">Arith.div</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37744" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37745" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37414" data-verso-hover="892">applyDiv</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37744" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37745" data-verso-hover="27">y</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-10556">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-FourPointFive.evaluateM" data-verso-hover="893">evaluateM</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37893" data-verso-hover="868">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.37904" data-verso-hover="892">applyDiv</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37893" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Expr" data-verso-hover="869">Expr</span><span class="inter-text"> </span><span class="const token" data-binding="const-Arith" data-verso-hover="872">Arith</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37893" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">Expr.const</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37934" data-verso-hover="27">i</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37934" data-verso-hover="27">i</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">Expr.prim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.38009" data-verso-hover="880">p</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.38010" data-verso-hover="881">e1</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.38011" data-verso-hover="881">e2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-FourPointFive.evaluateM" data-verso-hover="893">evaluateM</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37904" data-verso-hover="892">applyDiv</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.38010" data-verso-hover="881">e1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-10728">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.38083" data-verso-hover="27">v1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-FourPointFive.evaluateM" data-verso-hover="893">evaluateM</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37904" data-verso-hover="892">applyDiv</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.38011" data-verso-hover="881">e2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-10768">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.38152" data-verso-hover="27">v2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-FourPointFive.applyPrim" data-verso-hover="891">applyPrim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.37904" data-verso-hover="892">applyDiv</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.38009" data-verso-hover="880">p</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.38083" data-verso-hover="27">v1</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.38152" data-verso-hover="27">v2</span></code><p>
                  In this refactored code, the fact that the two code paths differ only in their treatment of failure has been made fully apparent.</p>
                </div>
              </section>
            <section>
              <h2 id="Functional-Programming-in-Lean--Monads--Example___-Arithmetic-in-Monads--Further-Effects">
                4.3.3. Further Effects</h2>
              <p>
                Failure and exceptions are not the only kinds of effects that can be interesting when working with an evaluator.
While division's only side effect is failure, adding other primitive operators to the expressions make it possible to express other effects.</p>
              <p>
                The first step is an additional refactoring, extracting division from the datatype of primitives:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.inductive-11464" data-verso-hover="96">inductive</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim" data-verso-hover="894">Prim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.41627" data-verso-hover="113">special</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-11496">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.plus" data-verso-hover="895">plus</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.minus" data-verso-hover="896">minus</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.times" data-verso-hover="897">times</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.other" data-verso-hover="898">other</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.41627" data-verso-hover="113">special</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim" data-verso-hover="894">Prim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.41627" data-verso-hover="113">special</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.inductive-11569" data-verso-hover="96">inductive</span><span class="inter-text"> </span><span class="const token" data-binding="const-CanFail" data-verso-hover="899">CanFail</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-11587">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-CanFail.div" data-verso-hover="900">div</span></code><p>
                The name <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-CanFail" data-verso-hover="899">CanFail</span></code> suggests that the effect introduced by division is potential failure.</p>
              <p>
                The second step is to broaden the scope of the division handler argument to <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-evaluateM" data-verso-hover="901">evaluateM</span></code> so that it can process any special operator:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-11660">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-divOption" data-verso-hover="902">divOption</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-CanFail" data-verso-hover="899">CanFail</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-CanFail.div" data-verso-hover="900">CanFail.div</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42122" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42123" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-11740" data-verso-hover="16">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42123" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">==</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">0</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-11740" data-verso-hover="16">then</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="145">none</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-11740" data-verso-hover="16">else</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.42122" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">/</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42123" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-11779">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-divExcept" data-verso-hover="903">divExcept</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-CanFail" data-verso-hover="899">CanFail</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-CanFail.div" data-verso-hover="900">CanFail.div</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42456" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42457" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-11870" data-verso-hover="16">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42457" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">==</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">0</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-11870" data-verso-hover="16">then</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="const token" data-binding="const-Except.error" data-verso-hover="746">Except.error</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termS!_-11904">s!</span><span class="unknown token" data-binding="">"Tried to divide {</span><span class="var token" data-binding="var-_uniq.42456" data-verso-hover="27">x</span><span class="unknown token" data-binding="">} by zero"</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-11870" data-verso-hover="16">else</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.42456" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">/</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42457" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-11959">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-applyPrim" data-verso-hover="904">applyPrim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42838" data-verso-hover="868">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.42861" data-verso-hover="905">applySpecial</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42848" data-verso-hover="113">special</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42838" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Prim" data-verso-hover="894">Prim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42848" data-verso-hover="113">special</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42838" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.plus" data-verso-hover="895">Prim.plus</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42917" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42918" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.42917" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">+</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42918" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.minus" data-verso-hover="896">Prim.minus</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43031" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43032" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.43031" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">-</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43032" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.times" data-verso-hover="897">Prim.times</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43117" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43118" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.43117" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">*</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43118" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.other" data-verso-hover="898">Prim.other</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43208" data-verso-hover="906">op</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43209" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43210" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.42861" data-verso-hover="905">applySpecial</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43208" data-verso-hover="906">op</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43209" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43210" data-verso-hover="27">y</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-12241">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-evaluateM" data-verso-hover="901">evaluateM</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43376" data-verso-hover="868">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.43399" data-verso-hover="905">applySpecial</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43386" data-verso-hover="113">special</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43376" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Expr" data-verso-hover="869">Expr</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Prim" data-verso-hover="894">Prim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43386" data-verso-hover="113">special</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43376" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">Expr.const</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43432" data-verso-hover="27">i</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43432" data-verso-hover="27">i</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">Expr.prim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43507" data-verso-hover="907">p</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43508" data-verso-hover="908">e1</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43509" data-verso-hover="908">e2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-evaluateM" data-verso-hover="901">evaluateM</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43399" data-verso-hover="905">applySpecial</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43508" data-verso-hover="908">e1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-12442">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43585" data-verso-hover="27">v1</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-evaluateM" data-verso-hover="901">evaluateM</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43399" data-verso-hover="905">applySpecial</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43509" data-verso-hover="908">e2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-12486">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43658" data-verso-hover="27">v2</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-applyPrim" data-verso-hover="904">applyPrim</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43399" data-verso-hover="905">applySpecial</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43507" data-verso-hover="907">p</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43585" data-verso-hover="27">v1</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43658" data-verso-hover="27">v2</span></code><section>
                <h3 id="Functional-Programming-in-Lean--Monads--Example___-Arithmetic-in-Monads--Further-Effects--No-Effects">
                  4.3.3.1. No Effects</h3>
                <p>
                  The type <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Empty" data-verso-hover="185">Empty</span></code> has no constructors, and thus no values, like the <code>Nothing</code> type in Scala or Kotlin.
In Scala and Kotlin, <code>Nothing</code> can represent computations that never return a result, such as functions that crash the program, throw exceptions, or always fall into infinite loops.
An argument to a function or method of type <code>Nothing</code> indicates dead code, as there will never be a suitable argument value.
Lean doesn't support infinite loops and exceptions, but <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Empty" data-verso-hover="185">Empty</span></code> is still useful as an indication to the type system that a function cannot be called.
Using the syntax <code class="hl lean inline" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.nomatch-12762" data-verso-hover="909">nomatch</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44035" data-verso-hover="910">E</span></code> when <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.44035" data-verso-hover="910">E</span></code> is an expression whose type has no constructors indicates to Lean that the current expression need not return a result, because it could never have been called.</p>
                <p>
                  Using <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Empty" data-verso-hover="185">Empty</span></code> as the parameter to <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Prim" data-verso-hover="894">Prim</span></code> indicates that there are no additional cases beyond <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Prim.plus" data-verso-hover="895">Prim.plus</span></code>, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Prim.minus" data-verso-hover="896">Prim.minus</span></code>, and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Prim.times" data-verso-hover="897">Prim.times</span></code>, because it is impossible to come up with a value of type <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Empty" data-verso-hover="185">Empty</span></code> to place in the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Prim.other" data-verso-hover="898">Prim.other</span></code> constructor.
Because a function to apply an operator of type <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Empty" data-verso-hover="185">Empty</span></code> to two integers can never be called, it doesn't need to return a result.
Thus, it can be used in <em>any</em> monad:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-12588">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-applyEmpty" data-verso-hover="911">applyEmpty</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43968" data-verso-hover="868">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.43975" data-verso-hover="910">op</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Empty" data-verso-hover="185">Empty</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">_</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">_</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43968" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.nomatch-12659" data-verso-hover="909">nomatch</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.43975" data-verso-hover="910">op</span></code><p>
                  This can be used together with <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Id" data-verso-hover="863">Id</span></code>, the identity monad, to evaluate expressions that have no effects whatsoever:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-12930" data-verso-hover="240">open</span><span class="inter-text"> </span><span class="unknown token" data-binding="">Expr</span><span class="inter-text"> </span><span class="unknown token" data-binding="">Prim</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.in-12930">in</span><span class="inter-text">
</span><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">-9</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-12948" data-verso-hover="7">#eval</span></span><span class="inter-text"> </span><span class="const token" data-binding="const-evaluateM" data-verso-hover="901">evaluateM</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-Id" data-verso-hover="863">Id</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="const token" data-binding="const-applyEmpty" data-verso-hover="911">applyEmpty</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.plus" data-verso-hover="895">plus</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">5</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">-</span><span class="typed token" data-binding="" data-verso-hover="27">14</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span></code><div class="information">
                  <pre>-9</pre></div>
                </section>
              <section>
                <h3 id="nondeterministic-search">
                  4.3.3.2. Nondeterministic Search<span class="permalink-widget inline"><a href="find/?domain=Verso.Genre.Manual.section&name=nondeterministic-search" title="Permalink">🔗</a></span></h3>
                <p>
                  Instead of simply failing when encountering division by zero, it would also be sensible to backtrack and try a different input.
Given the right monad, the very same <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-evaluateM" data-verso-hover="901">evaluateM</span></code> can perform a nondeterministic search for a <em>set</em> of answers that do not result in failure.
This requires, in addition to division, some means of specifying a choice of results.
One way to do this is to add a function <code>choose</code> to the language of expressions that instructs the evaluator to pick either of its arguments while searching for non-failing results.</p>
                <p>
                  The result of the evaluator is now a multiset of values, rather than a single value.
The rules for evaluation into a multiset are:</p>
                <ul>
                  <li>
                    <p>
                      Constants <code class="math inline">n</code> evaluate to singleton sets <code class="math inline">\{n\}</code>.</p>
                    </li>
                  <li>
                    <p>
                      Arithmetic operators other than division are called on each pair from the Cartesian product of the operators, so <code class="math inline">X + Y</code> evaluates to <code class="math inline">\{ x + y \mid x ∈ X, y ∈ Y \}</code>.</p>
                    </li>
                  <li>
                    <p>
                      Division <code class="math inline">X / Y</code> evaluates to <code class="math inline">\{ x / y \mid x ∈ X, y ∈ Y, y ≠ 0\}</code>. In other words, all <code class="math inline">0</code> values in <code class="math inline">Y</code>  are thrown out.</p>
                    </li>
                  <li>
                    <p>
                      A choice <code class="math inline">\mathrm{choose}(x, y)</code> evaluates to <code class="math inline">\{ x, y \}</code>.</p>
                    </li>
                  </ul>
                <p>
                  For example, <code class="math inline">1 + \mathrm{choose}(2, 5)</code> evaluates to <code class="math inline">\{ 3, 6 \}</code>, <code class="math inline">1 + 2 / 0</code> evaluates to <code class="math inline">\{\}</code>, and <code class="math inline">90 / (\mathrm{choose}(-5, 5) + 5)</code> evaluates to <code class="math inline">\{ 9 \}</code>.
Using multisets instead of true sets simplifies the code by removing the need to check for uniqueness of elements.</p>
                <div class="paragraph">
                  <p>
                    A monad that represents this non-deterministic effect must be able to represent a situation in which there are no answers, and a situation in which there is at least one answer together with any remaining answers:</p>
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.inductive-39" data-verso-hover="96">inductive</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-66">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.none" data-verso-hover="913">none</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="113">α</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.more" data-verso-hover="914">more</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Unit" data-verso-hover="184">Unit</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="113">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="113">α</span></code><p>
                    This datatype looks very much like <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-List" data-verso-hover="111">List</span></code>.
The difference is that where <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-List.cons" data-verso-hover="132">List.cons</span></code> stores the rest of the list, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.more" data-verso-hover="914">more</span></code> stores a function that should compute the remaining values on demand.
This means that a consumer of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span></code> can stop the search when some number of results have been found.</p>
                  </div>
                <div class="paragraph">
                  <p>
                    A single result is represented by a <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.more" data-verso-hover="914">more</span></code> constructor that returns no further results:</p>
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-177">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.one" data-verso-hover="915">Many.one</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.524" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.522" data-verso-hover="113">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.522" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.more" data-verso-hover="914">Many.more</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.524" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-225">fun</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.none" data-verso-hover="913">Many.none</span><span class="unknown token" data-binding="">)</span></code></div>
                <div class="paragraph">
                  <p>
                    The union of two multisets of results can be computed by checking whether the first multiset is empty.
If so, the second multiset is the union.
If not, the union consists of the first element of the first multiset followed by the union of the rest of the first multiset with the second multiset:</p>
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-284">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.union" data-verso-hover="916">Many.union</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.548" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.548" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.548" data-verso-hover="113">α</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.none" data-verso-hover="913">Many.none</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.577" data-verso-hover="917">ys</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.577" data-verso-hover="917">ys</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.more" data-verso-hover="914">Many.more</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.606" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.607" data-verso-hover="918">xs</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.608" data-verso-hover="917">ys</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.more" data-verso-hover="914">Many.more</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.606" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-396">fun</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.union" data-verso-hover="916">union</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.607" data-verso-hover="918">xs</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.608" data-verso-hover="917">ys</span><span class="unknown token" data-binding="">)</span></code></div>
                <div class="paragraph">
                  <p>
                    It can be convenient to start a search process with a list of values.
<code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.fromList" data-verso-hover="919">Many.fromList</span></code> converts a list into a multiset of results:</p>
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-468">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.fromList" data-verso-hover="919">Many.fromList</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-List" data-verso-hover="111">List</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.832" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.832" data-verso-hover="113">α</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.none" data-verso-hover="913">Many.none</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.872" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">::</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.873" data-verso-hover="137">xs</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.more" data-verso-hover="914">Many.more</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.872" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-556">fun</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.fromList" data-verso-hover="919">fromList</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.873" data-verso-hover="137">xs</span><span class="unknown token" data-binding="">)</span></code><p>
                    Similarly, once a search has been specified, it can be convenient to extract either a number of values, or all the values:</p>
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-621">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.take" data-verso-hover="920">Many.take</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Nat" data-verso-hover="6">Nat</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1037" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-List" data-verso-hover="111">List</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1037" data-verso-hover="113">α</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">0</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="unknown token" data-binding="">_</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">]</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="unknown token" data-binding="">_</span><span class="inter-text"> </span><span class="unknown token" data-binding="">+</span><span class="inter-text"> </span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.none" data-verso-hover="913">Many.none</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">]</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1226" data-verso-hover="5">n</span><span class="inter-text"> </span><span class="unknown token" data-binding="">+</span><span class="inter-text"> </span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.more" data-verso-hover="914">Many.more</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1227" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1228" data-verso-hover="918">xs</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1227" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">::</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1228" data-verso-hover="918">xs</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Many.take" data-verso-hover="920">take</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1226" data-verso-hover="5">n</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-757">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.takeAll" data-verso-hover="921">Many.takeAll</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1474" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-List" data-verso-hover="111">List</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1474" data-verso-hover="113">α</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.none" data-verso-hover="913">Many.none</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">]</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.more" data-verso-hover="914">Many.more</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1514" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1515" data-verso-hover="918">xs</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1514" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">::</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1515" data-verso-hover="918">xs</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Many.takeAll" data-verso-hover="921">takeAll</span></code></div>
                <p>
                  A <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span></code> instance requires a <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Bind.bind" data-verso-hover="864">bind</span></code> operator.
In a nondeterministic search, sequencing two operations consists of taking all possibilities from the first step and running the rest of the program on each of them, taking the union of the results.
In other words, if the first step returns three possible answers, the second step needs to be tried for all three.
Because the second step can return any number of answers for each input, taking their union represents the entire search space.</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-897">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1672" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1672" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1681" data-verso-hover="113">β</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1681" data-verso-hover="113">β</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.none" data-verso-hover="913">Many.none</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="unknown token" data-binding="">_</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Many.none" data-verso-hover="913">Many.none</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.more" data-verso-hover="914">Many.more</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1746" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1747" data-verso-hover="918">xs</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1748" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1748" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1746" data-verso-hover="121">x</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Many.union" data-verso-hover="916">union</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1747" data-verso-hover="918">xs</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1748" data-verso-hover="923">f</span><span class="unknown token" data-binding="">)</span></code><p>
                  <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.one" data-verso-hover="915">Many.one</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span></code> obey the monad contract.
To check that <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Many.one" data-verso-hover="915">Many.one</span><span class="inter-text"> </span><span class="const token" data-binding="const-Agh.v" data-verso-hover="924">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="const token" data-binding="const-Agh.f" data-verso-hover="925">f</span></code> is the same as <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Agh.f" data-verso-hover="925">f</span><span class="inter-text"> </span><span class="const token" data-binding="const-Agh.v" data-verso-hover="924">v</span></code>, start by evaluating the expression as far as possible:</p>
                <div class="eval-steps">
                  <code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Many.one" data-verso-hover="915">Many.one</span><span class="inter-text"> </span><span class="const token" data-binding="const-Agh.v" data-verso-hover="924">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="const token" data-binding="const-Agh.f" data-verso-hover="925">f</span></code><code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Many.more" data-verso-hover="914">Many.more</span><span class="inter-text"> </span><span class="const token" data-binding="const-Agh.v" data-verso-hover="924">v</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-1235">fun</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.none" data-verso-hover="913">Many.none</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="const token" data-binding="const-Agh.f" data-verso-hover="925">f</span></code><code class="hl lean block" data-lean-context="examples"><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Agh.f" data-verso-hover="925">f</span><span class="inter-text"> </span><span class="const token" data-binding="const-Agh.v" data-verso-hover="924">v</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Many.union" data-verso-hover="916">union</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.none" data-verso-hover="913">Many.none</span><span class="inter-text"> </span><span class="const token" data-binding="const-Agh.f" data-verso-hover="925">f</span><span class="unknown token" data-binding="">)</span></code><code class="hl lean block" data-lean-context="examples"><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Agh.f" data-verso-hover="925">f</span><span class="inter-text"> </span><span class="const token" data-binding="const-Agh.v" data-verso-hover="924">v</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Many.union" data-verso-hover="916">union</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.none" data-verso-hover="913">Many.none</span></code></div>
                <p>
                  The empty multiset is a right identity of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.union" data-verso-hover="916">union</span></code>, so the answer is equivalent to <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Agh.f" data-verso-hover="925">f</span><span class="inter-text"> </span><span class="const token" data-binding="const-Agh.v" data-verso-hover="924">v</span></code>.
To check that <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6911" data-verso-hover="917">v</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.one" data-verso-hover="915">Many.one</span></code> is the same as <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.6911" data-verso-hover="917">v</span></code>, consider that <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span></code> takes the union of applying <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.one" data-verso-hover="915">Many.one</span></code> to each element of <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.6911" data-verso-hover="917">v</span></code>.
In other words, if <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.6911" data-verso-hover="917">v</span></code> has the form <code class="hl lean inline" data-lean-context="examples"><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.6913" data-verso-hover="121">v₁</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6915" data-verso-hover="121">v₂</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6917" data-verso-hover="121">v₃</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="unknown token" data-binding="">…</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6919" data-verso-hover="121">vₙ</span><span class="unknown token" data-binding="">}</span></code>, then <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6911" data-verso-hover="917">v</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.one" data-verso-hover="915">Many.one</span></code> is <code class="hl lean inline" data-lean-context="examples"><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.6913" data-verso-hover="121">v₁</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.6915" data-verso-hover="121">v₂</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.6917" data-verso-hover="121">v₃</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text"> </span><span class="unknown token" data-binding="">…</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.6919" data-verso-hover="121">vₙ</span><span class="unknown token" data-binding="">}</span></code>, which is <code class="hl lean inline" data-lean-context="examples"><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.6913" data-verso-hover="121">v₁</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6915" data-verso-hover="121">v₂</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6917" data-verso-hover="121">v₃</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="unknown token" data-binding="">…</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6919" data-verso-hover="121">vₙ</span><span class="unknown token" data-binding="">}</span></code>.</p>
                <p>
                  Finally, to check that <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span></code> is associative, check that <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6911" data-verso-hover="917">v</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span></code> is the same as <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6911" data-verso-hover="917">v</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-3098">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6892" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6892" data-verso-hover="121">x</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span><span class="unknown token" data-binding="">)</span></code>.
If <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.6911" data-verso-hover="917">v</span></code> has the form <code class="hl lean inline" data-lean-context="examples"><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.6913" data-verso-hover="121">v₁</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6915" data-verso-hover="121">v₂</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6917" data-verso-hover="121">v₃</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="unknown token" data-binding="">…</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6919" data-verso-hover="121">vₙ</span><span class="unknown token" data-binding="">}</span></code>, then:</p>
                <div class="eval-steps">
                  <code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6911" data-verso-hover="917">v</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span></code><code class="hl lean block" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6913" data-verso-hover="121">v₁</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6915" data-verso-hover="121">v₂</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6917" data-verso-hover="121">v₃</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text"> </span><span class="unknown token" data-binding="">…</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6919" data-verso-hover="121">vₙ</span></code></div>
                <p>
                  which means that</p>
                <div class="eval-steps">
                  <code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6911" data-verso-hover="917">v</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span></code><code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6913" data-verso-hover="121">v₁</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text">
</span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6915" data-verso-hover="121">v₂</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text">
</span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6917" data-verso-hover="121">v₃</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text">
</span><span class="unknown token" data-binding="">…</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text">
</span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6919" data-verso-hover="121">vₙ</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span></code></div>
                <p>
                  Similarly,</p>
                <div class="eval-steps">
                  <code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6911" data-verso-hover="917">v</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-3098">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6892" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6892" data-verso-hover="121">x</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span><span class="unknown token" data-binding="">)</span></code><code class="hl lean block" data-lean-context="examples"><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-3132">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.7074" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.7074" data-verso-hover="121">x</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6913" data-verso-hover="121">v₁</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text">
</span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-3170">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.7083" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.7083" data-verso-hover="121">x</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6915" data-verso-hover="121">v₂</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text">
</span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-3208">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.7091" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.7091" data-verso-hover="121">x</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6917" data-verso-hover="121">v₃</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text">
</span><span class="unknown token" data-binding="">…</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text">
</span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-3254">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.7099" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.7099" data-verso-hover="121">x</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6919" data-verso-hover="121">vₙ</span></code><code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6913" data-verso-hover="121">v₁</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text">
</span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6915" data-verso-hover="121">v₂</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text">
</span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6917" data-verso-hover="121">v₃</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text">
</span><span class="unknown token" data-binding="">…</span><span class="inter-text"> </span><span class="unknown token" data-binding="">∪</span><span class="inter-text">
</span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.6909" data-verso-hover="923">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6919" data-verso-hover="121">vₙ</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6929" data-verso-hover="926">g</span></code></div>
                <p>
                  Thus, both sides are equal, so <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span></code> is associative.</p>
                <p>
                  The resulting monad instance is:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.instance-3472">instance</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.whereStructInst-3494">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="927">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.one" data-verso-hover="915">Many.one</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Bind.bind" data-verso-hover="928">bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.bind" data-verso-hover="922">Many.bind</span></code><p>
                  An example search using this monad finds all the combinations of numbers in a list that add to 15:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-6718">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-addsTo" data-verso-hover="929">addsTo</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.45875" data-verso-hover="5">goal</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Nat" data-verso-hover="6">Nat</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-List" data-verso-hover="111">List</span><span class="inter-text"> </span><span class="const token" data-binding="const-Nat" data-verso-hover="6">Nat</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-List" data-verso-hover="111">List</span><span class="inter-text"> </span><span class="const token" data-binding="const-Nat" data-verso-hover="6">Nat</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-6787" data-verso-hover="16">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.45875" data-verso-hover="5">goal</span><span class="inter-text"> </span><span class="unknown token" data-binding="">==</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">0</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-6787" data-verso-hover="16">then</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">]</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-6787" data-verso-hover="16">else</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="const token" data-binding="const-Many.none" data-verso-hover="913">Many.none</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46098" data-verso-hover="5">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">::</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46099" data-verso-hover="930">xs</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-6863" data-verso-hover="16">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46098" data-verso-hover="5">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.45875" data-verso-hover="5">goal</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-6863" data-verso-hover="16">then</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="const token" data-binding="const-addsTo" data-verso-hover="929">addsTo</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.45875" data-verso-hover="5">goal</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46099" data-verso-hover="930">xs</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-6863" data-verso-hover="16">else</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-addsTo" data-verso-hover="929">addsTo</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.45875" data-verso-hover="5">goal</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46099" data-verso-hover="930">xs</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Many.union" data-verso-hover="916">union</span><span class="inter-text">
</span><span class="inter-text">        </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-addsTo" data-verso-hover="929">addsTo</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.45875" data-verso-hover="5">goal</span><span class="inter-text"> </span><span class="unknown token" data-binding="">-</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46098" data-verso-hover="5">x</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46099" data-verso-hover="930">xs</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-6973">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46198" data-verso-hover="930">answer</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">         </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.46098" data-verso-hover="5">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">::</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46198" data-verso-hover="930">answer</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span></code><p>
                  The search process is recursive over the list.
The empty list is a successful search when the goal is <code class="hl lean inline" data-lean-context="examples"><span class="typed token" data-binding="" data-verso-hover="5">0</span></code>; otherwise, it fails.
When the list is non-empty, there are two possibilities: either the head of the list is greater than the goal, in which case it cannot participate in any successful searches, or it is not, in which case it can.
If the head of the list is <em>not</em> a candidate, then the search proceeds to the tail of the list.
If the head is a candidate, then there are two possibilities to be combined with <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many.union" data-verso-hover="916">Many.union</span></code>: either the solutions found contain the head, or they do not.
The solutions that do not contain the head are found with a recursive call on the tail, while the solutions that do contain it result from subtracting the head from the goal, and then attaching the head to the solutions that result from the recursive call.</p>
                <p>
                  The helper <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-printList" data-verso-hover="931">printList</span></code> ensures that one result is displayed per line:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-7060">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-printList" data-verso-hover="931">printList</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-ToString" data-verso-hover="399">ToString</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46450" data-verso-hover="369">α</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-List" data-verso-hover="111">List</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46450" data-verso-hover="369">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-IO" data-verso-hover="2">IO</span><span class="inter-text"> </span><span class="const token" data-binding="const-Unit" data-verso-hover="184">Unit</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46553" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">::</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46554" data-verso-hover="137">xs</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-7143">do</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-IO.println" data-verso-hover="250">IO.println</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46553" data-verso-hover="121">x</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-printList" data-verso-hover="931">printList</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46554" data-verso-hover="137">xs</span></code><code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">[7, 8]
[6, 9]
[5, 10]
[4, 5, 6]
[3, 5, 7]
[3, 4, 8]
[2, 6, 7]
[2, 5, 8]
[2, 4, 9]
[2, 3, 10]
[2, 3, 4, 6]
[1, 6, 8]
[1, 5, 9]
[1, 4, 10]
[1, 3, 5, 6]
[1, 3, 4, 7]
[1, 2, 5, 7]
[1, 2, 4, 8]
[1, 2, 3, 9]
[1, 2, 3, 4, 5]
</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-7477" data-verso-hover="7">#eval</span></span><span class="inter-text"> </span><span class="const token" data-binding="const-printList" data-verso-hover="931">printList</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-addsTo" data-verso-hover="929">addsTo</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">15</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="typed token" data-binding="" data-verso-hover="5">1</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">2</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">3</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">4</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">5</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">6</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">7</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">8</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">9</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">10</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Many.takeAll" data-verso-hover="921">takeAll</span></code><div class="information">
                  <pre>[7, 8]
[6, 9]
[5, 10]
[4, 5, 6]
[3, 5, 7]
[3, 4, 8]
[2, 6, 7]
[2, 5, 8]
[2, 4, 9]
[2, 3, 10]
[2, 3, 4, 6]
[1, 6, 8]
[1, 5, 9]
[1, 4, 10]
[1, 3, 5, 6]
[1, 3, 4, 7]
[1, 2, 5, 7]
[1, 2, 4, 8]
[1, 2, 3, 9]
[1, 2, 3, 4, 5]
</pre></div>
                <div class="paragraph">
                  <p>
                    Returning to the arithmetic evaluator that produces multisets of results, the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-NeedsSearch.choose" data-verso-hover="932">choose</span></code> operator can be used to nondeterministically select a value, with division by zero rendering prior selections invalid.</p>
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.inductive-13067" data-verso-hover="96">inductive</span><span class="inter-text"> </span><span class="const token" data-binding="const-NeedsSearch" data-verso-hover="933">NeedsSearch</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-NeedsSearch.div" data-verso-hover="934">div</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-NeedsSearch.choose" data-verso-hover="932">choose</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-13109">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-applySearch" data-verso-hover="935">applySearch</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-NeedsSearch" data-verso-hover="933">NeedsSearch</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-NeedsSearch.choose" data-verso-hover="932">NeedsSearch.choose</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46739" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46740" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Many.fromList" data-verso-hover="919">Many.fromList</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.46739" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46740" data-verso-hover="27">y</span><span class="unknown token" data-binding="">]</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-NeedsSearch.div" data-verso-hover="934">NeedsSearch.div</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46770" data-verso-hover="27">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46771" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-13258" data-verso-hover="16">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46771" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">==</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">0</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-13258" data-verso-hover="16">then</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="const token" data-binding="const-Many.none" data-verso-hover="913">Many.none</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-13258" data-verso-hover="16">else</span><span class="inter-text"> </span><span class="const token" data-binding="const-Many.one" data-verso-hover="915">Many.one</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.46770" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">/</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.46771" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span></code></div>
                <div class="paragraph">
                  <p>
                    Using these operators, the earlier examples can be evaluated:</p>
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-13371" data-verso-hover="240">open</span><span class="inter-text"> </span><span class="unknown token" data-binding="">Expr</span><span class="inter-text"> </span><span class="unknown token" data-binding="">Prim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">NeedsSearch</span></code><code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">[3, 6]</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-13477" data-verso-hover="7">#eval</span></span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-evaluateM" data-verso-hover="901">evaluateM</span><span class="inter-text"> </span><span class="const token" data-binding="const-applySearch" data-verso-hover="935">applySearch</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.plus" data-verso-hover="895">plus</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">1</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Prim.other" data-verso-hover="898">other</span><span class="inter-text"> </span><span class="const token" data-binding="const-NeedsSearch.choose" data-verso-hover="932">choose</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">2</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">        </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">5</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Many.takeAll" data-verso-hover="921">takeAll</span></code><div class="information">
                    <pre>[3, 6]</pre></div>
                  <code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">[]</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-13674" data-verso-hover="7">#eval</span></span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-evaluateM" data-verso-hover="901">evaluateM</span><span class="inter-text"> </span><span class="const token" data-binding="const-applySearch" data-verso-hover="935">applySearch</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.plus" data-verso-hover="895">plus</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">1</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Prim.other" data-verso-hover="898">other</span><span class="inter-text"> </span><span class="const token" data-binding="const-NeedsSearch.div" data-verso-hover="934">div</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">2</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">        </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">0</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Many.takeAll" data-verso-hover="921">takeAll</span></code><div class="information">
                    <pre>[]</pre></div>
                  <code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">[9]</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-13869" data-verso-hover="7">#eval</span></span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-evaluateM" data-verso-hover="901">evaluateM</span><span class="inter-text"> </span><span class="const token" data-binding="const-applySearch" data-verso-hover="935">applySearch</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Prim.other" data-verso-hover="898">other</span><span class="inter-text"> </span><span class="const token" data-binding="const-NeedsSearch.div" data-verso-hover="934">div</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">90</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.plus" data-verso-hover="895">plus</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Prim.other" data-verso-hover="898">other</span><span class="inter-text"> </span><span class="const token" data-binding="const-NeedsSearch.choose" data-verso-hover="932">choose</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">-</span><span class="typed token" data-binding="" data-verso-hover="27">5</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">5</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">        </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">5</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Many.takeAll" data-verso-hover="921">takeAll</span></code><div class="information">
                    <pre>[9]</pre></div>
                  </div>
                </section>
              <section>
                <h3 id="custom-environments">
                  4.3.3.3. Custom Environments<span class="permalink-widget inline"><a href="find/?domain=Verso.Genre.Manual.section&name=custom-environments" title="Permalink">🔗</a></span></h3>
                <p>
                  The evaluator can be made user-extensible by allowing strings to be used as operators, and then providing a mapping from strings to a function that implements them.
For example, users could extend the evaluator with a remainder operator or with one that returns the maximum of its two arguments.
The mapping from function names to function implementations is called an <em>environment</em>.</p>
                <p>
                  The environments needs to be passed in each recursive call.
Initially, it might seem that <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Four.evaluateM" data-verso-hover="888">evaluateM</span></code> needs an extra argument to hold the environment, and that this argument should be passed to each recursive invocation.
However, passing an argument like this is another form of monad, so an appropriate <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code> instance allows the evaluator to be used unchanged.</p>
                <p>
                  Using functions as a monad is typically called a <em>reader</em> monad.
When evaluating expressions in the reader monad, the following rules are used:</p>
                <ul>
                  <li>
                    <p>
                      Constants <code class="math inline">n</code> evaluate to constant functions <code class="math inline">λ e . n</code>,</p>
                    </li>
                  <li>
                    <p>
                      Arithmetic operators evaluate to functions that pass their arguments on, so <code class="math inline">f + g</code> evaluates to <code class="math inline">λ e . f(e) + g(e)</code>, and</p>
                    </li>
                  <li>
                    <p>
                      Custom operators evaluate to the result of applying the custom operator to the arguments, so <code class="math inline">f \ \mathrm{OP}\ g</code> evaluates to
   <code class="math display">
     λ e .
     \begin{cases}
     h(f(e), g(e)) & \mathrm{if}\ e\ \mathrm{contains}\ (\mathrm{OP}, h) \\
     0 & \mathrm{otherwise}
     \end{cases}
   </code>
   with <code class="math inline">0</code> serving as a fallback in case an unknown operator is applied.</p>
                    </li>
                  </ul>
                <div class="paragraph">
                  <p>
                    To define the reader monad in Lean, the first step is to define the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span></code> type and the effect that allows users to get ahold of the environment:</p>
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-14469">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.55831" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.55833" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55831" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55833" data-verso-hover="113">α</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-14525">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-read" data-verso-hover="937">read</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55847" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55847" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-14552">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55854" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55854" data-verso-hover="938">env</span></code><p>
                    By convention, the Greek letter <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.55831" data-verso-hover="113">ρ</span></code>, which is pronounced “rho”, is used for environments.</p>
                  </div>
                <div class="paragraph">
                  <p>
                    The fact that constants in arithmetic expressions evaluate to constant functions suggests that the appropriate definition of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Pure.pure" data-verso-hover="859">pure</span></code> for <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span></code> is a a constant function:</p>
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-17686">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader.pure" data-verso-hover="939">Reader.pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.56399" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56391" data-verso-hover="113">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56397" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56391" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-17729">fun</span><span class="inter-text"> </span><span class="unknown token" data-binding="">_</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56399" data-verso-hover="121">x</span></code></div>
                <p>
                  On the other hand, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Bind.bind" data-verso-hover="864">bind</span></code> is a bit tricker.
Its type is <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56313" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56309" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.56309" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56313" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56311" data-verso-hover="113">β</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56313" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56311" data-verso-hover="113">β</span></code>.
This type can be easier to understand by unfolding the definition of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span></code>, which yields <code class="hl lean inline" data-lean-context="examples"><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.56313" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56309" data-verso-hover="113">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.56309" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56313" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56311" data-verso-hover="113">β</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.56313" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56311" data-verso-hover="113">β</span><span class="unknown token" data-binding="">)</span></code>.
It should take an environment-accepting function as its first argument, while the second argument should transform the result of the environment-accepting function into yet another environment-accepting function.
The result of combining these is itself a function, waiting for an environment.</p>
                <p>
                  It's possible to use Lean interactively to get help writing this function.
The first step is to write down the arguments and return type, being very explicit in order to get as much help as possible, with an underscore for the definition's body:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-14792">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Temp.Reader.bind" data-verso-hover="940">Reader.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.55863" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.55865" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.55867" data-verso-hover="113">β</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">}</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.55871" data-verso-hover="941">result</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55863" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55865" data-verso-hover="113">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.55877" data-verso-hover="942">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55865" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55863" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55867" data-verso-hover="113">β</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55863" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55867" data-verso-hover="113">β</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="has-info error"><span class="hover-container"><span class="hover-info messages"><code class="message error">don't know how to synthesize placeholder
context:
ρ α β : Type
result : ρ → α
next : α → ρ → β
⊢ ρ → β</code></span></span><span class="unknown token" data-binding="">_</span></span></code><p>
                  Lean provides a message that describes which variables are available in scope, and the type that's expected for the result.
The <code>⊢</code> symbol, called a <span id="--tech-term-turnstile" class="def-technical-term"><em>turnstile</em></span> due to its resemblance to subway entrances, separates the local variables from the desired type, which is <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.55863" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55867" data-verso-hover="113">β</span></code> in this message:</p>
                <div class="error">
                  <pre>don't know how to synthesize placeholder
context:
ρ α β : Type
result : ρ → α
next : α → ρ → β
⊢ ρ → β</pre></div>
                <p>
                  Because the return type is a function, a good first step is to wrap a <code class="hl lean inline" data-lean-context="examples"><span class="keyword token" data-binding="">fun</span></code> around the underscore:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-15144">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Temp.Reader.bind" data-verso-hover="940">Reader.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.55919" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.55921" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.55923" data-verso-hover="113">β</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">}</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.55927" data-verso-hover="941">result</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55919" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55921" data-verso-hover="113">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.55933" data-verso-hover="942">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55921" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55919" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55923" data-verso-hover="113">β</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55919" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55923" data-verso-hover="113">β</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-15262">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55954" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="has-info error"><span class="hover-container"><span class="hover-info messages"><code class="message error">don't know how to synthesize placeholder
context:
ρ α β : Type
result : ρ → α
next : α → ρ → β
env : ρ
⊢ β</code></span></span><span class="unknown token" data-binding="">_</span></span></code><p>
                  The resulting message now shows the function's argument as a local variable:</p>
                <div class="error">
                  <pre>don't know how to synthesize placeholder
context:
ρ α β : Type
result : ρ → α
next : α → ρ → β
env : ρ
⊢ β</pre></div>
                <p>
                  The only thing in the context that can produce a <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.55984" data-verso-hover="113">β</span></code> is <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.55994" data-verso-hover="942">next</span></code>, and it will require two arguments to do so.
Each argument can itself be an underscore:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-15644">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Temp.Reader.bind" data-verso-hover="940">Reader.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.55980" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.55982" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.55984" data-verso-hover="113">β</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">}</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.55988" data-verso-hover="941">result</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55980" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55982" data-verso-hover="113">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.55994" data-verso-hover="942">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55982" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55980" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55984" data-verso-hover="113">β</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55980" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55984" data-verso-hover="113">β</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-15762">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56015" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.55994" data-verso-hover="942">next</span><span class="inter-text"> </span><span class="has-info error"><span class="hover-container"><span class="hover-info messages"><code class="message error">don't know how to synthesize placeholder
context:
ρ α β : Type
result : ρ → α
next : α → ρ → β
env : ρ
⊢ α</code></span></span><span class="unknown token" data-binding="">_</span></span><span class="inter-text"> </span><span class="has-info error"><span class="hover-container"><span class="hover-info messages"><code class="message error">don't know how to synthesize placeholder
context:
ρ α β : Type
result : ρ → α
next : α → ρ → β
env : ρ
⊢ ρ</code></span></span><span class="unknown token" data-binding="">_</span></span></code><p>
                  The two underscores have the following respective messages associated with them:</p>
                <div class="error">
                  <pre>don't know how to synthesize placeholder
context:
ρ α β : Type
result : ρ → α
next : α → ρ → β
env : ρ
⊢ α</pre></div>
                <div class="error">
                  <pre>don't know how to synthesize placeholder
context:
ρ α β : Type
result : ρ → α
next : α → ρ → β
env : ρ
⊢ ρ</pre></div>
                <div class="paragraph">
                  <p>
                    Attacking the first underscore, only one thing in the context can produce an <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.56110" data-verso-hover="113">α</span></code>, namely <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.56116" data-verso-hover="941">result</span></code>:</p>
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-16659">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Temp.Reader.bind" data-verso-hover="940">Reader.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.56108" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.56110" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.56112" data-verso-hover="113">β</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">}</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.56116" data-verso-hover="941">result</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56108" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56110" data-verso-hover="113">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.56122" data-verso-hover="942">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56110" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56108" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56112" data-verso-hover="113">β</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56108" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56112" data-verso-hover="113">β</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-16777">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56143" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56122" data-verso-hover="942">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.56116" data-verso-hover="941">result</span><span class="inter-text"> </span><span class="has-info error"><span class="hover-container"><span class="hover-info messages"><code class="message error">don't know how to synthesize placeholder
context:
ρ α β : Type
result : ρ → α
next : α → ρ → β
env : ρ
⊢ ρ</code></span></span><span class="unknown token" data-binding="">_</span></span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="has-info error"><span class="hover-container"><span class="hover-info messages"><code class="message error">don't know how to synthesize placeholder
context:
ρ α β : Type
result : ρ → α
next : α → ρ → β
env : ρ
⊢ ρ</code></span></span><span class="unknown token" data-binding="">_</span></span></code><p>
                    Now, both underscores have the same error message:</p>
                  <div class="error">
                    <pre>don't know how to synthesize placeholder
context:
ρ α β : Type
result : ρ → α
next : α → ρ → β
env : ρ
⊢ ρ</pre></div>
                  </div>
                <div class="paragraph">
                  <p>
                    Happily, both underscores can be replaced by <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.56207" data-verso-hover="938">env</span></code>, yielding:</p>
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-16873">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Temp.Reader.bind" data-verso-hover="940">Reader.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.56172" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.56174" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.56176" data-verso-hover="113">β</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">}</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.56180" data-verso-hover="941">result</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56172" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56174" data-verso-hover="113">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.56186" data-verso-hover="942">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56174" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56172" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56176" data-verso-hover="113">β</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56172" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56176" data-verso-hover="113">β</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-16991">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56207" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56186" data-verso-hover="942">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.56180" data-verso-hover="941">result</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56207" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56207" data-verso-hover="938">env</span></code></div>
                <p>
                  The final version can be obtained by undoing the unfolding of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span></code> and cleaning up the explicit details:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-17085">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.56250" data-verso-hover="944">result</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56236" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56240" data-verso-hover="113">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.56254" data-verso-hover="945">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56240" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56236" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56248" data-verso-hover="113">β</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56236" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56248" data-verso-hover="113">β</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-17182">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56271" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56254" data-verso-hover="945">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.56250" data-verso-hover="944">result</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56271" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56271" data-verso-hover="938">env</span></code><p>
                  It's not always possible to write correct functions by simply “following the types”, and it carries the risk of not understanding the resulting program.
However, it can also be easier to understand a program that has been written than one that has not, and the process of filling in the underscores can bring insights.
In this case, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span></code> works just like <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Bind.bind" data-verso-hover="860">bind</span></code> for <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-IdentMonad.Id" data-verso-hover="858">Id</span></code>, except it accepts an additional argument that it then passes down to its arguments, and this intuition can help in understanding how it works.</p>
                <p>
                  <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader.pure" data-verso-hover="939">Reader.pure</span></code> (which generates constant functions) and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span></code> obey the monad contract.
To check that <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Reader.pure" data-verso-hover="939">Reader.pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57354" data-verso-hover="121">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span></code> is the same as <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57354" data-verso-hover="121">v</span></code>, it's enough to replace definitions until the last step:</p>
                <div class="eval-steps">
                  <code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Reader.pure" data-verso-hover="939">Reader.pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57354" data-verso-hover="121">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span></code><code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-18194">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56629" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Reader.pure" data-verso-hover="939">Reader.pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57354" data-verso-hover="121">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56629" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56629" data-verso-hover="938">env</span></code><code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-18238">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56663" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-18253">fun</span><span class="inter-text"> </span><span class="unknown token" data-binding="">_</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57354" data-verso-hover="121">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56663" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56663" data-verso-hover="938">env</span></code><code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-18279">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56698" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57354" data-verso-hover="121">v</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56698" data-verso-hover="938">env</span></code><code class="hl lean block" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57354" data-verso-hover="121">v</span></code></div>
                <p>
                  For every function <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.56438" data-verso-hover="565">f</span></code>, <code class="hl lean inline" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-17827">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56458" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56438" data-verso-hover="565">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56458" data-verso-hover="121">x</span></code> is the same as <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.56438" data-verso-hover="565">f</span></code>, so the first part of the contract is satisfied.
To check that <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader.pure" data-verso-hover="939">Reader.pure</span></code> is the same as <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span></code>, a similar technique works:</p>
                <div class="eval-steps">
                  <code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader.pure" data-verso-hover="939">Reader.pure</span></code><code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-18450">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56853" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader.pure" data-verso-hover="939">Reader.pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56853" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56853" data-verso-hover="938">env</span></code><code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-18490">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56885" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-18502">fun</span><span class="inter-text"> </span><span class="unknown token" data-binding="">_</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56885" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56885" data-verso-hover="938">env</span></code><code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-18529">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56882" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.56882" data-verso-hover="938">env</span></code></div>
                <p>
                  Because reader actions <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span></code> are themselves functions, this is the same as <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span></code>.
To check associativity, the same thing can be done for both <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57365" data-verso-hover="946">g</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-18964">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57234" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57234" data-verso-hover="121">x</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57365" data-verso-hover="946">g</span><span class="unknown token" data-binding="">)</span></code>:</p>
                <div class="eval-steps">
                  <code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57365" data-verso-hover="946">g</span></code><code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-18697">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57053" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57365" data-verso-hover="946">g</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57053" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57053" data-verso-hover="938">env</span></code><code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-18743">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57095" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57365" data-verso-hover="946">g</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-18758">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57098" data-verso-hover="938">env'</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57098" data-verso-hover="938">env'</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57098" data-verso-hover="938">env'</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57095" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57095" data-verso-hover="938">env</span></code><code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-18801">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57092" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57365" data-verso-hover="946">g</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57092" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57092" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57092" data-verso-hover="938">env</span></code></div>
                <p>
                  <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-18964">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57234" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57234" data-verso-hover="121">x</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57365" data-verso-hover="946">g</span><span class="unknown token" data-binding="">)</span></code> reduces to the same expression:</p>
                <div class="eval-steps">
                  <code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-18964">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57234" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57234" data-verso-hover="121">x</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57365" data-verso-hover="946">g</span><span class="unknown token" data-binding="">)</span></code><code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Reader.bind" data-verso-hover="943">Reader.bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-19014">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57292" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-19023">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57295" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57365" data-verso-hover="946">g</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57292" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57295" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57295" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span></code><code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-19056">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57334" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-19068">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57337" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-19077">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57340" data-verso-hover="938">env'</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57365" data-verso-hover="946">g</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57337" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57340" data-verso-hover="938">env'</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57340" data-verso-hover="938">env'</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57334" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57334" data-verso-hover="938">env</span></code><code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-19125">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57372" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-19137">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57375" data-verso-hover="938">env'</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57365" data-verso-hover="946">g</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57372" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57375" data-verso-hover="938">env'</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57375" data-verso-hover="938">env'</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57372" data-verso-hover="938">env</span></code><code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-19183">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57369" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57365" data-verso-hover="946">g</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57360" data-verso-hover="945">f</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57356" data-verso-hover="944">r</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57369" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57369" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57369" data-verso-hover="938">env</span></code></div>
                <p>
                  Thus, a <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57492" data-verso-hover="113">ρ</span><span class="unknown token" data-binding="">)</span></code> instance is justified:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.instance-19310">instance</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57492" data-verso-hover="113">ρ</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.whereStructInst-19339">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="947">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57554" data-verso-hover="584">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-19357">fun</span><span class="inter-text"> </span><span class="unknown token" data-binding="">_</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57554" data-verso-hover="584">x</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Bind.bind" data-verso-hover="948">bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57652" data-verso-hover="949">x</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57655" data-verso-hover="950">f</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-19382">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57660" data-verso-hover="938">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57655" data-verso-hover="950">f</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57652" data-verso-hover="949">x</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57660" data-verso-hover="938">env</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.57660" data-verso-hover="938">env</span></code><p>
                  The custom environments that will be passed to the expression evaluator can be represented as lists of pairs:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.abbrev-20024">abbrev</span><span class="inter-text"> </span><span class="const token" data-binding="const-Env" data-verso-hover="951">Env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-List" data-verso-hover="111">List</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="inter-text"> </span><span class="unknown token" data-binding="">×</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span></code><p>
                  For instance, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-exampleEnv" data-verso-hover="952">exampleEnv</span></code> contains maximum and modulus functions:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-20356">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-exampleEnv" data-verso-hover="952">exampleEnv</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Env" data-verso-hover="951">Env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">(</span><span class="literal string token" data-binding="" data-verso-hover="953">"max"</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="const token" data-binding="const-Max.max" data-verso-hover="954">max</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="literal string token" data-binding="" data-verso-hover="955">"mod"</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">·</span><span class="inter-text"> </span><span class="unknown token" data-binding="">%</span><span class="inter-text"> </span><span class="unknown token" data-binding="">·</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">]</span></code><p>
                  Lean already has a function <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-List.lookup" data-verso-hover="956">List.lookup</span></code> that finds the value associated with a key in a list of pairs, so <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-applyPrimReader" data-verso-hover="957">applyPrimReader</span></code> needs only check whether the custom function is present in the environment. It returns <code class="hl lean inline" data-lean-context="examples"><span class="typed token" data-binding="" data-verso-hover="27">0</span></code> if the function is unknown:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-20132">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-applyPrimReader" data-verso-hover="957">applyPrimReader</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.65716" data-verso-hover="39">op</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.65718" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.65720" data-verso-hover="27">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span><span class="inter-text"> </span><span class="const token" data-binding="const-Env" data-verso-hover="951">Env</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-read" data-verso-hover="937">read</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-20217">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.65832" data-verso-hover="958">env</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.match-20230" data-verso-hover="100">match</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.65832" data-verso-hover="958">env</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-List.lookup" data-verso-hover="956">lookup</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.65716" data-verso-hover="39">op</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.match-20230" data-verso-hover="100">with</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="145">none</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">0</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.some" data-verso-hover="146">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.65972" data-verso-hover="959">f</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.65972" data-verso-hover="959">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.65718" data-verso-hover="27">x</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.65720" data-verso-hover="27">y</span><span class="unknown token" data-binding="">)</span></code><p>
                  Using <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-evaluateM" data-verso-hover="901">evaluateM</span></code> with <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-applyPrimReader" data-verso-hover="957">applyPrimReader</span></code> and an expression results in a function that expects an environment.
Luckily, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-exampleEnv" data-verso-hover="952">exampleEnv</span></code> is available:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-20494" data-verso-hover="240">open</span><span class="inter-text"> </span><span class="unknown token" data-binding="">Expr</span><span class="inter-text"> </span><span class="unknown token" data-binding="">Prim</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.in-20494">in</span><span class="inter-text">
</span><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">9</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-20512" data-verso-hover="7">#eval</span></span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-evaluateM" data-verso-hover="901">evaluateM</span><span class="inter-text"> </span><span class="const token" data-binding="const-applyPrimReader" data-verso-hover="957">applyPrimReader</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Prim.other" data-verso-hover="898">other</span><span class="inter-text"> </span><span class="literal string token" data-binding="" data-verso-hover="953">"max"</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.plus" data-verso-hover="895">plus</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">5</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">4</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.times" data-verso-hover="897">times</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">3</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">        </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">2</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-exampleEnv" data-verso-hover="952">exampleEnv</span></code><div class="information">
                  <pre>9</pre></div>
                <p>
                  Like <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Many" data-verso-hover="912">Many</span></code>, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span></code> is an example of an effect that is difficult to encode in most languages, but type classes and monads make it just as convenient as any other effect.
The dynamic or special variables found in Common Lisp, Clojure, and Emacs Lisp can be used like <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span></code>.
Similarly, Scheme and Racket's parameter objects are an effect that exactly correspond to <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Reader" data-verso-hover="936">Reader</span></code>.
The Kotlin idiom of context objects can solve a similar problem, but they are fundamentally a means of passing function arguments automatically, so this idiom is more like the encoding as a reader monad than it is an effect in the language.</p>
                </section>
              <section>
                <h3 id="Functional-Programming-in-Lean--Monads--Example___-Arithmetic-in-Monads--Further-Effects--Exercises">
                  4.3.3.4. Exercises</h3>
                <section>
                  <h4 id="Functional-Programming-in-Lean--Monads--Example___-Arithmetic-in-Monads--Further-Effects--Exercises--Checking-Contracts">
                    4.3.3.4.1. Checking Contracts</h4>
                  <p>
                    Check the monad contract for <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monads.State.State" data-verso-hover="802">State</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12820" data-verso-hover="113">σ</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.392" data-verso-hover="369">ε</span></code>.</p>
                  </section>
                <section>
                  <h4 id="Functional-Programming-in-Lean--Monads--Example___-Arithmetic-in-Monads--Further-Effects--Exercises--Readers-with-Failure">
                    4.3.3.4.2. Readers with Failure</h4>
                  <p>
                    Adapt the reader monad example so that it can also indicate failure when the custom operator is not defined, rather than just returning zero.
In other words, given these definitions:</p>
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-22594">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Exercises.ReaderOption" data-verso-hover="960">ReaderOption</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.72068" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.72070" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.72068" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.72070" data-verso-hover="113">α</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-22663">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Exercises.ReaderExcept" data-verso-hover="961">ReaderExcept</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.72083" data-verso-hover="113">ε</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.72085" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.72087" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.72085" data-verso-hover="113">ρ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.72083" data-verso-hover="113">ε</span><span class="inter-text"> </span><span class="unknown token" data-binding="">α</span></code><p>
                    do the following:</p>
                  <ol start="1">
                    <li>
                      <p>
                        Write suitable <code>pure</code> and <code>bind</code> functions</p>
                      </li>
                    <li>
                      <p>
                        Check that these functions satisfy the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code> contract</p>
                      </li>
                    <li>
                      <p>
                        Write <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code> instances for <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Exercises.ReaderOption" data-verso-hover="960">ReaderOption</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Exercises.ReaderExcept" data-verso-hover="961">ReaderExcept</span></code></p>
                      </li>
                    <li>
                      <p>
                        Define suitable <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.31385" data-verso-hover="885">applyPrim</span></code> operators and test them with <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Four.evaluateM" data-verso-hover="888">evaluateM</span></code> on some example expressions</p>
                      </li>
                    </ol>
                  </section>
                <section>
                  <h4 id="Functional-Programming-in-Lean--Monads--Example___-Arithmetic-in-Monads--Further-Effects--Exercises--A-Tracing-Evaluator">
                    4.3.3.4.3. A Tracing Evaluator</h4>
                  <p>
                    The <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monads.Writer.WithLog" data-verso-hover="776">WithLog</span></code> type can be used with the evaluator to add optional tracing of some operations.
In particular, the type <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Exercises.ToTrace" data-verso-hover="962">ToTrace</span></code> can serve as a signal to trace a given operator:</p>
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.inductive-21647" data-verso-hover="96">inductive</span><span class="inter-text"> </span><span class="const token" data-binding="const-Exercises.ToTrace" data-verso-hover="962">ToTrace</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.68957" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="sort token" data-binding="" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-21684">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Exercises.ToTrace.trace" data-verso-hover="963">trace</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.68957" data-verso-hover="113">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Exercises.ToTrace" data-verso-hover="962">ToTrace</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.68957" data-verso-hover="113">α</span></code><p>
                    For the tracing evaluator, expressions should have type <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Expr" data-verso-hover="869">Expr</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Prim" data-verso-hover="894">Prim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Exercises.ToTrace" data-verso-hover="962">ToTrace</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Prim" data-verso-hover="894">Prim</span><span class="inter-text"> </span><span class="const token" data-binding="const-Empty" data-verso-hover="185">Empty</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span></code>.
This says that the operators in the expression consist of addition, subtraction, and multiplication, augmented with traced versions of each. The innermost argument is <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Empty" data-verso-hover="185">Empty</span></code> to signal that there are no further special operators inside of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Exercises.ToTrace.trace" data-verso-hover="963">trace</span></code>, only the three basic ones.</p>
                  <p>
                    Do the following:</p>
                  <ol start="1">
                    <li>
                      <p>
                        Implement a <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Monads.Writer.WithLog" data-verso-hover="776">WithLog</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.16435" data-verso-hover="113">logged</span><span class="unknown token" data-binding="">)</span></code> instance</p>
                      </li>
                    <li>
                      <p>
                        Write an <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Exercises.applyTraced" data-verso-hover="964">applyTraced</span></code> function to apply traced operators to their arguments, logging both the operator and the arguments, with type <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Exercises.ToTrace" data-verso-hover="962">ToTrace</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Prim" data-verso-hover="894">Prim</span><span class="inter-text"> </span><span class="const token" data-binding="const-Empty" data-verso-hover="185">Empty</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Monads.Writer.WithLog" data-verso-hover="776">WithLog</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Prim" data-verso-hover="894">Prim</span><span class="inter-text"> </span><span class="const token" data-binding="const-Empty" data-verso-hover="185">Empty</span><span class="inter-text"> </span><span class="unknown token" data-binding="">×</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">×</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span></code></p>
                      </li>
                    </ol>
                  <p>
                    If the exercise has been completed correctly, then</p>
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-22331" data-verso-hover="240">open</span><span class="inter-text"> </span><span class="unknown token" data-binding="">Expr</span><span class="inter-text"> </span><span class="unknown token" data-binding="">Prim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">ToTrace</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.in-22331">in</span><span class="inter-text">
</span><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">{ log := [(Prim.plus, 1, 2), (Prim.minus, 3, 4), (Prim.times, 3, -1)], val := -3 }</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-22357" data-verso-hover="7">#eval</span></span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-evaluateM" data-verso-hover="901">evaluateM</span><span class="inter-text"> </span><span class="const token" data-binding="const-Exercises.applyTraced" data-verso-hover="964">applyTraced</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Prim.other" data-verso-hover="898">other</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Exercises.ToTrace.trace" data-verso-hover="963">trace</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.times" data-verso-hover="897">times</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Prim.other" data-verso-hover="898">other</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Exercises.ToTrace.trace" data-verso-hover="963">trace</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.plus" data-verso-hover="895">plus</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">1</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">        </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">2</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.prim" data-verso-hover="871">prim</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Prim.other" data-verso-hover="898">other</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Exercises.ToTrace.trace" data-verso-hover="963">trace</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim.minus" data-verso-hover="896">minus</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">3</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">        </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Expr.const" data-verso-hover="870">const</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">4</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span></code><p>
                    should result in</p>
                  <div class="information">
                    <pre>{ log := [(Prim.plus, 1, 2), (Prim.minus, 3, 4), (Prim.times, 3, -1)], val := -3 }</pre></div>
                  <p>
                    Hint: values of type <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Prim" data-verso-hover="894">Prim</span><span class="inter-text"> </span><span class="const token" data-binding="const-Empty" data-verso-hover="185">Empty</span></code> will appear in the resulting log. In order to display them as a result of <code class="hl lean inline" data-lean-context="examples"><span class="keyword token" data-binding="">#eval</span></code>, the following instances are required:</p>
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.deriving-21498">deriving</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.deriving-21498">instance</span><span class="inter-text"> </span><span class="const token" data-binding="const-Repr" data-verso-hover="64">Repr</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.deriving-21498">for</span><span class="inter-text"> </span><span class="const token" data-binding="const-Monads.Writer.WithLog" data-verso-hover="776">WithLog</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.deriving-21533">deriving</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.deriving-21533">instance</span><span class="inter-text"> </span><span class="const token" data-binding="const-Repr" data-verso-hover="64">Repr</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.deriving-21533">for</span><span class="inter-text"> </span><span class="const token" data-binding="const-Empty" data-verso-hover="185">Empty</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.deriving-21566">deriving</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.deriving-21566">instance</span><span class="inter-text"> </span><span class="const token" data-binding="const-Repr" data-verso-hover="64">Repr</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.deriving-21566">for</span><span class="inter-text"> </span><span class="const token" data-binding="const-Prim" data-verso-hover="894">Prim</span></code></section>
                </section>
              </section>
            </section>
          <nav class="prev-next-buttons">
            <a class="local-button active" href="Monads/The-Monad-Type-Class/#Functional-Programming-in-Lean--Monads--The-Monad-Type-Class" rel="prev" title="4.2. The Monad Type Class"><span class="arrow">←</span><span class="where">4.2. The Monad Type Class</span></a><a class="local-button active" href="Monads/do--Notation-for-Monads/#Functional-Programming-in-Lean--Monads--do--Notation-for-Monads" rel="next" title="4.4. do-Notation for Monads"><span class="where">4.4. do-Notation for Monads</span><span class="arrow">→</span></a></nav>
          </div>
        </main></div>
    </body>
  </html>

