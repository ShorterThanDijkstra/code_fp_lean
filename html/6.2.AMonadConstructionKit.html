<!DOCTYPE html>
<html>
  <head>
    <script>
      (function(){
  const {protocol:proto, host:hostName, pathname:path, search:srch, hash:hsh} = window.location;
  if (!(path.endsWith("/") || path.endsWith(".html"))) {
    window.location.replace(`${proto}//${hostName}${path}/${srch}${hsh}`);
  }
})()</script>
    <base href="./../../"><meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <title>A Monad Construction Kit</title><link rel="stylesheet" href="book.css">
    <script>
      const __versoSiteRoot = document.baseURI;</script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js" integrity="sha384-zbcZAIxlvJtNE3Dp5nxLXdXtXyxwOdnILY1TDPVmKFhl4r4nSUG1r8bcFXGVa4Te" crossorigin="anonymous"></script>
    <script src="-verso-data/katex/katex.js"></script>
    <script src="-verso-data/katex/math.js"></script>
    <script src="-verso-data/popper.js"></script>
    <script src="-verso-data/tippy.js"></script>
    <link rel="stylesheet" href="static/theme.css">
    <link rel="stylesheet" href="static/fonts/source-serif/source-serif-text.css">
    <link rel="stylesheet" href="static/fonts/source-code-pro/source-code-pro.css">
    <link rel="stylesheet" href="static/fonts/source-sans/source-sans-3.css">
    <link rel="stylesheet" href="static/fonts/noto-sans-mono/noto-sans-mono.css">
    <link rel="stylesheet" href="-verso-data/katex/katex.css">
    <link rel="stylesheet" href="-verso-data/tippy-border.css">
    <style>
div.paragraph > .eval-steps:not(:first-child), div.paragraph > .eval-steps:not(:first-child) > * {
  margin-top: 0.5rem;
}

div.paragraph > .eval-steps:not(:last-child), div.paragraph > .eval-steps:not(:last-child) > * {
  margin-bottom: 0.5rem;
}

.eval-steps .hl.lean.block {
  margin-top: 0.25em;
  margin-bottom: 0.25em;
}
</style><style>
.shell-command {

}
.shell-command.inline > * {
  display: inline;
  white-space: pre;
}
.shell-command.inline .command::before {
  content: "$ ";
  font-weight: 600;
}
</style><style>
.shell-command {

}
.shell-command.block > * {
  display: block;
  white-space: pre;
}
.shell-command .command .prompt {
  font-weight: 600;
}

div.paragraph > .shell-command:not(:first-child) {
  margin-top: 0.5rem;
}

div.paragraph > .shell-command:not(:last-child) {
  margin-bottom: 0.5rem;
}
</style><style>

.hl.lean {
  white-space: pre;
  font-weight: normal;
  font-style: normal;
}

.hl.lean .keyword {
  font-weight : bold;
}

.hl.lean .var {
  font-style: italic;
  position: relative;
}

.hover-container {
  width: 0;
  height: 0;
  position: relative;
  display: inline;
}

.hl.lean a {
  color: inherit;
  text-decoration: currentcolor underline dotted;
}

.hl.lean a:hover {
  text-decoration: currentcolor underline solid;
}

.hl.lean .hover-info {
  white-space: normal;
}

.hl.lean .token .hover-info {
  display: none;
  position: absolute;
  background-color: #e5e5e5;
  border: 1px solid black;
  padding: 0.5rem;
  z-index: 300;
  font-size: inherit;
}

.hl.lean .hover-info.messages {
  max-height: 10rem;
  overflow-y: auto;
  overflow-x: hidden;
  scrollbar-gutter: stable;
  padding: 0 0.5rem 0 0;
  display: block;
}

.hl.lean .hover-info code {
  white-space: pre-wrap;
}

.hl.lean .hover-info.messages > code {
  padding: 0.5rem;
  display: block;
  width: fit-content;
}

.hl.lean .hover-info.messages > code:only-child {
  margin: 0;
}

.hl.lean .hover-info.messages > code {
  margin: 0.1rem;
}

.hl.lean .hover-info.messages > code:not(:first-child) {
  margin-top: 0rem;
}

/*
@media (hover: hover) {
  .hl.lean .has-info:hover > .hover-container > .hover-info:not(.tactic *),
  .hl.lean .tactic:has(> .tactic-toggle:checked) .has-info:hover > .hover-container > .hover-info,
  .hl.lean .token:hover > .hover-container > .hover-info:not(.has-info *):not(.tactic *),
  .hl.lean .tactic:has(> .tactic-toggle:checked) .token:hover > .hover-container > .hover-info:not(.has-info *) {
    display: inline-block;
    position: absolute;
    top: 1rem;
    font-weight: normal;
    font-style: normal;
    width: min-content;
  }
}
*/

.hl.lean.block {
  display: block;
}

.hl.lean.inline {
  display: inline;
  white-space: pre-wrap;
}

.hl.lean .token {
  transition: all 0.25s; /* Slight fade for highlights */
}

@media (hover: hover) {
  .hl.lean .token.binding-hl, .hl.lean .literal.string:hover, .hl.lean .token.typed:hover {
    background-color: #eee;
    border-radius: 2px;
    transition: none;
  }
}


.hl.lean .has-info .token:not(.tactic-state):not(.tactic-state *), .hl.lean .has-info .inter-text:not(.tactic-state):not(.tactic-state *) {
  text-decoration-style: wavy;
  text-decoration-line: underline;
  text-decoration-thickness: from-font;
}

.hl.lean .has-info .hover-info {
  display: none;
  position: absolute;
  transform: translate(0.25rem, 0.3rem);
  border: 1px solid black;
  padding: 0.5rem;
  z-index: 400;
  text-align: left;
}

.hl.lean .has-info.error :not(.tactic-state):not(.tactic-state *){
  text-decoration-color: red;
}

@media (hover: hover) {
  .hl.lean .has-info.error:hover {
    background-color: #ffb3b3;
  }
}

.hl.lean .hover-info.messages > code.error {
  background-color: #e5e5e5;
  border-left: 0.2rem solid #ffb3b3;
}

.tippy-box[data-theme~='error'] .hl.lean .hover-info.messages > code.error {
  background: none;
  border: none;
}

.error pre {
    color: red;
}

.hl.lean .has-info.warning :not(.tactic-state):not(.tactic-state *) {
  text-decoration-color: var(--verso-warning-color);
}

@media (hover: hover) {
  .hl.lean .has-info.warning:hover {
    background-color:var(--verso-warning-color);
  }
}

.hl.lean .hover-info.messages > code.warning {
  background-color: var(--verso-warning-color);
}

.hl.lean .hover-info.messages > code.error {
  background-color: #e5e5e5;
  border-left: 0.2rem solid var(--verso-warning-color);
}

.tippy-box[data-theme~='warning'] .hl.lean .hover-info.messages > code.warning {
  background: none;
  border: none;
}


.hl.lean .has-info.info :not(.tactic-state):not(.tactic-state *) {
  text-decoration-color: blue;
}

@media (hover: hover) {
  .hl.lean .has-info.info:hover {
    background-color: #4777ff;
  }
}


.hl.lean .hover-info.messages > code.info {
  background-color: #e5e5e5;
  border-left: 0.2rem solid #4777ff;
}

.tippy-box[data-theme~='info'] .hl.lean .hover-info.messages > code.info {
  background: none;
  border: none;
}

.hl.lean div.docstring {
  font-family: sans-serif;
  white-space: normal;
  max-width: 40rem;
  width: max-content;
}

.hl.lean div.docstring > :last-child {
  margin-bottom: 0;
}

.hl.lean div.docstring > :first-child {
  margin-top: 0;
}

.hl.lean .hover-info .sep {
  display: block;
  width: auto;
  margin-left: 1rem;
  margin-right: 1rem;
  margin-top: 0.5rem;
  margin-bottom: 0.5rem;
  padding: 0;
  height: 1px;
  border-top: 1px solid #ccc;
}

.hl.lean code {
  font-family: monospace;
}

.hl.lean .tactic-state {
  display: none;
  position: relative;
  left: 2rem;
  width: fit-content;
  border: 1px solid #888888;
  border-radius: 0.1rem;
  padding: 0.5rem;
  font-family: sans-serif;
  background-color: #ffffff;
  z-index: 200;
}

.hl.lean.popup .tactic-state {
  position: static;
  display: block;
  width: auto;
  border: none;
  padding: 0.5rem;
  font-family: sans-serif;
  background-color: #ffffff;
}


.hl.lean .tactic {
  position: relative;
}

.hl.lean .tactic-toggle:checked ~ .tactic-state {
  display: block;
}

/*
@media (hover: hover) {
  .hl.lean .tactic:hover > .tactic-toggle:not(:checked) ~ .tactic-state {
    display: block;
    position: absolute;
    left: 0;
    transform: translate(0.25rem, 0);
    z-index: 250;
  }
}
*/

.hl.lean .tactic > label {
  position: relative;
  transition: all 0.5s;
}

@media (hover: hover) {
  .hl.lean .tactic > label:hover {
    border-bottom: 1px dotted #bbbbbb;
  }
}

.hl.lean .tactic-toggle {
  position: absolute;
  top: 0;
  left: 0;
  opacity: 0;
  height: 0;
  width: 0;
  z-index: -10;
}

.hl.lean .tactic > label::after {
  content: "";
  border: 1px solid #bbbbbb;
  border-radius: 1rem;
  height: 0.25rem;
  vertical-align: middle;
  width: 0.6rem;
  margin-left: 0.1rem;
  margin-right: 0.1rem;
  display: inline-block;
  transition: all 0.5s;
}

/*
@media (hover: hover) {
  .hl.lean .tactic > label:hover::after {
    border: 1px solid #aaaaaa;
    background-color: #aaaaaa;
    transition: all 0.5s;
  }
}
*/

.hl.lean .tactic > label:has(+ .tactic-toggle:checked)::after {
  border: 1px solid #999999;
  background-color: #999999;
  transition: all 0.5s;
}

.hl.lean .tactic-state .goal + .goal {
  margin-top: 1.5rem;
}

.hl.lean .tactic-state summary {
  margin-left: -0.5rem;
}

.hl.lean .tactic-state details {
  padding-left: 0.5rem;
}

.hl.lean .case-label {
  display: block;
  position: relative;
}

.hl.lean .case-label input[type="checkbox"] {
  position: absolute;
  top: 0;
  left: 0;
  opacity: 0;
  height: 0;
  width: 0;
  z-index: -10;
}

.hl.lean .case-label:has(input[type="checkbox"])::before {
  width: 1rem;
  height: 1rem;
  display: inline-block;
  background-color: black;
  content: ' ';
  transition: ease 0.2s;
  margin-right: 0.7rem;
  clip-path: polygon(100% 0, 0 0, 50% 100%);
  width: 0.6rem;
  height: 0.6rem;
}

.hl.lean .case-label:has(input[type="checkbox"]:not(:checked))::before {
  transform: rotate(-90deg);
}

.hl.lean .case-label:has(input[type="checkbox"]) {

}

.hl.lean .case-label:has(input[type="checkbox"]:checked) {

}


.hl.lean .tactic-state .labeled-case > :not(:first-child) {
  max-height: 0px;
  display: block;
  overflow: hidden;
  transition: max-height 0.1s ease-in;
  margin-left: 0.5rem;
  margin-top: 0.1rem;
}

.hl.lean .labeled-case:has(.case-label input[type="checkbox"]:checked) > :not(:first-child) {
  max-height: 100%;
}


.hl.lean .tactic-state .goal-name::before {
  font-style: normal;
  content: "case ";
}

.hl.lean .tactic-state .goal-name {
  font-style: italic;
  font-family: monospace;
}

.hl.lean .tactic-state .hypotheses {
  display: table;
}

.hl.lean .tactic-state .hypothesis {
  display: table-row;
}

.hl.lean .tactic-state .hypothesis > * {
  display: table-cell;
}


.hl.lean .tactic-state .hypotheses .colon {
  text-align: center;
  min-width: 1rem;
}

.hl.lean .tactic-state .hypotheses .name {
  text-align: right;
}

.hl.lean .tactic-state .hypotheses .name,
.hl.lean .tactic-state .hypotheses .type,
.hl.lean .tactic-state .conclusion .type {
  font-family: monospace;
}

.tippy-box[data-theme~='lean'] {
  background-color: #e5e5e5;
  color: black;
  border: 1px solid black;
}
.tippy-box[data-theme~='lean'][data-placement^='top'] > .tippy-arrow::before {
  border-top-color: #e5e5e5;
}
.tippy-box[data-theme~='lean'][data-placement^='bottom'] > .tippy-arrow::before {
  border-bottom-color: #e5e5e5;
}
.tippy-box[data-theme~='lean'][data-placement^='left'] > .tippy-arrow::before {
  border-left-color: #e5e5e5;
}
.tippy-box[data-theme~='lean'][data-placement^='right'] > .tippy-arrow::before {
  border-right-color: #e5e5e5;
}

.tippy-box[data-theme~='message'][data-placement^='top'] > .tippy-arrow::before {
  border-top-color: #e5e5e5;
  border-width: 11px 11px 0;
}
.tippy-box[data-theme~='message'][data-placement^='top'] > .tippy-arrow::after {
  bottom: -11px;
  border-width: 11px 11px 0;
}
.tippy-box[data-theme~='message'][data-placement^='bottom'] > .tippy-arrow::before {
  border-width: 0 11px 11px;
}
.tippy-box[data-theme~='message'][data-placement^='bottom'] > .tippy-arrow::after {
  top: -11px;
  border-width: 0 11px 11px;
}
.tippy-box[data-theme~='message'][data-placement^='left'] > .tippy-arrow::before {
  border-left-color: #e5e5e5;
  border-width: 11px 0 11px 11px;
}
.tippy-box[data-theme~='message'][data-placement^='left'] > .tippy-arrow::after {
  right: -11px;
  border-width: 11px 0 11px 11px;
}

.tippy-box[data-theme~='message'][data-placement^='right'] > .tippy-arrow::before {
  border-right-color: #e5e5e5;
  border-width: 11px 11px 11px 0;
}
.tippy-box[data-theme~='message'][data-placement^='right'] > .tippy-arrow::after {
  left: -11px;
  border-width: 11px 11px 11px 0;
}



.tippy-box[data-theme~='warning'] {
  background-color: #e5e5e5;
  color: black;
  border: 3px solid var(--verso-warning-color);
}

.tippy-box[data-theme~='error'] {
  background-color: #e5e5e5;
  color: black;
  border: 3px solid #f7a7af;
}

.tippy-box[data-theme~='info'] {
  background-color: #e5e5e5;
  color: black;
  border: 3px solid #99b3c2;
}

.tippy-box[data-theme~='tactic'] {
  background-color: white;
  color: black;
  border: 1px solid black;
}
.tippy-box[data-theme~='tactic'][data-placement^='top'] > .tippy-arrow::before {
  border-top-color: white;
}
.tippy-box[data-theme~='tactic'][data-placement^='bottom'] > .tippy-arrow::before {
  border-bottom-color: white;
}
.tippy-box[data-theme~='tactic'][data-placement^='left'] > .tippy-arrow::before {
  border-left-color: white;
}
.tippy-box[data-theme~='tactic'][data-placement^='right'] > .tippy-arrow::before {
  border-right-color: white;
}

</style><style>
.example-file {
  white-space: normal;
  font-family: var(--verso-structure-font-family);
  margin: 1rem;
  width: fit-content;
  border: 1px solid #ddd;
  padding: 0.5rem;

  /* These are necessary for the container to behave nicely on mobile */
  overflow-x: auto;
  max-width: 100%;
  box-sizing: border-box;
}
.example-file::before {
  counter-reset: linenumber;
}
.example-file > .line {
  display: block;
  white-space: pre;
  counter-increment: linenumber;
  font-family: var(--verso-code-font-family);
}
.example-file > .line::before {
  -webkit-user-select: none;
  display: inline-block;
  content: counter(linenumber);
  border-right: 1px solid #ddd;
  width: 2em;
  padding-right: 0.25em;
  margin-right: 0.25em;
  font-family: var(--verso-code-font-family);
  text-align: right;
}
.example-file > .line::after {
  -webkit-user-select: none;
  display: inline-block;
  content: "⏎";
  opacity: 0;
}
.example-file > .line:hover::after {
  opacity: 1;
}
.example-file > .line:hover, .example-file > .line:hover::before {
  background-color: #eee;
}
.example-file > .empty {
  display: block;
  white-space: pre;
  font-family: var(--verso-code-font-family);
  font-style: italic;
}
.example-file > .empty::before {
  -webkit-user-select: none;
  display: inline-block;
  content: "";
  border-right: 1px solid #ddd;
  width: 2em;
  padding-right: 0.25em;
  margin-right: 0.25em;
  font-family: var(--verso-code-font-family);
  text-align: right;
}
</style><style>
table.tabular {
  margin: auto;
  border-spacing: 1rem;
}
table.tabular.left-align {
  margin-right: auto;
  margin-left: 0;
}
table.tabular.center-align {
  margin: auto;
}
table.tabular.right-align {
  margin-left auto;
  margin-right: 0;
}
table.tabular td, table.tabular th {
  text-align: left;
  vertical-align: top;
}
table.tabular td > p:first-child, table.tabular th > p:first-child {
  margin-top: 0;
}
table.tabular td > p:last-child, table.tabular th > p:first-child {
  margin-bottom: 0;
}
</style><style>
.shell-commands {

}
.shell-commands > * {
  display: block;
  white-space: pre;
}
.shell-commands .command::before {
  content: "$ ";
  font-weight: 600;
}

div.paragraph > .shell-commands:not(:first-child) {
  margin-top: 0.5rem;
}

div.paragraph > .shell-commands:not(:last-child) {
  margin-bottom: 0.5rem;
}
</style><style>
.eq-steps .hl.lean.block {
  background-color: #f6f7f6;
  padding: 1rem;
  margin-top: 0.25rem;
  margin-bottom: 0.25rem;
}
.eq-steps .reason {
  font-style: italic;
  margin-left: 2.5em;
  display: flex;
}
.eq-steps .reason::before {
  content: "={";
  font-family: var(--verso-code-font-family);
  font-style: normal;
  font-weight: 600;
  margin-right: 0.5em;
  align-self: center;
}
.eq-steps .reason > p {
  margin: 0;
  max-width: 25em;
  align-self: center;
}
.eq-steps .reason::after {
  content: "}=";
  font-family: var(--verso-code-font-family);
  font-style: normal;
  font-weight: 600;
  margin-left: 1em;
  align-self: center;
}
</style><style>
div.paragraph > .eq-steps:not(:first-child) {
  margin-top: 0.5rem;
}

div.paragraph > .eq-steps:not(:last-child) {
  margin-bottom: 0.5rem;
}
</style><script>
      
window.onload = () => {

    // Don't show hovers inside of closed tactic states
    function blockedByTactic(elem) {
      let parent = elem.parentNode;
      while (parent && "classList" in parent) {
        if (parent.classList.contains("tactic")) {
          const toggle = parent.querySelector("input.tactic-toggle");
          if (toggle) {
            return !toggle.checked;
          }
        }
        parent = parent.parentNode;
      }
      return false;
    }

    function blockedByTippy(elem) {
      // Don't show a new hover until the old ones are all closed.
      // Scoped to the nearest "top-level block" to avoid being O(n) in the size of the document.
      var block = elem;
      const topLevel = new Set(["section", "body", "html", "nav", "header"]);
      while (block.parentNode && !topLevel.has(block.parentNode.nodeName.toLowerCase())) {
        block = block.parentNode;
      }
      for (const child of block.querySelectorAll(".token, .has-info")) {
        if (child._tippy && child._tippy.state.isVisible) { return true };
      }
      return false;
    }

    for (const c of document.querySelectorAll(".hl.lean .token")) {
        if (c.dataset.binding != "") {
            c.addEventListener("mouseover", (event) => {
                if (blockedByTactic(c)) {return;}
                const context = c.closest(".hl.lean").dataset.leanContext;
                for (const example of document.querySelectorAll(".hl.lean")) {
                    if (example.dataset.leanContext == context) {
                        for (const tok of example.querySelectorAll(".token")) {
                            if (c.dataset.binding == tok.dataset.binding) {
                                tok.classList.add("binding-hl");
                            }
                        }
                    }
                }
            });
        }
        c.addEventListener("mouseout", (event) => {
            for (const tok of document.querySelectorAll(".hl.lean .token")) {
                tok.classList.remove("binding-hl");
            }
        });
    }
    /* Render docstrings */
    if ('undefined' !== typeof marked) {
        for (const d of document.querySelectorAll("code.docstring, pre.docstring")) {
            const str = d.innerText;
            const html = marked.parse(str);
            const rendered = document.createElement("div");
            rendered.classList.add("docstring");
            rendered.innerHTML = html;
            d.parentNode.replaceChild(rendered, d);
        }
    }
    // Add hovers
    let siteRoot = typeof __versoSiteRoot !== 'undefined' ? __versoSiteRoot : "/";
    let docsJson = siteRoot + "-verso-docs.json";
    fetch(docsJson).then((resp) => resp.json()).then((versoDocData) => {

      function hideParentTooltips(element) {
        let parent = element.parentElement;
        while (parent) {
          const tippyInstance = parent._tippy;
          if (tippyInstance) {
            tippyInstance.hide();
          }
          parent = parent.parentElement;
        }
      }



      const defaultTippyProps = {
        /* DEBUG -- remove the space: * /
        onHide(any) { return false; },
        trigger: "click",
        // */
        /* theme: "lean", */
        maxWidth: "none",
        appendTo: () => document.body,
        interactive: true,
        delay: [100, null],
        /* ignoreAttributes: true, */
        followCursor: 'initial',
        onShow(inst) {
          if (inst.reference.className == 'tactic') {

            const toggle = inst.reference.querySelector("input.tactic-toggle");
            if (toggle && toggle.checked) {
              return false;
            }
            hideParentTooltips(inst.reference);
            //if (blockedByTippy(inst.reference)) { return false; }

          } else if (inst.reference.querySelector(".hover-info") || "versoHover" in inst.reference.dataset) {
            if (blockedByTactic(inst.reference)) { return false };
            if (blockedByTippy(inst.reference)) { return false; }
          } else { // Nothing to show here!
            return false;
          }
        },
        content (tgt) {
          const content = document.createElement("span");
          if (tgt.className == 'tactic') {
            const state = tgt.querySelector(".tactic-state").cloneNode(true);
            state.style.display = "block";
            content.appendChild(state);
            content.style.display = "block";
            content.className = "hl lean popup";
          } else {
            content.className = "hl lean";
            content.style.display = "block";
            content.style.maxHeight = "300px";
            content.style.overflowY = "auto";
            content.style.overflowX = "hidden";
            const hoverId = tgt.dataset.versoHover;
            const hoverInfo = tgt.querySelector(".hover-info");
            if (hoverId) { // Docstrings from the table
              // TODO stop doing an implicit conversion from string to number here
              let data = versoDocData[hoverId];
              if (data) {
                const info = document.createElement("span");
                info.className = "hover-info";
                info.style.display = "block";
                info.innerHTML = data;
                content.appendChild(info);
                /* Render docstrings - TODO server-side */
                if ('undefined' !== typeof marked) {
                    for (const d of content.querySelectorAll("code.docstring, pre.docstring")) {
                        const str = d.innerText;
                        const html = marked.parse(str);
                        const rendered = document.createElement("div");
                        rendered.classList.add("docstring");
                        rendered.innerHTML = html;
                        d.parentNode.replaceChild(rendered, d);
                    }
                }
              } else {
                content.innerHTML = "Failed to load doc ID: " + hoverId;
              }
            } else if (hoverInfo) { // The inline info, still used for compiler messages
              content.appendChild(hoverInfo.cloneNode(true));
            }
          }
          return content;
        }
      };



      const addTippy = (selector, props) => {
        tippy(selector, Object.assign({}, defaultTippyProps, props));
      };
      document.querySelectorAll('.hl.lean .const.token, .hl.lean .keyword.token, .hl.lean .literal.token, .hl.lean .option.token, .hl.lean .var.token, .hl.lean .typed.token').forEach(element => {
        element.setAttribute('data-tippy-theme', 'lean');
      });
      document.querySelectorAll('.hl.lean .has-info.warning').forEach(element => {
        element.setAttribute('data-tippy-theme', 'warning message');
      });
      document.querySelectorAll('.hl.lean .has-info.info').forEach(element => {
        element.setAttribute('data-tippy-theme', 'info message');
      });
      document.querySelectorAll('.hl.lean .has-info.error').forEach(element => {
        element.setAttribute('data-tippy-theme', 'error message');
      });
      document.querySelectorAll('.hl.lean .tactic').forEach(element => {
        element.setAttribute('data-tippy-theme', 'tactic');
      });
      let insts = tippy('.hl.lean .const.token, .hl.lean .keyword.token, .hl.lean .literal.token, .hl.lean .option.token, .hl.lean .var.token, .hl.lean .typed.token, .hl.lean .has-info, .hl.lean .tactic', defaultTippyProps);



      /*
      tippy('.hl.lean .tactic', {
        allowHtml: true,

        onHide(any) { return false; },
        trigger: "click",

        maxWidth: "none",
        onShow(inst) {
          const toggle = inst.reference.querySelector("input.tactic-toggle");
          if (toggle && toggle.checked) {
            return false;
          }
          if (blockedByTippy(inst.reference)) { return false; }
        },
        content (tgt) {
          const content = document.createElement("span");
          const state = tgt.querySelector(".tactic-state").cloneNode(true);
          state.style.display = "block";
          content.appendChild(state);
          content.style.display = "block";
          content.className = "hl lean popup";
          return content;
        }
      });
      */
  });
}
</script>
    </head>
  <body>
    <header>
      <div class="header-logo-wrapper">
        <a href="" id="logo"><img src="static/lean_logo.svg"></a></div>
      <div class="header-title-wrapper">
        <a href="" class="header-title"><h1>
            Functional Programming in Lean</h1>
          </a></div>
      </header>
    <label for="toggle-toc" id="toggle-toc-click"><span class="line line1"></span><span class="line line2"></span><span class="line line3"></span></label><div class="with-toc">
      <div class="toc-backdrop" onclick="document.getElementById('toggle-toc-click')?.click()"></div>
      <nav id="toc">
        <input type="checkbox" id="toggle-toc"><div class="first">
          <a href="" class="toc-title"><h1>
              Functional Programming in Lean</h1>
            </a><div class="split-tocs">
            <div class="split-toc book">
              <div class="title">
                <label for="--verso-manual-toc-----bookRoot" class="toggle-split-toc"><input type="checkbox" class="toggle-split-toc" id="--verso-manual-toc-----bookRoot"></label><span class="">Table of Contents</span></div>
              <table><tr class="unnumbered"><td class="num"><td><a href="Introduction/#Functional-Programming-in-Lean--Introduction">Introduction</a></td></tr><tr class="unnumbered"><td class="num"><td><a href="Acknowledgments/#Functional-Programming-in-Lean--Acknowledgments">Acknowledgments</a></td></tr><tr class="numbered"><td class="num">1.</td><td><a href="Getting-to-Know-Lean/#getting-to-know">Getting to Know Lean</a></td></tr><tr class="numbered"><td class="num">2.</td><td><a href="Hello___-World___/#hello-world">Hello, World!</a></td></tr><tr class="unnumbered"><td class="num"><td><a href="Interlude___-Propositions___-Proofs___-and-Indexing/#props-proofs-indexing">Interlude: Propositions, Proofs, and Indexing</a></td></tr><tr class="numbered"><td class="num">3.</td><td><a href="Overloading-and-Type-Classes/#Functional-Programming-in-Lean--Overloading-and-Type-Classes">Overloading and Type Classes</a></td></tr><tr class="numbered"><td class="num">4.</td><td><a href="Monads/#Functional-Programming-in-Lean--Monads">Monads</a></td></tr><tr class="numbered"><td class="num">5.</td><td><a href="Functors___-Applicative-Functors___-and-Monads/#Functional-Programming-in-Lean--Functors___-Applicative-Functors___-and-Monads">Functors, Applicative Functors, and Monads</a></td></tr><tr class="current numbered"><td class="num">6.</td><td><a href="Monad-Transformers/#Functional-Programming-in-Lean--Monad-Transformers">Monad Transformers</a></td></tr><tr class="numbered"><td class="num">7.</td><td><a href="Programming-with-Dependent-Types/#Functional-Programming-in-Lean--Programming-with-Dependent-Types">Programming with Dependent Types</a></td></tr><tr class="unnumbered"><td class="num"><td><a href="Interlude___-Tactics___-Induction___-and-Proofs/#Functional-Programming-in-Lean--Interlude___-Tactics___-Induction___-and-Proofs">Interlude: Tactics, Induction, and Proofs</a></td></tr><tr class="numbered"><td class="num">8.</td><td><a href="Programming___-Proving___-and-Performance/#Functional-Programming-in-Lean--Programming___-Proving___-and-Performance">Programming, Proving, and Performance</a></td></tr><tr class="numbered"><td class="num">9.</td><td><a href="Next-Steps/#next-steps">Next Steps</a></td></tr></table></div>
            <div class="split-toc">
              <div class="title">
                <label for="--verso-manual-toc-Functional-Programming-in-Lean--Monad-Transformers" class="toggle-split-toc"><input type="checkbox" class="toggle-split-toc" id="--verso-manual-toc-Functional-Programming-in-Lean--Monad-Transformers" checked="checked"></label><span class="number">6.</span> <span class=""><a href="Monad-Transformers/#Functional-Programming-in-Lean--Monad-Transformers">Monad Transformers</a></span></div>
              <table><tr class="numbered"><td class="num">6.1.</td><td><a href="Monad-Transformers/Combining-IO-and-Reader/#Functional-Programming-in-Lean--Monad-Transformers--Combining-IO-and-Reader">Combining IO and Reader</a></td></tr><tr class="current numbered"><td class="num">6.2.</td><td><a href="Monad-Transformers/A-Monad-Construction-Kit/#Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit">A Monad Construction Kit</a></td></tr><tr class="numbered"><td class="num">6.3.</td><td><a href="Monad-Transformers/Ordering-Monad-Transformers/#Functional-Programming-in-Lean--Monad-Transformers--Ordering-Monad-Transformers">Ordering Monad Transformers</a></td></tr><tr class="numbered"><td class="num">6.4.</td><td><a href="Monad-Transformers/More-do-Features/#Functional-Programming-in-Lean--Monad-Transformers--More-do-Features">More do Features</a></td></tr><tr class="numbered"><td class="num">6.5.</td><td><a href="Monad-Transformers/Additional-Conveniences/#Functional-Programming-in-Lean--Monad-Transformers--Additional-Conveniences">Additional Conveniences</a></td></tr><tr class="numbered"><td class="num">6.6.</td><td><a href="Monad-Transformers/Summary/#Functional-Programming-in-Lean--Monad-Transformers--Summary">Summary</a></td></tr></table></div>
            <div class="split-toc">
              <div class="title">
                <label for="--verso-manual-toc-Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit" class="toggle-split-toc"><input type="checkbox" class="toggle-split-toc" id="--verso-manual-toc-Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit" checked="checked"></label><span class="number">6.2.</span> <span class="current"><a href="Monad-Transformers/A-Monad-Construction-Kit/#Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit">A Monad Construction Kit</a></span></div>
              <table><tr class="numbered"><td class="num">6.2.1.</td><td><a href="Monad-Transformers/A-Monad-Construction-Kit/#Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Failure-with--OptionT">Failure with <code>OptionT</code></a></td></tr><tr class="numbered"><td class="num">6.2.2.</td><td><a href="Monad-Transformers/A-Monad-Construction-Kit/#Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Exceptions">Exceptions</a></td></tr><tr class="numbered"><td class="num">6.2.3.</td><td><a href="Monad-Transformers/A-Monad-Construction-Kit/#Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--State">State</a></td></tr><tr class="numbered"><td class="num">6.2.4.</td><td><a href="Monad-Transformers/A-Monad-Construction-Kit/#Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Of--Classes-and--The--Functions"><code>Of</code> Classes and <code>The</code> Functions</a></td></tr><tr class="numbered"><td class="num">6.2.5.</td><td><a href="Monad-Transformers/A-Monad-Construction-Kit/#Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Transformers-and--Id">Transformers and <code>Id</code></a></td></tr><tr class="numbered"><td class="num">6.2.6.</td><td><a href="Monad-Transformers/A-Monad-Construction-Kit/#Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Exercises">Exercises</a></td></tr></table></div>
            </div>
          </div>
        <div class="last">
          <ul id="meta-links">
            <li>
              <a href="https://github.com/leanprover/fp-lean">Source Code</a></li>
            <li>
              <a href="https://github.com/leanprover/fp-lean/issues">Report Issues</a></li>
            </ul>
          </div>
        </nav>
      <main><div class="content-wrapper">
          <nav class="prev-next-buttons">
            <a class="local-button active" href="Monad-Transformers/Combining-IO-and-Reader/#Functional-Programming-in-Lean--Monad-Transformers--Combining-IO-and-Reader" rel="prev" title="6.1. Combining IO and Reader"><span class="arrow">←</span><span class="where">6.1. Combining IO and Reader</span></a><a class="local-button active" href="Monad-Transformers/Ordering-Monad-Transformers/#Functional-Programming-in-Lean--Monad-Transformers--Ordering-Monad-Transformers" rel="next" title="6.3. Ordering Monad Transformers"><span class="where">6.3. Ordering Monad Transformers</span><span class="arrow">→</span></a></nav>
          <section>
            <h1>
              6.2. A Monad Construction Kit</h1>
            <p>
              <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-ReaderT" data-verso-hover="1358">ReaderT</span></code> is far from the only useful monad transformer.
This section describes a number of additional transformers.
Each monad transformer consists of the following:</p>
            <ol start="1">
              <li>
                <p>
                  A definition or datatype <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.22132" data-verso-hover="1359">T</span></code> that takes a monad as an argument.
    It should have a type like <code class="hl lean inline" data-lean-context="examples"><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-11923" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-11934" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-11946" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-11957" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span></code>, though it may accept additional arguments prior to the monad.</p>
                </li>
              <li>
                <p>
                  A <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code> instance for <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.22132" data-verso-hover="1359">T</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22136" data-verso-hover="1246">m</span></code> that relies on an instance of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22136" data-verso-hover="1246">m</span></code>. This enables the transformed monad to be used as a monad.</p>
                </li>
              <li>
                <p>
                  A <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadLift" data-verso-hover="1348">MonadLift</span></code> instance that translates actions of type <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.22136" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22113" data-verso-hover="1219">α</span></code> into actions of type <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.22132" data-verso-hover="1359">T</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22136" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22113" data-verso-hover="1219">α</span></code>, for arbitrary monads <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.22136" data-verso-hover="1246">m</span></code>. This enables actions from the underlying monad to be used in the transformed monad.</p>
                </li>
              </ol>
            <p>
              Furthermore, the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code> instance for the transformer should obey the contract for <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code>, at least if the underlying <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code> instance does.
In addition, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadLiftT.monadLift" data-verso-hover="1360">monadLift</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22173" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22136" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22170" data-verso-hover="1219">α</span><span class="unknown token" data-binding="">)</span></code> should be equivalent to <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22173" data-verso-hover="121">x</span></code> in the transformed monad, and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadLiftT.monadLift" data-verso-hover="1360">monadLift</span></code> should distribute over <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Bind.bind" data-verso-hover="1361">bind</span></code> so that <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadLiftT.monadLift" data-verso-hover="1360">monadLift</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.22434" data-verso-hover="865">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22437" data-verso-hover="1362">f</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22136" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22431" data-verso-hover="1219">α</span><span class="unknown token" data-binding="">)</span></code> is the same as <code class="hl lean inline" data-lean-context="examples"><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-MonadLiftT.monadLift" data-verso-hover="1360">monadLift</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22434" data-verso-hover="865">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22136" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22431" data-verso-hover="1219">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-12215">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22694" data-verso-hover="121">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-MonadLiftT.monadLift" data-verso-hover="1360">monadLift</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.22437" data-verso-hover="1362">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.22694" data-verso-hover="121">y</span><span class="unknown token" data-binding="">)</span></code>.</p>
            <p>
              Many monad transformers additionally define type classes in the style of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadReader" data-verso-hover="1363">MonadReader</span></code> that describe the actual effects available in the monad.
This can provide more flexibility: it allows programs to be written that rely only on an interface, and don't constrain the underlying monad to be implemented by a given transformer.
The type classes are a way for programs to express their requirements, and monad transformers are a convenient way to meet these requirements.</p>
            <section>
              <h2 id="Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Failure-with--OptionT">
                6.2.1. Failure with <code>OptionT</code></h2>
              <p>
                Failure, represented by the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span></code> monad, and exceptions, represented by the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span></code> monad, both have corresponding transformers.
In the case of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span></code>, failure can be added to a monad by having it contain values of type <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.59" data-verso-hover="1219">α</span></code> where it would otherwise contain values of type <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.59" data-verso-hover="1219">α</span></code>.
For example, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-IO" data-verso-hover="2">IO</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.21987" data-verso-hover="113">α</span><span class="unknown token" data-binding="">)</span></code> represents <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-IO" data-verso-hover="2">IO</span></code> actions that don't always return a value of type <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.21987" data-verso-hover="113">α</span></code>.
This suggests the definition of the monad transformer <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span></code>:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-265">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.57" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-282" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-293" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.59" data-verso-hover="1219">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-307" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-317" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="var token" data-binding="var-_uniq.57" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.59" data-verso-hover="1219">α</span><span class="unknown token" data-binding="">)</span></code><p>
                As an example of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span></code> in action, consider a program that asks the user questions.
The function <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.getSomeInput" data-verso-hover="1365">getSomeInput</span></code> asks for a line of input and removes whitespace from both ends.
If the resulting trimmed input is non-empty, then it is returned, but the function fails if there are no non-whitespace characters:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-4196">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.getSomeInput" data-verso-hover="1365">getSomeInput</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span><span class="inter-text"> </span><span class="const token" data-binding="const-IO" data-verso-hover="2">IO</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-4236">do</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doLetArrow-4241">let</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9968" data-verso-hover="39">input</span><span class="inter-text"> </span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="const token" data-binding="const-IO.getStdin" data-verso-hover="252">IO.getStdin</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-IO.FS.Stream.getLine" data-verso-hover="256">getLine</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doLet-4283">let</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9972" data-verso-hover="39">trimmed</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9968" data-verso-hover="39">input</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-String.trim" data-verso-hover="325">trim</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doIf-4311">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9972" data-verso-hover="39">trimmed</span><span class="inter-text"> </span><span class="unknown token" data-binding="">==</span><span class="inter-text"> </span><span class="literal string token" data-binding="" data-verso-hover="207">""</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doIf-4311">then</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Alternative.failure" data-verso-hover="1199">failure</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-null-4347">else</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9972" data-verso-hover="39">trimmed</span></code><p>
                This particular application tracks users with their name and their favorite species of beetle:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.structureTk-4415">structure</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.UserInfo" data-verso-hover="1366">UserInfo</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-4434">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Opt.UserInfo.name" data-verso-hover="1367">name</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Opt.UserInfo.favoriteBeetle" data-verso-hover="1368">favoriteBeetle</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span></code><p>
                Asking the user for input is no more verbose than a function that uses only <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-IO" data-verso-hover="2">IO</span></code> would be:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-4531">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.getUserInfo" data-verso-hover="1369">getUserInfo</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span><span class="inter-text"> </span><span class="const token" data-binding="const-IO" data-verso-hover="2">IO</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.UserInfo" data-verso-hover="1366">UserInfo</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-4572">do</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-IO.println" data-verso-hover="250">IO.println</span><span class="inter-text"> </span><span class="literal string token" data-binding="" data-verso-hover="1370">"What is your name?"</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doLetArrow-4611">let</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.10739" data-verso-hover="39">name</span><span class="inter-text"> </span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.getSomeInput" data-verso-hover="1365">getSomeInput</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-IO.println" data-verso-hover="250">IO.println</span><span class="inter-text"> </span><span class="literal string token" data-binding="" data-verso-hover="1371">"What is your favorite species of beetle?"</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doLetArrow-4695">let</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.10864" data-verso-hover="39">beetle</span><span class="inter-text"> </span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.getSomeInput" data-verso-hover="1365">getSomeInput</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="const-Opt.UserInfo.mk" data-verso-hover="1372">⟨</span><span class="var token" data-binding="var-_uniq.10739" data-verso-hover="39">name</span><span class="unknown token" data-binding="const-Opt.UserInfo.mk" data-verso-hover="1372">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.10864" data-verso-hover="39">beetle</span><span class="unknown token" data-binding="const-Opt.UserInfo.mk" data-verso-hover="1372">⟩</span></code><p>
                However, because the function runs in an <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span><span class="inter-text"> </span><span class="const token" data-binding="const-IO" data-verso-hover="2">IO</span></code> context rather than just in <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-IO" data-verso-hover="2">IO</span></code>, failure in the first call to <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.getSomeInput" data-verso-hover="1365">getSomeInput</span></code> causes the whole <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.getUserInfo" data-verso-hover="1369">getUserInfo</span></code> to fail, with control never reaching the question about beetles.
The main function, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.interact" data-verso-hover="1373">interact</span></code>, invokes <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.getUserInfo" data-verso-hover="1369">getUserInfo</span></code> in a purely <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-IO" data-verso-hover="2">IO</span></code> context, which allows it to check whether the call succeeded or failed by matching on the inner <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span></code>:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-4798">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.interact" data-verso-hover="1373">interact</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-IO" data-verso-hover="2">IO</span><span class="inter-text"> </span><span class="const token" data-binding="const-Unit" data-verso-hover="184">Unit</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-4824">do</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-4829">match</span><span class="inter-text"> </span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.getUserInfo" data-verso-hover="1369">getUserInfo</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-4829">with</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-IO.eprintln" data-verso-hover="1284">IO.eprintln</span><span class="inter-text"> </span><span class="literal string token" data-binding="" data-verso-hover="1374">"Missing info"</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="unknown token" data-binding="">⟨</span><span class="var token" data-binding="var-_uniq.11084" data-verso-hover="39">name</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11085" data-verso-hover="39">beetle</span><span class="unknown token" data-binding="">⟩</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-IO.println" data-verso-hover="250">IO.println</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termS!_-4945">s!</span><span class="unknown token" data-binding="">"Hello {</span><span class="var token" data-binding="var-_uniq.11084" data-verso-hover="39">name</span><span class="unknown token" data-binding="">}, whose favorite beetle is {</span><span class="var token" data-binding="var-_uniq.11085" data-verso-hover="39">beetle</span><span class="unknown token" data-binding="">}."</span></code><section>
                <h3 id="Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Failure-with--OptionT--The-Monad-Instance">
                  6.2.1.1. The Monad Instance</h3>
                <p>
                  Writing the monad instance reveals a difficulty.
Based on the types, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Pure.pure" data-verso-hover="1375">pure</span></code> should use <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Pure.pure" data-verso-hover="1375">pure</span></code> from the underlying monad <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.75" data-verso-hover="1125">m</span></code> together with <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span></code>.
Just as <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Bind.bind" data-verso-hover="1376">bind</span></code> for <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span></code> branches on the first argument, propagating <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span></code>, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Bind.bind" data-verso-hover="1376">bind</span></code> for <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span></code> should run the monadic action that makes up the first argument, branch on the result, and then propagate <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span></code>.
Following this sketch yields the following definition, which Lean does not accept:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.instance-1000">instance</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.75" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.75" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.whereStructInst-1039">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="1377">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.150" data-verso-hover="584">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="has-info error"><span class="hover-container"><span class="hover-info messages"><code class="message error">failed to synthesize
  Pure (OptionT m)

Additional diagnostic information may be available using the `set_option diagnostics true` command.</code></span></span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="has-info error"><span class="hover-container"><span class="hover-info messages"><code class="message error">application type mismatch
  pure (some x)
argument
  some x
has type
  Option α✝ : Type ?u.78
but is expected to have type
  α✝ : Type ?u.78</code></span></span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.150" data-verso-hover="584">x</span><span class="unknown token" data-binding="">)</span></span></span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Bind.bind" data-verso-hover="1376">bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.410" data-verso-hover="1378">action</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.413" data-verso-hover="1379">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-1093">do</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="has-info error"><span class="hover-container"><span class="hover-info messages"><code class="message error">failed to synthesize
  Bind (OptionT m)

Additional diagnostic information may be available using the `set_option diagnostics true` command.</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-1100">match</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.410" data-verso-hover="1378">action</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-1100">with</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="has-info error"><span class="hover-container"><span class="hover-info messages"><code class="message error">type mismatch
  none
has type
  Option ?m.497 : Type ?u.496
but is expected to have type
  α✝ : Type ?u.78</code></span></span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span></span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="unknown token" data-binding="">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">none</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="unknown token" data-binding="">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span></span></code><p>
                  The error message shows a cryptic type mismatch:</p>
                <div class="error">
                  <pre>application type mismatch
  pure (some x)
argument
  some x
has type
  Option α✝ : Type ?u.78
but is expected to have type
  α✝ : Type ?u.78</pre></div>
                <p>
                  The problem here is that Lean is selecting the wrong <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code> instance for the surrounding use of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Pure.pure" data-verso-hover="1377">pure</span></code>.
Similar errors occur for the definition of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Bind.bind" data-verso-hover="1376">bind</span></code>.
One solution is to use type annotations to guide Lean to the correct <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code> instance:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.instance-1257">instance</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.903" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.903" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.whereStructInst-1296">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="1380">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.979" data-verso-hover="584">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.979" data-verso-hover="584">x</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.923" data-verso-hover="1125">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span><span class="inter-text"> </span><span class="unknown token" data-binding="">_</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Bind.bind" data-verso-hover="1381">bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1140" data-verso-hover="1378">action</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1143" data-verso-hover="1379">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-1368">do</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-1375">match</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1140" data-verso-hover="1378">action</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-1375">with</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1301" data-verso-hover="584">v</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1143" data-verso-hover="1379">next</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1301" data-verso-hover="584">v</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.923" data-verso-hover="1125">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span><span class="inter-text"> </span><span class="unknown token" data-binding="">_</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span></code><p>
                  While this solution works, it is inelegant and the code becomes a bit noisy.</p>
                <p>
                  An alternative solution is to define functions whose type signatures guide Lean to the correct instances.
In fact, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.Structed.OptionT" data-verso-hover="1382">OptionT</span></code> could have been defined as a structure:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.structureTk-1561">structure</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.Structed.OptionT" data-verso-hover="1382">OptionT</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1437" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-1584" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-1595" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1439" data-verso-hover="1219">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-1609" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-1619" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-1626">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Opt.Structed.OptionT.run" data-verso-hover="1383">run</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1437" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1439" data-verso-hover="1219">α</span><span class="unknown token" data-binding="">)</span></code><p>
                  This would solve the problem, because the constructor <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.Structed.OptionT.mk" data-verso-hover="1384">OptionT.mk</span></code> and the field accessor <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.Structed.OptionT.run" data-verso-hover="1383">OptionT.run</span></code> would guide type class inference to the correct instances.
The downside to doing this is that the resulting code is more complicated, and these structures can make it more difficult to read proofs.
The best of both worlds can be achieved by defining functions that serve the same role as the constructor <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.Structed.OptionT.mk" data-verso-hover="1384">OptionT.mk</span></code> and the field <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.Structed.OptionT.run" data-verso-hover="1383">OptionT.run</span></code>, but that work with the direct definition:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-1847">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.OptionT.mk" data-verso-hover="1385">OptionT.mk</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1821" data-verso-hover="1386">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1808" data-verso-hover="1125">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1818" data-verso-hover="369">α</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1808" data-verso-hover="1125">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1818" data-verso-hover="369">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1821" data-verso-hover="1386">x</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-1903">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.OptionT.run" data-verso-hover="1387">OptionT.run</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1862" data-verso-hover="1388">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1850" data-verso-hover="1125">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1857" data-verso-hover="369">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1850" data-verso-hover="1125">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1857" data-verso-hover="369">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1862" data-verso-hover="1388">x</span></code><p>
                  Both functions return their inputs unchanged, but they indicate the boundary between code that is intended to present the interface of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span></code> and code that is intended to present the interface of the underlying monad <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.1808" data-verso-hover="1125">m</span></code>.
Using these helpers, the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code> instance becomes more readable:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.instance-2028">instance</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1885" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1885" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.whereStructInst-2067">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="1377">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1963" data-verso-hover="584">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.OptionT.mk" data-verso-hover="1385">OptionT.mk</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.1963" data-verso-hover="584">x</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Bind.bind" data-verso-hover="1376">bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.2109" data-verso-hover="1378">action</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.2112" data-verso-hover="1379">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.OptionT.mk" data-verso-hover="1385">OptionT.mk</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-2145">do</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-2152">match</span><span class="inter-text"> </span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.2109" data-verso-hover="1378">action</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-2152">with</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.2232" data-verso-hover="584">v</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.2112" data-verso-hover="1379">next</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.2232" data-verso-hover="584">v</span></code><p>
                  Here, the use of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT.mk" data-verso-hover="1385">OptionT.mk</span></code> indicates that its arguments should be considered as code that uses the interface of <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.1885" data-verso-hover="1125">m</span></code>, which allows Lean to select the correct <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code> instances.</p>
                <p>
                  After defining the monad instance, it's a good idea to check that the monad contract is satisfied.
The first step is to show that <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Bind.bind" data-verso-hover="864">bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8748" data-verso-hover="121">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8760" data-verso-hover="1389">f</span></code> is the same as <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.8760" data-verso-hover="1389">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8748" data-verso-hover="121">v</span></code>.
Here's the steps:</p>
                <div class="eq-steps">
                  <code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Bind.bind" data-verso-hover="864">bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8748" data-verso-hover="121">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8760" data-verso-hover="1389">f</span></code><div class="reason">
                    <p>
                      Unfolding the definitions of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Bind.bind" data-verso-hover="864">bind</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span></code></p>
                    </div>
                  <code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT.mk" data-verso-hover="1385">OptionT.mk</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-2724">do</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-2729">match</span><span class="inter-text"> </span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8748" data-verso-hover="121">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-2729">with</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.4543" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8760" data-verso-hover="1389">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.4543" data-verso-hover="121">x</span></code><div class="reason">
                    <p>
                      Desugaring nested action syntax</p>
                    </div>
                  <code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT.mk" data-verso-hover="1385">OptionT.mk</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-2854">do</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doLetArrow-2859">let</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.5325" data-verso-hover="730">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8748" data-verso-hover="121">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-2885">match</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.5325" data-verso-hover="730">y</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-2885">with</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.5413" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8760" data-verso-hover="1389">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.5413" data-verso-hover="121">x</span></code><div class="reason">
                    <p>
                      Desugaring <code class="hl lean inline" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-2724">do</span></code>-notation</p>
                    </div>
                  <code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT.mk" data-verso-hover="1385">OptionT.mk</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8748" data-verso-hover="121">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-3008">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6265" data-verso-hover="730">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.match-3021" data-verso-hover="100">match</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6265" data-verso-hover="730">y</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.match-3021" data-verso-hover="100">with</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6660" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8760" data-verso-hover="1389">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.6660" data-verso-hover="121">x</span><span class="unknown token" data-binding="">)</span></code><div class="reason">
                    <p>
                      Using the first monad rule for <code class="hl lean inline" data-lean-context="examples"><span class="unknown token" data-binding="">m</span></code></p>
                    </div>
                  <code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT.mk" data-verso-hover="1385">OptionT.mk</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.match-3186" data-verso-hover="100">match</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8748" data-verso-hover="121">v</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.match-3186" data-verso-hover="100">with</span><span class="inter-text">
</span><span class="inter-text">   </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text">
</span><span class="inter-text">   </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.7243" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8760" data-verso-hover="1389">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.7243" data-verso-hover="121">x</span><span class="unknown token" data-binding="">)</span></code><div class="reason">
                    <p>
                      Reduce <code class="hl lean inline" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-2729">match</span></code></p>
                    </div>
                  <code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT.mk" data-verso-hover="1385">OptionT.mk</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.8760" data-verso-hover="1389">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8748" data-verso-hover="121">v</span><span class="unknown token" data-binding="">)</span></code><div class="reason">
                    <p>
                      Definition of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT.mk" data-verso-hover="1385">OptionT.mk</span></code></p>
                    </div>
                  <code class="hl lean block" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.8760" data-verso-hover="1389">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8748" data-verso-hover="121">v</span></code></div>
                <p>
                  The second rule states that <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Bind.bind" data-verso-hover="864">bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8751" data-verso-hover="1386">w</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span></code> is the same as <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.8751" data-verso-hover="1386">w</span></code>.
To demonstrate this, unfold the definitions of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Bind.bind" data-verso-hover="864">bind</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span></code>, yielding:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT.mk" data-verso-hover="1385">OptionT.mk</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-3462">do</span><span class="inter-text">
    </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-3469">match</span><span class="inter-text"> </span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8751" data-verso-hover="1386">w</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-3469">with</span><span class="inter-text">
    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text">
    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8643" data-verso-hover="121">v</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8643" data-verso-hover="121">v</span><span class="unknown token" data-binding="">)</span></code><p>
                  In this pattern match, the result of both cases is the same as the pattern being matched, just with <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span></code> around it.
In other words, it is equivalent to <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.8751" data-verso-hover="1386">w</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&gt;&gt;=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-3557">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8844" data-verso-hover="730">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8844" data-verso-hover="730">y</span></code>, which is an instance of <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.8746" data-verso-hover="581">m</span></code>'s second monad rule.</p>
                <p>
                  The final rule states that <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Bind.bind" data-verso-hover="864">bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Bind.bind" data-verso-hover="864">bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8969" data-verso-hover="1388">v</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8760" data-verso-hover="1389">f</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8770" data-verso-hover="1390">g</span></code>  is the same as <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Bind.bind" data-verso-hover="864">bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8969" data-verso-hover="1388">v</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-3674">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9066" data-verso-hover="121">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Bind.bind" data-verso-hover="864">bind</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.8760" data-verso-hover="1389">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9066" data-verso-hover="121">x</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.8770" data-verso-hover="1390">g</span><span class="unknown token" data-binding="">)</span></code>.
It can be checked in the same way, by expanding the definitions of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Bind.bind" data-verso-hover="864">bind</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span></code> and then delegating to the underlying monad <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.8746" data-verso-hover="581">m</span></code>.</p>
                </section>
              <section>
                <h3 id="Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Failure-with--OptionT--An--Alternative--Instance">
                  6.2.1.2. An <code>Alternative</code> Instance</h3>
                <p>
                  One convenient way to use <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span></code> is through the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Alternative" data-verso-hover="1192">Alternative</span></code> type class.
Successful return is already indicated by <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span></code>, and the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Alternative.failure" data-verso-hover="1391">failure</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Alternative.orElse" data-verso-hover="1392">orElse</span></code> methods of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Alternative" data-verso-hover="1192">Alternative</span></code> provide a way to write a program that returns the first successful result from a number of subprograms:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.instance-3938">instance</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9324" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Alternative" data-verso-hover="1192">Alternative</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9324" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.whereStructInst-3983">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Alternative.failure" data-verso-hover="1391">failure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.OptionT.mk" data-verso-hover="1385">OptionT.mk</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Alternative.orElse" data-verso-hover="1392">orElse</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9444" data-verso-hover="1378">x</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9447" data-verso-hover="1393">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.OptionT.mk" data-verso-hover="1385">OptionT.mk</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-4052">do</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-4059">match</span><span class="inter-text"> </span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9444" data-verso-hover="1378">x</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-4059">with</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9533" data-verso-hover="584">result</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9533" data-verso-hover="584">result</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9447" data-verso-hover="1393">y</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">)</span></code></section>
              <section>
                <h3 id="Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Failure-with--OptionT--Lifting">
                  6.2.1.3. Lifting</h3>
                <p>
                  Lifting an action from <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.9120" data-verso-hover="1125">m</span></code> to <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9120" data-verso-hover="1125">m</span></code> only requires wrapping <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span></code> around the result of the computation:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.instance-3763">instance</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9120" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-MonadLift" data-verso-hover="1348">MonadLift</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9120" data-verso-hover="1125">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9120" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.whereStructInst-3808">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-MonadLift.monadLift" data-verso-hover="1394">monadLift</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9161" data-verso-hover="1269">action</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-Opt.OptionT.mk" data-verso-hover="1385">OptionT.mk</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-3847">do</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.9161" data-verso-hover="1269">action</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span></code></section>
              </section>
            <section>
              <h2 id="Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Exceptions">
                6.2.2. Exceptions</h2>
              <p>
                The monad transformer version of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span></code> is very similar to the monad transformer version of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span></code>.
Adding exceptions of type <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.11335" data-verso-hover="1219">ε</span></code> to some monadic action of type <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.11339" data-verso-hover="1246">m</span></code><code> </code><code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.11341" data-verso-hover="1219">α</span></code> can be accomplished by adding exceptions to <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.12891" data-verso-hover="1235">α</span></code>, yielding type <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.11339" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11335" data-verso-hover="1219">ε</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11341" data-verso-hover="1219">α</span><span class="unknown token" data-binding="">)</span></code>:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-5068">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.11335" data-verso-hover="1219">ε</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-5086" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.11339" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-5099" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-5110" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.11341" data-verso-hover="1219">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-5124" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-5134" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="var token" data-binding="var-_uniq.11339" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11335" data-verso-hover="1219">ε</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11341" data-verso-hover="1219">α</span><span class="unknown token" data-binding="">)</span></code><p>
                <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span></code> provides <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT.mk" data-verso-hover="1385">OptionT.mk</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT.run" data-verso-hover="1387">OptionT.run</span></code> functions to guide the type checker towards the correct <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code> instances.
This trick is also useful for <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span></code>:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-6264">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.ExceptT.mk" data-verso-hover="1396">ExceptT.mk</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.11960" data-verso-hover="1219">ε</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11962" data-verso-hover="1219">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-6288" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.11965" data-verso-hover="1397">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11958" data-verso-hover="1398">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11960" data-verso-hover="1219">ε</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11962" data-verso-hover="1219">α</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11960" data-verso-hover="1219">ε</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11958" data-verso-hover="1398">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11962" data-verso-hover="1219">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11965" data-verso-hover="1397">x</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="inter-text"></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-6345">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.ExceptT.run" data-verso-hover="1399">ExceptT.run</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.12007" data-verso-hover="1219">ε</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12009" data-verso-hover="1219">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-6370" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.12015" data-verso-hover="1400">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12007" data-verso-hover="1219">ε</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12005" data-verso-hover="1398">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12009" data-verso-hover="1219">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12005" data-verso-hover="1398">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12007" data-verso-hover="1219">ε</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12009" data-verso-hover="1219">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12015" data-verso-hover="1400">x</span></code><p>
                The <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code> instance for <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span></code> is also very similar to the instance for <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Opt.OptionT" data-verso-hover="1364">OptionT</span></code>.
The only difference is that it propagates a specific error value, rather than <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span></code>:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.instance-6482">instance</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.12039" data-verso-hover="1219">ε</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-6497" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.12043" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-6510" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-6521" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12043" data-verso-hover="1246">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12039" data-verso-hover="1219">ε</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12043" data-verso-hover="1246">m</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.whereStructInst-6566">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="1375">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12124" data-verso-hover="584">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.ExceptT.mk" data-verso-hover="1396">ExceptT.mk</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Except.ok" data-verso-hover="747">Except.ok</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12124" data-verso-hover="584">x</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Bind.bind" data-verso-hover="1401">bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12272" data-verso-hover="1402">result</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12275" data-verso-hover="1403">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.ExceptT.mk" data-verso-hover="1396">ExceptT.mk</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-6649">do</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-6656">match</span><span class="inter-text"> </span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12272" data-verso-hover="1402">result</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-6656">with</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Except.error" data-verso-hover="746">.error</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12357" data-verso-hover="766">e</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Except.error" data-verso-hover="746">.error</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12357" data-verso-hover="766">e</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Except.ok" data-verso-hover="747">.ok</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12399" data-verso-hover="584">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12275" data-verso-hover="1403">next</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12399" data-verso-hover="584">x</span></code><p>
                The type signatures of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.ExceptT.mk" data-verso-hover="1396">ExceptT.mk</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.ExceptT.run" data-verso-hover="1399">ExceptT.run</span></code> contain a subtle detail: they annotate the universe levels of <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.11962" data-verso-hover="1219">α</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.11960" data-verso-hover="1219">ε</span></code> explicitly.
If they are not explicitly annotated, then Lean generates a more general type signature in which they have distinct polymorphic universe variables.
However, the definition of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span></code> expects them to be in the same universe, because they can both be provided as arguments to <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.11958" data-verso-hover="1398">m</span></code>.
This can lead to a problem in the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code> instance where the universe level solver fails to find a working solution:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-5227">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Huh.ExceptT.mk" data-verso-hover="1404">ExceptT.mk</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.11381" data-verso-hover="1397">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11359" data-verso-hover="1405">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11368" data-verso-hover="1406">ε</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11378" data-verso-hover="1406">α</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11368" data-verso-hover="1406">ε</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11359" data-verso-hover="1405">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11378" data-verso-hover="1406">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11381" data-verso-hover="1397">x</span></code><code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.instance-5939">instance</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.11414" data-verso-hover="1219">ε</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-5954" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.11418" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-5967" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-5978" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11418" data-verso-hover="1246">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11414" data-verso-hover="1219">ε</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11418" data-verso-hover="1246">m</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="has-info error"><span class="hover-container"><span class="hover-info messages"><code class="message error">stuck at solving universe constraint
  max ?u.11669 ?u.11670 =?= u
while trying to unify
  ExceptT ε m β✝ : Type v
with
  ExceptT.{max ?u.11670 ?u.11669, v} ε m β✝ : Type v</code><code class="message error">stuck at solving universe constraint
  max ?u.11498 ?u.11499 =?= u
while trying to unify
  ExceptT ε m α✝ : Type v
with
  ExceptT.{max ?u.11499 ?u.11498, v} ε m α✝ : Type v</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.whereStructInst-6023">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="1375">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11496" data-verso-hover="584">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Huh.ExceptT.mk" data-verso-hover="1404">ExceptT.mk</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Except.ok" data-verso-hover="747">Except.ok</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11496" data-verso-hover="584">x</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Bind.bind" data-verso-hover="1401">bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11662" data-verso-hover="1402">result</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11665" data-verso-hover="1403">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Huh.ExceptT.mk" data-verso-hover="1404">ExceptT.mk</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-6106">do</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-6113">match</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.11662" data-verso-hover="1402">result</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-6113">with</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="has-info error"><span class="hover-container"><span class="hover-info messages"><code class="message error">stuck at solving universe constraint
  max ?u.11498 ?u.11499 =?= u
while trying to unify
  ExceptT ε m α✝ : Type v
with
  ExceptT.{max ?u.11499 ?u.11498, v} ε m α✝ : Type v</code></span></span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Except.error" data-verso-hover="746">.error</span><span class="inter-text"> </span><span class="unknown token" data-binding="">e</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="unknown token" data-binding="">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">.error</span><span class="inter-text"> </span><span class="unknown token" data-binding="">e</span><span class="unknown token" data-binding="">)</span></span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="unknown token" data-binding="">.ok</span><span class="inter-text"> </span><span class="unknown token" data-binding="">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="unknown token" data-binding="">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">x</span></span></code><div class="error">
                <pre>stuck at solving universe constraint
  max ?u.11669 ?u.11670 =?= u
while trying to unify
  ExceptT ε m β✝ : Type v
with
  ExceptT.{max ?u.11670 ?u.11669, v} ε m β✝ : Type v</pre></div>
              <p>
                This kind of error message is typically caused by underconstrained universe variables.
Diagnosing it can be tricky, but a good first step is to look for reused universe variables in some definitions that are not reused in others.</p>
              <p>
                Unlike <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span></code>, the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span></code> datatype is typically not used as a data structure.
It is always used as a control structure with its <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code> instance.
This means that it is reasonable to lift <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12554" data-verso-hover="369">ε</span></code> actions into <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12554" data-verso-hover="369">ε</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12538" data-verso-hover="1125">m</span></code>, as well as actions from the underlying monad <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.12538" data-verso-hover="1125">m</span></code>.
Lifting <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span></code> actions into <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span></code> actions is done by wrapping them in <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.12538" data-verso-hover="1125">m</span></code>'s <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span></code>, because an action that only has exception effects cannot have any effects from the monad <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.12538" data-verso-hover="1125">m</span></code>:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.instance-6793">instance</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12538" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-MonadLift" data-verso-hover="1348">MonadLift</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12554" data-verso-hover="369">ε</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12554" data-verso-hover="369">ε</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12538" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.whereStructInst-6851">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-MonadLift.monadLift" data-verso-hover="1407">monadLift</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12600" data-verso-hover="820">action</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.ExceptT.mk" data-verso-hover="1396">ExceptT.mk</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12600" data-verso-hover="820">action</span><span class="unknown token" data-binding="">)</span></code><p>
                Because actions from <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.12538" data-verso-hover="1125">m</span></code> do not have any exceptions in them, their value should be wrapped in <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Except.ok" data-verso-hover="747">Except.ok</span></code>.
This can be accomplished using the fact that <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Functor" data-verso-hover="570">Functor</span></code> is a superclass of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span></code>, so applying a function to the result of any monadic computation can be accomplished using <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Functor.map" data-verso-hover="567">Functor.map</span></code>:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.instance-6963">instance</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12703" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-MonadLift" data-verso-hover="1348">MonadLift</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12703" data-verso-hover="1125">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12722" data-verso-hover="369">ε</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12703" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.whereStructInst-7011">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-MonadLift.monadLift" data-verso-hover="1408">monadLift</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12764" data-verso-hover="1269">action</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.ExceptT.mk" data-verso-hover="1396">ExceptT.mk</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Except.ok" data-verso-hover="747">.ok</span><span class="inter-text"> </span><span class="unknown token" data-binding="">&lt;$&gt;</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12764" data-verso-hover="1269">action</span><span class="unknown token" data-binding="">)</span></code><section>
                <h3 id="Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Exceptions--Type-Classes-for-Exceptions">
                  6.2.2.1. Type Classes for Exceptions</h3>
                <p>
                  Exception handling fundamentally consists of two operations: the ability to throw exceptions, and the ability to recover from them.
Thus far, this has been accomplished using the constructors of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span></code> and pattern matching, respectively.
However, this ties a program that uses exceptions to one specific encoding of the exception handling effect.
Using a type class to capture these operations allows a program that uses exceptions to be used in <em>any</em> monad that supports throwing and catching.</p>
                <p>
                  Throwing an exception should take an exception as an argument, and it should be allowed in any context where a monadic action is requested.
The “any context” part of the specification can be written as a type by writing <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.12882" data-verso-hover="1409">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12891" data-verso-hover="1235">α</span></code>—because there's no way to produce a value of any arbitrary type, the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.MyMonadExcept.MonadExcept.throw" data-verso-hover="1410">throw</span></code> operation must be doing something that causes control to leave that part of the program.
Catching an exception should accept any monadic action together with a handler, and the handler should explain how to get back to the action's type from an exception:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.classTk-7143">class</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.MyMonadExcept.MonadExcept" data-verso-hover="1411">MonadExcept</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.12878" data-verso-hover="1338">ε</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-outParam" data-verso-hover="448">outParam</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-7177" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.12882" data-verso-hover="1409">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-7191" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-7202" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">w</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-7210">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Ex.MyMonadExcept.MonadExcept.throw" data-verso-hover="1410">throw</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12878" data-verso-hover="1338">ε</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12882" data-verso-hover="1409">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12891" data-verso-hover="1235">α</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Ex.MyMonadExcept.MonadExcept.tryCatch" data-verso-hover="1412">tryCatch</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12882" data-verso-hover="1409">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12900" data-verso-hover="1235">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.12878" data-verso-hover="1338">ε</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12882" data-verso-hover="1409">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12900" data-verso-hover="1235">α</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12882" data-verso-hover="1409">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.12900" data-verso-hover="1235">α</span></code><p>
                  The universe levels on <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.MyMonadExcept.MonadExcept" data-verso-hover="1411">MonadExcept</span></code> differ from those of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span></code>.
In <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span></code>, both <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.11335" data-verso-hover="1219">ε</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.11341" data-verso-hover="1219">α</span></code> have the same level, while <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.MyMonadExcept.MonadExcept" data-verso-hover="1411">MonadExcept</span></code> imposes no such limitation.
This is because <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.MyMonadExcept.MonadExcept" data-verso-hover="1411">MonadExcept</span></code> never places an exception value inside of <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.12882" data-verso-hover="1409">m</span></code>.
The most general universe signature recognizes the fact that <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.12878" data-verso-hover="1338">ε</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="var token" data-binding="var-_uniq.12891" data-verso-hover="1235">α</span></code> are completely independent in this definition.
Being more general means that the type class can be instantiated for a wider variety of types.</p>
                <p>
                  An example program that uses <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.MyMonadExcept.MonadExcept" data-verso-hover="1411">MonadExcept</span></code> is a simple division service.
The program is divided into two parts: a frontend that supplies a user interface based on strings that handles errors, and a backend that actually does the division.
Both the frontend and the backend can throw exceptions, the former for ill-formed input and the latter for division by zero errors.
The exceptions are an inductive type:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.inductive-7347" data-verso-hover="96">inductive</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Err" data-verso-hover="1413">Err</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-7361">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Err.divByZero" data-verso-hover="1414">divByZero</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Err.notANumber" data-verso-hover="1415">notANumber</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Err" data-verso-hover="1413">Err</span></code><p>
                  The backend checks for zero, and divides if it can:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-7458">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.divBackend" data-verso-hover="1416">divBackend</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13176" data-verso-hover="868">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-MonadExcept" data-verso-hover="1417">MonadExcept</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Err" data-verso-hover="1413">Err</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13176" data-verso-hover="868">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.13191" data-verso-hover="27">n</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13193" data-verso-hover="27">k</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13176" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-7528" data-verso-hover="16">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13193" data-verso-hover="27">k</span><span class="inter-text"> </span><span class="unknown token" data-binding="">==</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="27">0</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-7528" data-verso-hover="16">then</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-MonadExcept.throw" data-verso-hover="1418">throw</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Err.divByZero" data-verso-hover="1414">.divByZero</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-termIfThenElse-7528" data-verso-hover="16">else</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.13191" data-verso-hover="27">n</span><span class="inter-text"> </span><span class="unknown token" data-binding="">/</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13193" data-verso-hover="27">k</span><span class="unknown token" data-binding="">)</span></code><p>
                  The frontend's helper <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.asNumber" data-verso-hover="1419">asNumber</span></code> throws an exception if the string it is passed is not a number.
The overall frontend converts its inputs to <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span></code>s and calls the backend, handling exceptions by returning a friendly string error:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-7632">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.asNumber" data-verso-hover="1419">asNumber</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13483" data-verso-hover="868">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-MonadExcept" data-verso-hover="1417">MonadExcept</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Err" data-verso-hover="1413">Err</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13483" data-verso-hover="868">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.13498" data-verso-hover="39">s</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13483" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-Int" data-verso-hover="28">Int</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.match-7701" data-verso-hover="100">match</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13498" data-verso-hover="39">s</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-String.toInt?" data-verso-hover="1420">toInt?</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.match-7701" data-verso-hover="100">with</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.none" data-verso-hover="374">none</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-MonadExcept.throw" data-verso-hover="1418">throw</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Ex.Err.notANumber" data-verso-hover="1415">.notANumber</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13498" data-verso-hover="39">s</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option.some" data-verso-hover="373">some</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13569" data-verso-hover="27">i</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13569" data-verso-hover="27">i</span></code><code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-7842">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Verbose.divFrontend" data-verso-hover="1421">divFrontend</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13697" data-verso-hover="868">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-MonadExcept" data-verso-hover="1417">MonadExcept</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Err" data-verso-hover="1413">Err</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13697" data-verso-hover="868">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.13712" data-verso-hover="39">n</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13714" data-verso-hover="39">k</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13697" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-MonadExcept.tryCatch" data-verso-hover="1422">tryCatch</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-7929">do</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-ToString.toString" data-verso-hover="407">toString</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.divBackend" data-verso-hover="1416">divBackend</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.asNumber" data-verso-hover="1419">asNumber</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13712" data-verso-hover="39">n</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.asNumber" data-verso-hover="1419">asNumber</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.13714" data-verso-hover="39">k</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-8004">fun</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Err.divByZero" data-verso-hover="1414">.divByZero</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="literal string token" data-binding="" data-verso-hover="1423">"Division by zero!"</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Err.notANumber" data-verso-hover="1415">.notANumber</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.14196" data-verso-hover="39">s</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termS!_-8085">s!</span><span class="unknown token" data-binding="">"Not a number: \"{</span><span class="var token" data-binding="var-_uniq.14196" data-verso-hover="39">s</span><span class="unknown token" data-binding="">}\""</span></code><p>
                  Throwing and catching exceptions is common enough that Lean provides a special syntax for using <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadExcept" data-verso-hover="1417">MonadExcept</span></code>.
Just as <code>+</code> is short for <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-HAdd.hAdd" data-verso-hover="341">HAdd.hAdd</span></code>, <code class="hl lean inline" data-lean-context="examples"><span class="keyword token" data-binding="">try</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="keyword token" data-binding="">catch</span></code> can be used as shorthand for the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.MyMonadExcept.MonadExcept.tryCatch" data-verso-hover="1412">tryCatch</span></code> method:</p>
                <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-8180">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.divFrontend" data-verso-hover="1424">divFrontend</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.14375" data-verso-hover="868">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-MonadExcept" data-verso-hover="1417">MonadExcept</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Err" data-verso-hover="1413">Err</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.14375" data-verso-hover="868">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.14390" data-verso-hover="39">n</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.14392" data-verso-hover="39">k</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.14375" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.termTry-8257">try</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-ToString.toString" data-verso-hover="407">toString</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.divBackend" data-verso-hover="1416">divBackend</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.asNumber" data-verso-hover="1419">asNumber</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.14390" data-verso-hover="39">n</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.asNumber" data-verso-hover="1419">asNumber</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.14392" data-verso-hover="39">k</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doCatchMatch-8334">catch</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Err.divByZero" data-verso-hover="1414">.divByZero</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="literal string token" data-binding="" data-verso-hover="1423">"Division by zero!"</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-Ex.Err.notANumber" data-verso-hover="1415">.notANumber</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.14874" data-verso-hover="39">s</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-termS!_-8413">s!</span><span class="unknown token" data-binding="">"Not a number: \"{</span><span class="var token" data-binding="var-_uniq.14874" data-verso-hover="39">s</span><span class="unknown token" data-binding="">}\""</span></code><p>
                  In addition to <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span></code>, there are useful <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.MyMonadExcept.MonadExcept" data-verso-hover="1411">MonadExcept</span></code> instances for other types that may not seem like exceptions at first glance.
For example, failure due to <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span></code> can be seen as throwing an exception that contains no data whatsoever, so there is an instance of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadExcept" data-verso-hover="1417">MonadExcept</span><span class="inter-text"> </span><span class="const token" data-binding="const-Unit" data-verso-hover="184">Unit</span><span class="inter-text"> </span><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span></code> that allows <code class="hl lean inline" data-lean-context="examples"><span class="keyword token" data-binding="">try</span></code><code> ...</code><code class="hl lean inline" data-lean-context="examples"><span class="keyword token" data-binding="">catch</span></code><code> ...</code> syntax to be used with <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Option" data-verso-hover="142">Option</span></code>.</p>
                </section>
              </section>
            <section>
              <h2 id="Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--State">
                6.2.3. State</h2>
              <p>
                A simulation of mutable state is added to a monad by having monadic actions accept a starting state as an argument and return a final state together with their result.
The bind operator for a state monad provides the final state of one action as an argument to the next action, threading the state through the program.
This pattern can also be expressed as a monad transformer:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-8680">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-St.StateT" data-verso-hover="1425">StateT</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.15225" data-verso-hover="1219">σ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-8697" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.15229" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-8714" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-8725" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.15231" data-verso-hover="1219">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-8739" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-8749" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Level.max-8755">max</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="var token" data-binding="var-_uniq.15225" data-verso-hover="1219">σ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15229" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.15231" data-verso-hover="1219">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">×</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15225" data-verso-hover="1219">σ</span><span class="unknown token" data-binding="">)</span></code><p>
                Once again, the monad instance is very similar to that for <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monads.State.State" data-verso-hover="838">State</span></code>.
The only difference is that the input and output states are passed around and returned in the underlying monad, rather than with pure code:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.instance-8839">instance</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15252" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Monad" data-verso-hover="724">Monad</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-St.StateT" data-verso-hover="1425">StateT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15267" data-verso-hover="369">σ</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15252" data-verso-hover="1125">m</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.whereStructInst-8880">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="1426">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15343" data-verso-hover="584">x</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-8898">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15346" data-verso-hover="804">s</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.15343" data-verso-hover="584">x</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15346" data-verso-hover="804">s</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-Bind.bind" data-verso-hover="1361">bind</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15500" data-verso-hover="1427">result</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15503" data-verso-hover="1428">next</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-8941">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15508" data-verso-hover="804">s</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-8950">do</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doLetArrow-8957">let</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.15600" data-verso-hover="584">v</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15601" data-verso-hover="804">s'</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15500" data-verso-hover="1427">result</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15508" data-verso-hover="804">s</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="var token" data-binding="var-_uniq.15503" data-verso-hover="1428">next</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15600" data-verso-hover="584">v</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.15601" data-verso-hover="804">s'</span></code><p>
                The corresponding type class has <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StEx.Cls.MonadState.get" data-verso-hover="1429">get</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StEx.Cls.MonadState.set" data-verso-hover="1430">set</span></code> methods.
One downside of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StEx.Cls.MonadState.get" data-verso-hover="1429">get</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StEx.Cls.MonadState.set" data-verso-hover="1430">set</span></code> is that it becomes too easy to <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StEx.Cls.MonadState.set" data-verso-hover="1430">set</span></code> the wrong state when updating it.
This is because retrieving the state, updating it, and saving the updated state is a natural way to write some programs.
For example, the following program counts the number of diacritic-free English vowels and consonants in a string of letters:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.structureTk-9235">structure</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.LetterCounts" data-verso-hover="1431">LetterCounts</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-9258">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-StEx.LetterCounts.vowels" data-verso-hover="1432">vowels</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Nat" data-verso-hover="6">Nat</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-StEx.LetterCounts.consonants" data-verso-hover="1433">consonants</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Nat" data-verso-hover="6">Nat</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-null-9298">deriving</span><span class="inter-text"> </span><span class="const token" data-binding="const-Repr" data-verso-hover="64">Repr</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.inductive-9313" data-verso-hover="96">inductive</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.Err" data-verso-hover="1434">Err</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-9327">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.Err.notALetter" data-verso-hover="1435">notALetter</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-Char" data-verso-hover="1209">Char</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.Err" data-verso-hover="1434">Err</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-null-9363">deriving</span><span class="inter-text"> </span><span class="const token" data-binding="const-Repr" data-verso-hover="64">Repr</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-9378">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.vowels" data-verso-hover="1436">vowels</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.let-9394" data-verso-hover="212">let</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.17995" data-verso-hover="39">lowerVowels</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="literal string token" data-binding="" data-verso-hover="1437">"aeiuoy"</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="var token" data-binding="var-_uniq.17995" data-verso-hover="39">lowerVowels</span><span class="inter-text"> </span><span class="unknown token" data-binding="">++</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.17995" data-verso-hover="39">lowerVowels</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-String.map" data-verso-hover="1438">map</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">·</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Char.toUpper" data-verso-hover="1439">toUpper</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-9469">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.consonants" data-verso-hover="1440">consonants</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.let-9489" data-verso-hover="212">let</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18048" data-verso-hover="39">lowerConsonants</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="literal string token" data-binding="" data-verso-hover="1441">"bcdfghjklmnpqrstvwxz"</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="var token" data-binding="var-_uniq.18048" data-verso-hover="39">lowerConsonants</span><span class="inter-text"> </span><span class="unknown token" data-binding="">++</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18048" data-verso-hover="39">lowerConsonants</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-String.map" data-verso-hover="1438">map</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">·</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Char.toUpper" data-verso-hover="1439">toUpper</span><span class="inter-text"> </span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">
</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-9591">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.countLetters" data-verso-hover="1442">countLetters</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.18097" data-verso-hover="39">str</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-StateT" data-verso-hover="1443">StateT</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.LetterCounts" data-verso-hover="1431">LetterCounts</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.Err" data-verso-hover="1434">Err</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="const token" data-binding="const-Unit" data-verso-hover="184">Unit</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-group-9668">let</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-group-9668">rec</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.countLetters.loop" data-verso-hover="1444">loop</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.18113" data-verso-hover="1445">chars</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-List" data-verso-hover="111">List</span><span class="inter-text"> </span><span class="const token" data-binding="const-Char" data-verso-hover="1209">Char</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-9704">do</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-9711">match</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18113" data-verso-hover="1445">chars</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-9711">with</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18263" data-verso-hover="262">c</span><span class="inter-text"> </span><span class="unknown token" data-binding="">::</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18264" data-verso-hover="1445">cs</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doLetArrow-9771">let</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18392" data-verso-hover="1446">st</span><span class="inter-text"> </span><span class="unknown token" data-binding="">←</span><span class="inter-text"> </span><span class="const token" data-binding="const-MonadState.get" data-verso-hover="1447">get</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doLetArrow-9792">let</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18395" data-verso-hover="1446">st'</span><span class="inter-text"> </span><span class="unknown token" data-binding="">←</span><span class="inter-text">
</span><span class="inter-text">        </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doIf-9812">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18263" data-verso-hover="262">c</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Char.isAlpha" data-verso-hover="974">isAlpha</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doIf-9812">then</span><span class="inter-text">
</span><span class="inter-text">          </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doIf-9840">if</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.vowels" data-verso-hover="1436">vowels</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-String.contains" data-verso-hover="674">contains</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18263" data-verso-hover="262">c</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doIf-9840">then</span><span class="inter-text">
</span><span class="inter-text">            </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.18392" data-verso-hover="1446">st</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-9884">with</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.LetterCounts.vowels" data-verso-hover="117">vowels</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18392" data-verso-hover="1446">st</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-StEx.LetterCounts.vowels" data-verso-hover="1432">vowels</span><span class="inter-text"> </span><span class="unknown token" data-binding="">+</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">1</span><span class="unknown token" data-binding="">}</span><span class="inter-text">
</span><span class="inter-text">          </span><span class="keyword token" data-binding="kw-occ-group-9927">else</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-group-9927">if</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.consonants" data-verso-hover="1440">consonants</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-String.contains" data-verso-hover="674">contains</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18263" data-verso-hover="262">c</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-group-9927">then</span><span class="inter-text">
</span><span class="inter-text">            </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.18392" data-verso-hover="1446">st</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-9980">with</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.LetterCounts.consonants" data-verso-hover="117">consonants</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18392" data-verso-hover="1446">st</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-StEx.LetterCounts.consonants" data-verso-hover="1433">consonants</span><span class="inter-text"> </span><span class="unknown token" data-binding="">+</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">1</span><span class="unknown token" data-binding="">}</span><span class="inter-text">
</span><span class="inter-text">          </span><span class="keyword token" data-binding="kw-occ-null-10031">else</span><span class="inter-text"> -- modified or non-English letter</span><span class="inter-text">
</span><span class="inter-text">            </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18392" data-verso-hover="1446">st</span><span class="inter-text">
</span><span class="inter-text">        </span><span class="keyword token" data-binding="kw-occ-null-10098">else</span><span class="inter-text"> </span><span class="const token" data-binding="const-MonadExcept.throw" data-verso-hover="1418">throw</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-StEx.Err.notALetter" data-verso-hover="1435">.notALetter</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18263" data-verso-hover="262">c</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="const token" data-binding="const-MonadStateOf.set" data-verso-hover="1448">set</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18395" data-verso-hover="1446">st'</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="const token" data-binding="const-StEx.countLetters.loop" data-verso-hover="1444">loop</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18264" data-verso-hover="1445">cs</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-StEx.countLetters.loop" data-verso-hover="1444">loop</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18097" data-verso-hover="39">str</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-String.toList" data-verso-hover="1449">toList</span></code><p>
                It would be very easy to write <code>set st</code> instead of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadStateOf.set" data-verso-hover="1448">set</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.18395" data-verso-hover="1446">st'</span></code>.
In a large program, this kind of mistake can lead to difficult-to-diagnose bugs.</p>
              <p>
                While using a nested action for the call to <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadState.get" data-verso-hover="1447">get</span></code> would solve this problem, it can't solve all such problems.
For example, a function might update a field on a structure based on the values of two other fields.
This would require two separate nested-action calls to <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadState.get" data-verso-hover="1447">get</span></code>.
Because the Lean compiler contains optimizations that are only effective when there is a single reference to a value, duplicating the references to the state might lead to code that is significantly slower.
Both the potential performance problem and the potential bug can be worked around by using <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-modify" data-verso-hover="1450">modify</span></code>, which transforms the state using a function:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-10248">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.Modify.countLetters" data-verso-hover="1451">countLetters</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.19478" data-verso-hover="39">str</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-String" data-verso-hover="35">String</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-StateT" data-verso-hover="1443">StateT</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.LetterCounts" data-verso-hover="1431">LetterCounts</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Except" data-verso-hover="745">Except</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.Err" data-verso-hover="1434">Err</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="const token" data-binding="const-Unit" data-verso-hover="184">Unit</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="keyword token" data-binding="kw-occ-group-10325">let</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-group-10325">rec</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.Modify.countLetters.loop" data-verso-hover="1452">loop</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.19494" data-verso-hover="1445">chars</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-List" data-verso-hover="111">List</span><span class="inter-text"> </span><span class="const token" data-binding="const-Char" data-verso-hover="1209">Char</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-10361">do</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-10368">match</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.19494" data-verso-hover="1445">chars</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doMatch-10368">with</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="unknown token" data-binding="">|</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.19644" data-verso-hover="262">c</span><span class="inter-text"> </span><span class="unknown token" data-binding="">::</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.19645" data-verso-hover="1445">cs</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doIf-10428">if</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.19644" data-verso-hover="262">c</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Char.isAlpha" data-verso-hover="974">isAlpha</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doIf-10428">then</span><span class="inter-text">
</span><span class="inter-text">        </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doIf-10454">if</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.vowels" data-verso-hover="1436">vowels</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-String.contains" data-verso-hover="674">contains</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.19644" data-verso-hover="262">c</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doIf-10454">then</span><span class="inter-text">
</span><span class="inter-text">          </span><span class="const token" data-binding="const-modify" data-verso-hover="1450">modify</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-10497">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.19896" data-verso-hover="1446">st</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.19896" data-verso-hover="1446">st</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-10508">with</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.LetterCounts.vowels" data-verso-hover="117">vowels</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.19896" data-verso-hover="1446">st</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-StEx.LetterCounts.vowels" data-verso-hover="1432">vowels</span><span class="inter-text"> </span><span class="unknown token" data-binding="">+</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">1</span><span class="unknown token" data-binding="">}</span><span class="inter-text">
</span><span class="inter-text">        </span><span class="keyword token" data-binding="kw-occ-group-10549">else</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-group-10549">if</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.consonants" data-verso-hover="1440">consonants</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-String.contains" data-verso-hover="674">contains</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.19644" data-verso-hover="262">c</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-group-10549">then</span><span class="inter-text">
</span><span class="inter-text">          </span><span class="const token" data-binding="const-modify" data-verso-hover="1450">modify</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-10601">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.20104" data-verso-hover="1446">st</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.20104" data-verso-hover="1446">st</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-10612">with</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.LetterCounts.consonants" data-verso-hover="117">consonants</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.20104" data-verso-hover="1446">st</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-StEx.LetterCounts.consonants" data-verso-hover="1433">consonants</span><span class="inter-text"> </span><span class="unknown token" data-binding="">+</span><span class="inter-text"> </span><span class="typed token" data-binding="" data-verso-hover="5">1</span><span class="unknown token" data-binding="">}</span><span class="inter-text">
</span><span class="inter-text">        </span><span class="keyword token" data-binding="kw-occ-null-10661">else</span><span class="inter-text"> -- modified or non-English letter</span><span class="inter-text">
</span><span class="inter-text">          </span><span class="const token" data-binding="const-Pure.pure" data-verso-hover="270">pure</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="keyword token" data-binding="kw-occ-null-10724">else</span><span class="inter-text"> </span><span class="const token" data-binding="const-MonadExcept.throw" data-verso-hover="1418">throw</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-StEx.Err.notALetter" data-verso-hover="1435">.notALetter</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.19644" data-verso-hover="262">c</span><span class="unknown token" data-binding="">)</span><span class="inter-text">
</span><span class="inter-text">      </span><span class="const token" data-binding="const-StEx.Modify.countLetters.loop" data-verso-hover="1452">loop</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.19645" data-verso-hover="1445">cs</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-StEx.Modify.countLetters.loop" data-verso-hover="1452">loop</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.19478" data-verso-hover="39">str</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-String.toList" data-verso-hover="1449">toList</span></code><p>
                The type class contains a function akin to <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StEx.Modify.modify" data-verso-hover="1453">modify</span></code> called <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadState.modifyGet" data-verso-hover="1454">modifyGet</span></code>, which allows the function to both compute a return value and transform an old state in a single step.
The function returns a pair in which the first element is the return value, and the second element is the new state; <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StEx.Modify.modify" data-verso-hover="1453">modify</span></code> just adds the constructor of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Unit" data-verso-hover="184">Unit</span></code> to the pair used in <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadState.modifyGet" data-verso-hover="1454">modifyGet</span></code>:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-10836">def</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.Modify.modify" data-verso-hover="1453">modify</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-MonadState" data-verso-hover="1455">MonadState</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.20719" data-verso-hover="113">σ</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.20725" data-verso-hover="868">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.20734" data-verso-hover="1456">f</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.20719" data-verso-hover="113">σ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.20719" data-verso-hover="113">σ</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.20725" data-verso-hover="868">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-Unit" data-verso-hover="184">Unit</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:=</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-MonadState.modifyGet" data-verso-hover="1454">modifyGet</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-10905">fun</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.20763" data-verso-hover="804">s</span><span class="inter-text"> </span><span class="unknown token" data-binding="">=&gt;</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">,</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.20734" data-verso-hover="1456">f</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.20763" data-verso-hover="804">s</span><span class="unknown token" data-binding="">)</span></code><p>
                The definition of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StEx.Cls.MonadState" data-verso-hover="1457">MonadState</span></code> is as follows:</p>
              <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.classTk-14779">class</span><span class="inter-text"> </span><span class="const token" data-binding="const-StEx.Cls.MonadState" data-verso-hover="1457">MonadState</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.44580" data-verso-hover="1338">σ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="const token" data-binding="const-outParam" data-verso-hover="448">outParam</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-14812" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.44584" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-14826" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-14837" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text">
</span><span class="inter-text">    </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-14851" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Level.max-14857">max</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">u</span><span class="unknown token" data-binding="">+</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-null-14870">where</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-StEx.Cls.MonadState.get" data-verso-hover="1429">get</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44584" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44580" data-verso-hover="1338">σ</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-StEx.Cls.MonadState.set" data-verso-hover="1430">set</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44580" data-verso-hover="1338">σ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44584" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-PUnit" data-verso-hover="1458">PUnit</span><span class="inter-text">
</span><span class="inter-text">  </span><span class="const token" data-binding="const-StEx.Cls.MonadState.modifyGet" data-verso-hover="1459">modifyGet</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.44580" data-verso-hover="1338">σ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44602" data-verso-hover="1219">α</span><span class="inter-text"> </span><span class="unknown token" data-binding="">×</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44580" data-verso-hover="1338">σ</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44584" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44602" data-verso-hover="1219">α</span></code><p>
                <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-PUnit" data-verso-hover="1458">PUnit</span></code> is a version of the <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Unit" data-verso-hover="184">Unit</span></code> type that is universe-polymorphic to allow it to be in <code class="hl lean inline" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-14812" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span></code> instead of <code class="hl lean inline" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-14812" data-verso-hover="50">Type</span></code>.
While it would be possible to provide a default implementation of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StEx.Cls.MonadState.modifyGet" data-verso-hover="1459">modifyGet</span></code> in terms of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StEx.Cls.MonadState.get" data-verso-hover="1429">get</span></code> and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StEx.Cls.MonadState.set" data-verso-hover="1430">set</span></code>, it would not admit the optimizations that make <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StEx.Cls.MonadState.modifyGet" data-verso-hover="1459">modifyGet</span></code> useful in the first place, rendering the method useless.</p>
              </section>
            <section>
              <h2 id="Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Of--Classes-and--The--Functions">
                6.2.4. <code>Of</code> Classes and <code>The</code> Functions</h2>
              <p>
                Thus far, each monad type class that takes extra information, like the type of exceptions for <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.MyMonadExcept.MonadExcept" data-verso-hover="1411">MonadExcept</span></code> or the type of the state for <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StEx.Cls.MonadState" data-verso-hover="1457">MonadState</span></code>, has this type of extra information as an output parameter.
For simple programs, this is generally convenient, because a monad that combines one use each of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-St.StateT" data-verso-hover="1425">StateT</span></code>, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-ReaderT" data-verso-hover="1358">ReaderT</span></code>, and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Ex.ExceptT" data-verso-hover="1395">ExceptT</span></code> has only a single state type, environment type, and exception type.
As monads grow in complexity, however, they may involve multiple states or errors types.
In this case, the use of an output parameter makes it impossible to target both states in the same <code class="hl lean inline" data-lean-context="examples"><span class="keyword token" data-binding="">do</span></code>-block.</p>
              <p>
                For these cases, there are additional type classes in which the extra information is not an output parameter.
These versions of the type classes use the word <code>Of</code> in the name.
For example, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadStateOf" data-verso-hover="1460">MonadStateOf</span></code> is like <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StEx.Cls.MonadState" data-verso-hover="1457">MonadState</span></code>, but without an <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-outParam" data-verso-hover="448">outParam</span></code> modifier.</p>
              <p>
                Instead of an <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-outParam" data-verso-hover="448">outParam</span></code>, these classes use a <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-semiOutParam" data-verso-hover="1461">semiOutParam</span></code> for their respective state, environment, or exception types.
Like an <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-outParam" data-verso-hover="448">outParam</span></code>, a <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-semiOutParam" data-verso-hover="1461">semiOutParam</span></code> is not required be known before Lean begins the process of searching for an instance.
However, there is an important difference: <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-outParam" data-verso-hover="448">outParam</span></code>s are ignored during the search for an instance, and as a result they are truly outputs.
If an <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-outParam" data-verso-hover="448">outParam</span></code> is known prior to the search, then Lean merely checks that the result of the search is the same as what was known.
On the other hand, a <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-semiOutParam" data-verso-hover="1461">semiOutParam</span></code> that is known prior to the start of the search can be used to narrow down candidates, just like an input parameter.</p>
              <p>
                When a state monad's state type is an <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-outParam" data-verso-hover="448">outParam</span></code>, then each monad can have at most one type of state.
This is convenient, because it improves type inference: the state type can be inferred in more circumstances.
This is also inconvenient, because a monad built from multiple uses of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StateT" data-verso-hover="1443">StateT</span></code> cannot provide a useful <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadState" data-verso-hover="1455">MonadState</span></code> instance.
Using <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadStateOf" data-verso-hover="1460">MonadStateOf</span></code>, however, causes Lean to take the state type into account when it is available to select which instance to use, so one monad may provide multiple types of state.
The downside of this is that the resulting instance may not be the one that was intended when the state type has not been specified explicitly enough, which can lead to confusing error messages.</p>
              <p>
                Similarly, there are versions of the type class methods that accept the type of the extra information as an <em>explicit</em>, rather than implicit, argument.
For <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-MonadStateOf" data-verso-hover="1460">MonadStateOf</span></code>, there are <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-getThe" data-verso-hover="1462">getThe</span></code> with type</p>
              <code class="hl lean block" data-lean-context="examples"><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.44701" data-verso-hover="1219">σ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-15124" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.44706" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-15141" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-15152" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-MonadStateOf" data-verso-hover="1460">MonadStateOf</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44701" data-verso-hover="1219">σ</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44706" data-verso-hover="1246">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44706" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44701" data-verso-hover="1219">σ</span></code><p>
                and <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-modifyThe" data-verso-hover="1463">modifyThe</span></code> with type</p>
              <code class="hl lean block" data-lean-context="examples"><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.44739" data-verso-hover="1219">σ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-15271" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.44744" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="unknown token" data-binding="">:</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-15288" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">u</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.type-15299" data-verso-hover="50">Type</span><span class="inter-text"> </span><span class="unknown token" data-binding="">v</span><span class="unknown token" data-binding="">}</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-MonadStateOf" data-verso-hover="1460">MonadStateOf</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44739" data-verso-hover="1219">σ</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44744" data-verso-hover="1246">m</span><span class="unknown token" data-binding="">]</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.44739" data-verso-hover="1219">σ</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44739" data-verso-hover="1219">σ</span><span class="unknown token" data-binding="">)</span><span class="inter-text"> </span><span class="unknown token" data-binding="">→</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44744" data-verso-hover="1246">m</span><span class="inter-text"> </span><span class="const token" data-binding="const-PUnit" data-verso-hover="1458">PUnit</span></code><p>
                There is no <code>setThe</code> because the type of the new state is enough to decide which surrounding state monad transformer to use.</p>
              <p>
                In the Lean standard library, there are instances of the non-<code>Of</code> versions of the classes defined in terms of the instances of the versions with <code>Of</code>.
In other words, implementing the <code>Of</code> version yields implementations of both.
It's generally a good idea to implement the <code>Of</code> version, and then start writing programs using the non-<code>Of</code> versions of the class, transitioning to the <code>Of</code> version if the output parameter becomes inconvenient.</p>
              </section>
            <section>
              <h2 id="Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Transformers-and--Id">
                6.2.5. Transformers and <code>Id</code></h2>
              <p>
                The identity monad <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Id" data-verso-hover="863">Id</span></code> is the monad that has no effects whatsoever, to be used in contexts that expect a monad for some reason but where none is actually necessary.
Another use of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Id" data-verso-hover="863">Id</span></code> is to serve as the bottom of a stack of monad transformers.
For instance, <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-StateT" data-verso-hover="1443">StateT</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.44487" data-verso-hover="113">σ</span><span class="inter-text"> </span><span class="const token" data-binding="const-Id" data-verso-hover="863">Id</span></code> works just like <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monads.State.State" data-verso-hover="838">State</span><span class="inter-text"> </span><span class="var token" data-binding="var-_uniq.36150" data-verso-hover="113">σ</span></code>.</p>
              </section>
            <section>
              <h2 id="Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Exercises">
                6.2.6. Exercises</h2>
              <section>
                <h3 id="Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Exercises--Monad-Contract">
                  6.2.6.1. Monad Contract</h3>
                <p>
                  Using pencil and paper, check that the rules of the monad transformer contract are satisfied for each monad transformer in this section.</p>
                </section>
              <section>
                <h3 id="Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Exercises--Logging-Transformer">
                  6.2.6.2. Logging Transformer</h3>
                <p>
                  Define a monad transformer version of <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Monads.Writer.WithLog" data-verso-hover="846">WithLog</span></code>.
Also define the corresponding type class <code>MonadWithLog</code>, and write a program that combines logging and exceptions.</p>
                </section>
              <section>
                <h3 id="Functional-Programming-in-Lean--Monad-Transformers--A-Monad-Construction-Kit--Exercises--Counting-Files">
                  6.2.6.3. Counting Files</h3>
                <p>
                  Modify <code>doug</code>'s monad with <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-St.StateT" data-verso-hover="1425">StateT</span></code> such that it counts the number of directories and files seen.
At the end of execution, it should display a report like:</p>
                <pre>  Viewed 38 files in 5 directories.
</pre></section>
              </section>
            </section>
          <nav class="prev-next-buttons">
            <a class="local-button active" href="Monad-Transformers/Combining-IO-and-Reader/#Functional-Programming-in-Lean--Monad-Transformers--Combining-IO-and-Reader" rel="prev" title="6.1. Combining IO and Reader"><span class="arrow">←</span><span class="where">6.1. Combining IO and Reader</span></a><a class="local-button active" href="Monad-Transformers/Ordering-Monad-Transformers/#Functional-Programming-in-Lean--Monad-Transformers--Ordering-Monad-Transformers" rel="next" title="6.3. Ordering Monad Transformers"><span class="where">6.3. Ordering Monad Transformers</span><span class="arrow">→</span></a></nav>
          </div>
        </main></div>
    </body>
  </html>

